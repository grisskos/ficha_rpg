<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Ficha RPG</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root { --bg: #0f0f0f; --card: #141414; --primary: #e63946; --energy: #58E8DA; --text: #f1f1f1; --dim: #888; }
  body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; padding: 20px; margin: 0; }
  
  .main-layout { display: grid; grid-template-columns: 280px 1fr 300px; gap: 20px; max-width: 1600px; margin: 0 auto; padding-bottom: 80px; }
  @media (max-width: 1200px) { .main-layout { grid-template-columns: 280px 1fr; } }
  @media (max-width: 900px) { .main-layout { grid-template-columns: 1fr; } }

  .col-side, .col-center, .col-right { display: flex; flex-direction: column; gap: 20px; }
  .card { background: var(--card); padding: 20px; border-radius: 10px; border: 1px solid #2a2a2a; }

  /* HEADER */
  .char-img { width: 140px; height: 140px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); margin: 0 auto 10px auto; display: block; }
  .char-name { font-size: 1.5rem; margin: 0; color: white; text-align: center; }
  .badges { display: flex; justify-content: center; gap: 5px; flex-wrap: wrap; margin-top: 8px; }
  .badge { font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; background: #222; border: 1px solid #444; color: #ccc; }

  /* APTID√ïES (NOVO ESTILO) */
  .aptidao-box { margin-bottom: 15px; border: 1px solid #333; border-radius: 6px; overflow: hidden; }
  .aptidao-header { background: #222; padding: 10px; font-weight: bold; color: var(--energy); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
  .aptidao-header:hover { background: #2a2a2a; }
  .aptidao-body { display: none; padding: 10px; background: #111; }
  .aptidao-body.open { display: block; }
  
  .nivel-row { 
    display: flex; align-items: center; padding: 5px 0; border-bottom: 1px solid #222; font-size: 0.9rem; color: #666;
  }
  .nivel-row.unlocked { color: #fff; } /* Desbloqueado */
  .nivel-check { width: 20px; height: 20px; border: 1px solid #444; border-radius: 50%; margin-right: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
  .unlocked .nivel-check { background: var(--energy); border-color: var(--energy); box-shadow: 0 0 5px var(--energy); }
  
  /* Controles do Mestre */
  .gm-controls { display: none; margin-left: auto; gap: 5px; } /* Escondido por padr√£o */
  .gm-visible .gm-controls { display: flex; }
  .btn-gm { background: #333; border: 1px solid #555; color: #fff; width: 20px; height: 20px; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 3px; }
  .btn-gm:hover { border-color: var(--primary); color: var(--primary); }

  /* OUTROS ESTILOS MANTIDOS (Resumidos) */
  .attr-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .attr-box { background: #222; padding: 8px; border-radius: 6px; text-align: center; }
  .stat-row { margin-bottom: 12px; } .bar-bg { background: #333; height: 10px; border-radius: 5px; overflow: hidden; } .bar-fill { height: 100%; transition: width 0.3s; }
  .btn-nav { background: transparent; width: 100%; padding: 10px; font-size: 1rem; cursor: pointer; border-radius: 5px; font-weight: bold; border: 1px solid #444; color: #aaa; margin-bottom: 5px; }
  .btn-mini { width: 30px; height: 30px; cursor: pointer; background: #222; border: 1px solid #444; color: #ccc; border-radius: 4px; }
  .shiki-token { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--energy); cursor: pointer; }
  
  .c-vida { background: var(--primary); } .c-ener { background: var(--energy); } .c-vigo { background: var(--vigor); } .c-inte { background: var(--integridade); }
  .editable { cursor: pointer; border-bottom: 1px dashed #555; } .inline-input { background: #000; color: white; border: 2px solid var(--primary); width: 80px; text-align: center; }
  
  /* Combate Styles */
  .combat-grid { display: grid; gap: 10px; } .cols-3 { grid-template-columns: repeat(3, 1fr); }
  .combat-card { background: #1a1a1a; border: 1px solid var(--primary); border-radius: 6px; text-align: center; }
  .cc-header { background: var(--primary); color: white; padding: 5px; font-weight: bold; }
  .cc-body { font-size: 1.5rem; font-weight: bold; padding: 10px; }
  
  /* Skills */
  .skill-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #222; }
</style>
</head>
<body>

<div class="main-layout">
  
  <div class="col-side">
    <div class="card char-header">
      <img id="charImg" class="char-img" src="">
      <h2 class="char-name"><span class="editable" id="nomeDisplay" onclick="editarCampo(this, 'nome', 'text')">...</span></h2>
      <div id="badges" class="badges"></div>
      <div id="shikiTokens" style="display:flex; justify-content:center; gap:5px; margin-top:10px; flex-wrap:wrap;"></div>
    </div>

    <div class="card">
      <div id="atributosArea" class="attr-grid"></div>
    </div>

    <div class="card">
      <div id="statsArea"></div>
    </div>
    
    <button class="btn-nav" style="border-color:var(--integridade); color:var(--integridade);" onclick="location='shikigamis.html?charId='+id">üê∫ Invoca√ß√µes</button>
    <button class="btn-nav" style="border-color:var(--energy); color:var(--energy);" onclick="location='feiticos.html?id='+id">‚ö° T√©cnicas</button>
    <button class="btn-nav" onclick="location='index.html'">‚¨Ö Voltar</button>
  </div>

  <div class="col-center">
    <div class="card">
      <h3 style="margin:0 0 10px 0; color:var(--primary); border-bottom:1px solid #333;">Combate</h3>
      <div id="combatAttacksArea" class="combat-grid cols-3"></div>
    </div>

    <div class="card" id="aptidoesCard">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h3 style="margin:0; color:var(--energy);">Aptid√µes & Evolu√ß√£o</h3>
        <button id="btnCriarAptidao" class="btn-mini" style="display:none; width:auto; padding:0 10px;" onclick="addNovaAptidao()">+ Nova</button>
      </div>
      <div id="listaAptidoes"></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px 0;">Invent√°rio</h3>
      <ul id="ataquesList" style="padding-left:20px; color:#ccc;"></ul>
    </div>
  </div>

  <div class="col-right">
    <div class="card" style="height:100%;">
      <h3 style="margin-top:0; color:var(--primary);">Per√≠cias</h3>
      <div id="skillsList"></div>
    </div>
  </div>
</div>

<script type="module">
import { db, auth, doc, updateDoc, onSnapshot } from "./firebase.js";
import { APTIDOES_BASE } from "./aptidoes_db.js"; // Importa o banco de dados

const params = new URLSearchParams(location.search);
const id = params.get("id");
window.id = id; // Global para botoes
let ficha = {};
const MESTRE_EMAIL = "grisskos@fake.com";
let isMestre = false;

// Per√≠cias Defini√ß√£o
const PERICIAS_DEF = [
  { n: "Atletismo", a: "forca" }, { n: "Acrobacia", a: "destreza" }, { n: "Furtividade", a: "destreza" },
  { n: "Prestidigita√ß√£o", a: "destreza" }, { n: "Feiti√ßaria", a: "inteligencia" }, { n: "Hist√≥ria", a: "inteligencia" },
  { n: "Investiga√ß√£o", a: "inteligencia" }, { n: "Of√≠cio 1", a: "inteligencia" }, { n: "Tecnologia", a: "inteligencia" },
  { n: "Teologia", a: "inteligencia" }, { n: "Dire√ß√£o", a: "sabedoria" }, { n: "Intui√ß√£o", a: "sabedoria" },
  { n: "Medicina", a: "sabedoria" }, { n: "Ocultismo", a: "sabedoria" }, { n: "Percep√ß√£o", a: "sabedoria" },
  { n: "Sobreviv√™ncia", a: "sabedoria" }, { n: "Engana√ß√£o", a: "presenca" }, { n: "Intimida√ß√£o", a: "presenca" },
  { n: "Performance", a: "presenca" }, { n: "Persuas√£o", a: "presenca" }
];
const ATR_SHORT = { forca:"FOR", destreza:"DES", constituicao:"CON", inteligencia:"INT", sabedoria:"SAB", presenca:"PRE" };

// Check Mestre
auth.onAuthStateChanged(user => {
  if(user && user.email === MESTRE_EMAIL) {
    isMestre = true;
    document.getElementById('btnCriarAptidao').style.display = 'block';
    document.body.classList.add('gm-visible'); // CSS class para mostrar bot√µes
  }
});

onSnapshot(doc(db, "fichas", id), (docSnap) => {
  if (docSnap.exists()) {
    ficha = docSnap.data();
    // Safety
    if (!ficha.atributos) ficha.atributos = { forca:10, destreza:10, constituicao:10, inteligencia:10, sabedoria:10, presenca:10 };
    if (!ficha.progressoAptidoes) ficha.progressoAptidoes = {}; // Guarda quais niveis o player tem { "Prote√ß√£o": 2 }
    if (!ficha.aptidoesCustom) ficha.aptidoesCustom = []; // Aptid√µes extras criadas pelo mestre
    
    renderFicha();
  }
});

function renderFicha() {
  const f = ficha;
  
  // Render B√°sicos (Resumido)
  document.getElementById('nomeDisplay').innerText = f.nome || "Sem Nome";
  if(f.imagem) document.getElementById('charImg').src = f.imagem;
  
  // Badges
  document.getElementById('badges').innerHTML = `<span class="badge b-lvl">NVL ${f.nivel||1}</span><span class="badge b-cls">${f.classe||'Classe'}</span>`;

  // Tokens
  const shikiArea = document.getElementById('shikiTokens');
  shikiArea.innerHTML = "";
  (f.shikigamis || []).forEach(s => {
    shikiArea.innerHTML += `<img src="${s.imagem || 'https://via.placeholder.com/40'}" class="shiki-token" title="${s.nome}">`;
  });

  // Atributos
  const areaAttr = document.getElementById('atributosArea');
  areaAttr.innerHTML = "";
  Object.keys(ATR_SHORT).forEach(k => {
    const v = f.atributos[k] || 10;
    const m = Math.floor((v-10)/2);
    areaAttr.innerHTML += `<div class="attr-box"><span style="font-size:0.7rem;color:#888;">${ATR_SHORT[k]}</span><div style="font-size:1.2rem;font-weight:bold;">${m>=0?'+':''}${m}</div><div class="editable" onclick="editarCampo(this,'atributos.${k}','number')" style="font-size:0.8rem;color:#666;">${v}</div></div>`;
  });

  // Status Bars
  const statsArea = document.getElementById('statsArea');
  statsArea.innerHTML = "";
  ['vida','energia','vigor','integridade'].forEach(k => {
    const s = f[k] || {atual:0,max:0};
    const p = s.max>0 ? Math.min(100,(s.atual/s.max)*100) : 0;
    const colors = {vida:'var(--primary)',energia:'var(--energy)',vigor:'var(--vigor)',integridade:'var(--integridade)'};
    statsArea.innerHTML += `
      <div class="stat-row">
        <div style="display:flex;justify-content:space-between;font-size:0.8rem;margin-bottom:2px;">
          <span>${k.toUpperCase()}</span>
          <span><span class="editable" onclick="editarCampo(this,'${k}.atual','number')">${s.atual}</span>/<span class="editable" onclick="editarCampo(this,'${k}.max','number')">${s.max}</span></span>
        </div>
        <div class="bar-bg"><div class="bar-fill" style="width:${p}%;background:${colors[k]}"></div></div>
        <div class="stat-ctrl">
          <div class="btn-calc" onclick="mathStat('${k}')">üî¢</div>
          <div class="btn-mini" onclick="upStat('${k}',-1)">-</div><div class="btn-mini" onclick="upStat('${k}',1)">+</div>
        </div>
      </div>`;
  });

  // === RENDERIZA√á√ÉO DAS APTID√ïES ===
  renderAptidoes();

  // Invent√°rio (Simples)
  document.getElementById('ataquesList').innerHTML = (f.ataques||[]).map(i=>`<li>${i}</li>`).join('');

  // Per√≠cias
  const skillsList = document.getElementById('skillsList');
  skillsList.innerHTML = "";
  const metadeNivel = Math.floor((f.nivel||1)/2);
  const bonusTreino = 2 + Math.floor(((f.nivel||1)-1)/4);
  PERICIAS_DEF.forEach(p => {
    const mod = Math.floor(((f.atributos[p.a]||10)-10)/2);
    const saved = (f.pericias||{})[p.n] || {t:false,m:false};
    let tot = mod + metadeNivel;
    if(saved.t) tot += bonusTreino; if(saved.m) tot += 1;
    skillsList.innerHTML += `
      <div class="skill-row">
        <span style="flex-grow:1;">${p.n}</span>
        <span style="font-weight:bold;">${tot>=0?'+':''}${tot}</span>
      </div>`;
  });
}

function renderAptidoes() {
  const container = document.getElementById('listaAptidoes');
  container.innerHTML = "";

  // Junta as Aptid√µes Base + Customizadas da Ficha
  const todasAptidoes = [...APTIDOES_BASE, ...(ficha.aptidoesCustom || [])];

  todasAptidoes.forEach((apt, index) => {
    // N√≠vel atual desbloqueado pelo jogador
    const nivelAtual = (ficha.progressoAptidoes || {})[apt.nome] || 0;
    
    // Se n√£o for mestre e o jogador tiver n√≠vel 0, nem mostra a aptid√£o (Segredo)
    if (!isMestre && nivelAtual === 0) return;

    let niveisHtml = "";
    apt.niveis.forEach((desc, idx) => {
      const lvl = idx + 1;
      const isUnlocked = lvl <= nivelAtual;
      
      // Se n√£o for mestre, s√≥ mostra os n√≠veis desbloqueados (ou o pr√≥ximo a desbloquear para dar gostinho?)
      // Vamos mostrar apenas desbloqueados para o player.
      if (!isMestre && !isUnlocked) return; 

      const controls = isMestre ? `
        <div class="gm-controls">
          <div class="btn-gm" onclick="setAptidao('${apt.nome}', ${lvl})">üîì</div>
          <div class="btn-gm" style="border-color:#d00000;color:#d00000;" onclick="setAptidao('${apt.nome}', ${lvl-1})">üîí</div>
        </div>` : "";

      niveisHtml += `
        <div class="nivel-row ${isUnlocked ? 'unlocked' : ''}">
          <div class="nivel-check"></div>
          <div style="flex-grow:1;">${desc}</div>
          ${controls}
        </div>`;
    });

    container.innerHTML += `
      <div class="aptidao-box">
        <div class="aptidao-header" onclick="this.nextElementSibling.classList.toggle('open')">
          <span>${apt.nome} <span style="font-size:0.8rem;color:#666;">(${nivelAtual}/${apt.maxNivel})</span></span>
          <span>‚ñº</span>
        </div>
        <div class="aptidao-body ${nivelAtual > 0 ? 'open' : ''}">
          ${niveisHtml}
        </div>
      </div>`;
  });
}

// === FUN√á√ïES DO MESTRE ===
window.setAptidao = async (nomeApt, novoNivel) => {
  if (!isMestre) return;
  const progresso = ficha.progressoAptidoes || {};
  progresso[nomeApt] = novoNivel;
  await updateDoc(doc(db, "fichas", id), { progressoAptidoes: progresso });
};

window.addNovaAptidao = async () => {
  if (!isMestre) return;
  const nome = prompt("Nome da Nova Aptid√£o:");
  if (!nome) return;
  
  // Cria estrutura b√°sica
  const nova = {
    nome: nome,
    maxNivel: 5,
    niveis: ["NV 1 - Descri√ß√£o...", "NV 2 - ...", "NV 3 - ...", "NV 4 - ...", "NV 5 - ..."]
  };
  
  const custom = ficha.aptidoesCustom || [];
  custom.push(nova);
  
  await updateDoc(doc(db, "fichas", id), { aptidoesCustom: custom });
  alert("Aptid√£o criada! Edite os n√≠veis direto no banco se precisar de detalhes, ou use o padr√£o.");
};

// Utils (Mantidos)
window.upStat = async (k,v) => { 
  const s=ficha[k]; const n=Math.max(0,Math.min(s.max,Number(s.atual)+v)); 
  await updateDoc(doc(db,"fichas",id),{[`${k}.atual`]:n}); 
};
window.mathStat = async (k) => {
  const v = prompt("Valor (+/-):"); if(!v)return;
  const n = Math.max(0,Math.min(ficha[k].max, Number(ficha[k].atual)+Number(v)));
  await updateDoc(doc(db,"fichas",id),{[`${k}.atual`]:n});
};
window.editarCampo = async (el, field, type) => {
  const val = prompt("Novo valor:", el.innerText);
  if(val !== null) await updateDoc(doc(db,"fichas",id), {[field]: (type==='number'?Number(val):val)});
};

</script>
</body>
</html>
