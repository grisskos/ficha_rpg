<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Escudo do Mestre</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root { --bg: #0a0a0a; --card: #141414; --primary: #e63946; --energy: #4cc9f0; --sanity: #8ac926; --text: #f1f1f1; }
  
  body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; padding: 20px; }
  
  /* Cabe√ßalho do Escudo */
  header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 20px; }
  h1 { margin: 0; color: var(--primary); text-transform: uppercase; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
  
  /* Grid de Jogadores */
  .gm-grid { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
    gap: 20px; 
  }
  
  /* Cart√£o do Personagem (Mini Ficha) */
  .char-card { 
    background: var(--card); 
    border: 1px solid #333; 
    border-radius: 8px; 
    padding: 15px; 
    position: relative; 
    transition: transform 0.2s, border-color 0.2s;
  }
  .char-card:hover { border-color: var(--primary); transform: translateY(-2px); }
  
  .card-header { display: flex; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #222; padding-bottom: 10px; }
  .card-header img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--primary); object-fit: cover; margin-right: 12px; }
  .card-header h3 { margin: 0; font-size: 1.1rem; }
  .card-header small { color: #888; display: block; }

  /* Barras Compactas */
  .stat-row { margin-bottom: 8px; font-size: 0.9rem; font-family: monospace; }
  .stat-label { display: flex; justify-content: space-between; margin-bottom: 2px; color: #ccc; }
  
  .bar-mini-bg { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; }
  .bar-mini-fill { height: 100%; width: 0%; transition: width 0.5s ease; }
  
  /* Cores das barras */
  .hp .bar-mini-fill { background: var(--primary); box-shadow: 0 0 5px var(--primary); }
  .en .bar-mini-fill { background: var(--energy); box-shadow: 0 0 5px var(--energy); }
  .san .bar-mini-fill { background: var(--sanity); }

  /* Bot√£o Espiar */
  .btn-spy { 
    position: absolute; top: 15px; right: 15px; 
    background: transparent; border: 1px solid #444; color: #666; 
    width: 30px; height: 30px; border-radius: 50%; cursor: pointer; 
    display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
  }
  .btn-spy:hover { color: white; border-color: white; background: #333; }

  /* Bot√£o Voltar */
  .btn-back { background: #333; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
  .btn-back:hover { background: #444; }
</style>
</head>
<body>

<header>
  <h1>üõ°Ô∏è Escudo do Mestre</h1>
  <button class="btn-back" onclick="window.location='index.html'">Sair do Escudo</button>
</header>

<div id="grid" class="gm-grid">
  <p style="color:#666">Sintonizando com as almas dos jogadores...</p>
</div>

<script type="module">
import { db, collection, query, onSnapshot, orderBy } from "./firebase.js";

// Busca TODAS as fichas, independente do dono
// Ordena por nome para ficar organizado no grid
const q = query(collection(db, "fichas"), orderBy("nome"));

onSnapshot(q, (snapshot) => {
  const grid = document.getElementById("grid");
  
  if (snapshot.empty) {
    grid.innerHTML = "<p>Nenhum aventureiro encontrado neste plano.</p>";
    return;
  }

  grid.innerHTML = ""; // Limpa a tela para atualizar

  snapshot.forEach((doc) => {
    const f = doc.data();
    const id = doc.id;
    
    // C√°lculos de porcentagem
    const pVida = calcPct(f.vida);
    const pEnergia = calcPct(f.energia);
    const pSanidade = calcPct(f.integridade || f.vigor); // Fallback se n√£o tiver integridade

    grid.innerHTML += `
      <div class="char-card">
        <button class="btn-spy" onclick="window.open('ficha.html?id=${id}', '_blank')" title="Abrir Ficha Completa">üëÅÔ∏è</button>
        
        <div class="card-header">
          <img src="${f.imagem || 'https://via.placeholder.com/50/333/666?text=?'}" onerror="this.src='https://via.placeholder.com/50'">
          <div>
            <h3>${f.nome}</h3>
            <small>${f.classe || 'N/A'}</small>
          </div>
        </div>

        <div class="stat-row hp">
          <div class="stat-label"><span>VIDA</span> <span>${f.vida?.atual}/${f.vida?.max}</span></div>
          <div class="bar-mini-bg"><div class="bar-mini-fill" style="width:${pVida}%"></div></div>
        </div>

        <div class="stat-row en">
          <div class="stat-label"><span>ENERGIA</span> <span>${f.energia?.atual}/${f.energia?.max}</span></div>
          <div class="bar-mini-bg"><div class="bar-mini-fill" style="width:${pEnergia}%"></div></div>
        </div>

        <div class="stat-row san">
          <div class="stat-label"><span>SANIDADE</span> <span>${f.integridade?.atual || 0}/${f.integridade?.max || 0}</span></div>
          <div class="bar-mini-bg"><div class="bar-mini-fill" style="width:${pSanidade}%"></div></div>
        </div>
      </div>
    `;
  });
});

function calcPct(stat) {
  if (!stat || !stat.max) return 0;
  return Math.min(100, Math.max(0, (stat.atual / stat.max) * 100));
}
</script>

</body>
</html>