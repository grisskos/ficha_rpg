<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Ficha RPG</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root { 
    --bg: #0f0f0f; --card: #141414; 
    --primary: #e63946; --energy: #58E8DA; --vigor: #69E858; --integridade: #D073FA; 
    --text: #f1f1f1; --dim: #888;
  }
  
  body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; padding: 20px; margin: 0; }
  
  /* Layout */
  .main-layout { display: grid; grid-template-columns: 320px 1fr; gap: 20px; max-width: 1200px; margin: 0 auto; padding-bottom: 80px; }
  @media (max-width: 768px) { .main-layout { grid-template-columns: 1fr; } }

  .sidebar, .content-area { display: flex; flex-direction: column; gap: 20px; }
  .card { background: var(--card); padding: 20px; border-radius: 10px; border: 1px solid #2a2a2a; }

  /* Header */
  .char-header { text-align: center; }
  .char-img { width: 140px; height: 140px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); margin-bottom: 10px; }
  .char-name { font-size: 1.5rem; margin: 0; color: white; text-transform: uppercase; letter-spacing: 1px; }
  
  .badges { display: flex; justify-content: center; gap: 5px; flex-wrap: wrap; margin-top: 8px; }
  .badge { font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; background: #222; border: 1px solid #444; color: #ccc; }
  .b-lvl { color: white; border-color: white; font-weight: bold; }

  /* EDI√á√ÉO INLINE */
  .editable { 
    cursor: pointer; border-bottom: 1px dashed #555; transition: 0.2s; 
    display: inline-block; min-width: 20px; text-align: center;
  }
  .editable:hover { color: var(--primary); border-color: var(--primary); background: rgba(255,255,255,0.05); }
  
  .inline-input { 
    background: #000; color: white; border: 2px solid var(--primary); 
    border-radius: 4px; padding: 4px; font-family: inherit; font-size: inherit; 
    width: 80px; text-align: center; outline: none;
  }

  /* Atributos */
  .attr-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .attr-box { background: #222; padding: 8px; border-radius: 6px; text-align: center; border: 1px solid #333; }
  .attr-lbl { font-size: 0.7rem; color: var(--dim); display: block; font-weight: bold; }
  .attr-val { font-size: 1.4rem; font-weight: bold; display: block; margin: 2px 0; color: var(--text); }
  .attr-raw { font-size: 0.8rem; color: #777; background: #111; padding: 2px 6px; border-radius: 3px; }

  /* Barras */
  .stat-row { margin-bottom: 12px; }
  .stat-head { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 4px; color: #ddd; font-weight: bold; }
  .bar-bg { background: #333; height: 10px; border-radius: 5px; overflow: hidden; }
  .bar-fill { height: 100%; transition: width 0.3s; }
  
  .c-vida { background: var(--primary); box-shadow: 0 0 8px var(--primary); }
  .c-ener { background: var(--energy); box-shadow: 0 0 8px var(--energy); }
  .c-vigo { background: var(--vigor); box-shadow: 0 0 8px var(--vigor); }
  .c-inte { background: var(--integridade); box-shadow: 0 0 8px var(--integridade); }

  .stat-ctrl { display: flex; justify-content: flex-end; gap: 5px; margin-top: 4px; }
  .btn-mini { background: #222; border: 1px solid #444; color: #ccc; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
  .btn-mini:hover { border-color: white; color: white; background: #333; }
  
  /* Bot√£o de Calculadora */
  .btn-calc { background: #222; border: 1px solid #555; color: #ccc; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-right: auto; }
  .btn-calc:hover { border-color: var(--energy); color: var(--energy); }

  /* Per√≠cias */
  .skills-card { padding: 0; overflow: hidden; }
  .skills-header { padding: 15px; background: #222; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
  .skills-header h3 { margin: 0; font-size: 1.1rem; color: var(--primary); }
  .skill-row { display: flex; align-items: center; padding: 8px 15px; border-bottom: 1px solid #222; font-size: 0.95rem; }
  .skill-row:hover { background: #1b1b1b; }
  
  .sk-name { flex-grow: 1; color: #eee; }
  .sk-attr { font-size: 0.7rem; color: #555; width: 40px; text-transform: uppercase; font-weight: bold; }
  .sk-total { font-weight: bold; color: white; width: 35px; text-align: right; margin-right: 15px; font-size: 1.1rem; }
  
  .sk-btn-group { display: flex; gap: 5px; }
  .sk-btn { 
    width: 25px; height: 25px; border-radius: 4px; border: 1px solid #444; background: #111; 
    color: #555; font-size: 0.7rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: 0.2s;
  }
  .sk-btn:hover { border-color: #777; color: #aaa; }
  .sk-btn.active-t { background: rgba(88, 232, 218, 0.2); border-color: var(--energy); color: var(--energy); }
  .sk-btn.active-m { background: rgba(230, 57, 70, 0.2); border-color: var(--primary); color: var(--primary); }

  /* FAB e MODAL */
  .fab-config { position: fixed; bottom: 20px; right: 20px; background: #222; color: white; border: 2px solid #555; width: 50px; height: 50px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.6); z-index: 100; transition: 0.2s; }
  .fab-config:hover { background: var(--primary); border-color: var(--primary); }

  .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; padding: 20px; }
  .modal-content { background: var(--card); padding: 20px; border-radius: 10px; max-width: 500px; margin: 0 auto; border: 1px solid #444; }
  textarea { width: 100%; height: 100px; background: #111; color: white; border: 1px solid #333; margin-top: 5px; }
</style>
</head>
<body>

<div class="main-layout">
  
  <div class="sidebar">
    <div class="card char-header">
      <img id="charImg" class="char-img" src="">
      <h2 class="char-name"><span class="editable" id="nomeDisplay" onclick="editarCampo(this, 'nome', 'text')">...</span></h2>
      <div id="badges" class="badges"></div>
    </div>

    <div class="card">
      <div id="atributosArea" class="attr-grid"></div>
      <p style="text-align:center; font-size:0.7rem; color:#666; margin-bottom:0;">Clique no n√∫mero pequeno para editar</p>
    </div>

    <div class="card">
      <div id="statsArea"></div>
    </div>
    
    <button class="btn-mini" style="width:100%; padding:10px; font-size:1rem;" onclick="window.location='index.html'">Voltar</button>
  </div>

  <div class="content-area">
    <div class="card skills-card">
      <div class="skills-header">
        <h3>Per√≠cias</h3>
        <span id="treinoDisplay" style="font-size:0.8rem; color:#aaa;"></span>
      </div>
      <div id="skillsList"></div>
    </div>

    <div class="card">
      <div class="skills-header"><h3>‚öîÔ∏è Ataques</h3></div>
      <div style="padding:15px"><ul id="ataquesList" style="margin:0; padding-left:20px; color:#ccc;"></ul></div>
    </div>
    
    <div class="card">
      <div class="skills-header"><h3>üî• Habilidades</h3></div>
      <div style="padding:15px"><ul id="habsList" style="margin:0; padding-left:20px; color:#ccc;"></ul></div>
    </div>
  </div>
</div>

<button class="fab-config" onclick="abrirConfig()">‚öôÔ∏è</button>

<div id="configModal" class="modal">
  <div class="modal-content">
    <h2 style="color:var(--primary); margin-top:0;">Configura√ß√µes</h2>
    
    <label style="display:block; color:#aaa; font-weight:bold;">Imagem (URL)</label>
    <input id="editImgUrl" style="width:100%; background:#111; border:1px solid #333; color:white; padding:5px; margin-bottom:15px;">
    <button onclick="salvarImg()" style="background:#333; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">Atualizar Imagem</button>

    <br><br>
    <label style="display:block; color:#aaa; font-weight:bold;">Ataques (1 por linha)</label>
    <textarea id="editAtaques"></textarea>
    
    <br><br>
    <label style="display:block; color:#aaa; font-weight:bold;">Habilidades (1 por linha)</label>
    <textarea id="editHabs"></textarea>

    <button onclick="salvarListas()" style="background:var(--primary); width:100%; padding:12px; color:white; border:none; cursor:pointer; border-radius:5px; font-weight:bold; margin-top:20px;">Salvar Listas</button>
    <button onclick="document.getElementById('configModal').style.display='none'" style="background:#333; width:100%; padding:12px; color:white; border:none; cursor:pointer; border-radius:5px; margin-top:10px;">Fechar</button>
    <button onclick="excluirPersonagem()" style="background:transparent; color:#d00000; border:none; width:100%; margin-top:15px; cursor:pointer;">Excluir Personagem</button>
  </div>
</div>

<script type="module">
import { db, doc, updateDoc, deleteDoc, onSnapshot } from "./firebase.js";

const params = new URLSearchParams(location.search);
const id = params.get("id");
let ficha = {}; 
let editandoId = null;

const PERICIAS_DEF = [
  { n: "Atletismo", a: "forca" }, { n: "Acrobacia", a: "destreza" }, { n: "Furtividade", a: "destreza" },
  { n: "Prestidigita√ß√£o", a: "destreza" }, { n: "Feiti√ßaria", a: "inteligencia" }, { n: "Hist√≥ria", a: "inteligencia" },
  { n: "Investiga√ß√£o", a: "inteligencia" }, { n: "Of√≠cio 1", a: "inteligencia" }, { n: "Tecnologia", a: "inteligencia" },
  { n: "Teologia", a: "inteligencia" }, { n: "Dire√ß√£o", a: "sabedoria" }, { n: "Intui√ß√£o", a: "sabedoria" },
  { n: "Medicina", a: "sabedoria" }, { n: "Ocultismo", a: "sabedoria" }, { n: "Percep√ß√£o", a: "sabedoria" },
  { n: "Sobreviv√™ncia", a: "sabedoria" }, { n: "Engana√ß√£o", a: "presenca" }, { n: "Intimida√ß√£o", a: "presenca" },
  { n: "Performance", a: "presenca" }, { n: "Persuas√£o", a: "presenca" }
];
const ATR_SHORT = { forca:"FOR", destreza:"DES", constituicao:"CON", inteligencia:"INT", sabedoria:"SAB", presenca:"PRE" };

onSnapshot(doc(db, "fichas", id), (docSnap) => {
  if (docSnap.exists()) { 
    ficha = docSnap.data(); 
    if(!editandoId) renderFicha(); 
  }
});

function renderFicha() {
  const f = ficha;
  
  // Nome
  document.getElementById('nomeDisplay').innerText = f.nome;
  const imgEl = document.getElementById('charImg');
  if(f.imagem) imgEl.src = f.imagem;

  // Badges
  document.getElementById('badges').innerHTML = `
    <span class="badge b-lvl">NVL <span class="editable" onclick="editarCampo(this, 'nivel', 'number')">${f.nivel||1}</span></span>
    <span class="badge b-cls">${f.classe || 'Aventureiro'}</span>
  `;

  // Atributos
  const areaAttr = document.getElementById('atributosArea');
  areaAttr.innerHTML = "";
  Object.keys(ATR_SHORT).forEach(key => {
    const val = f.atributos[key] || 10;
    const mod = Math.floor((val - 10) / 2);
    areaAttr.innerHTML += `
      <div class="attr-box">
        <span class="attr-lbl">${ATR_SHORT[key]}</span>
        <span class="attr-val">${mod>=0?'+':''}${mod}</span>
        <span class="attr-raw editable" onclick="editarCampo(this, 'atributos.${key}', 'number')">${val}</span>
      </div>`;
  });

  // Stats (Barras) - AGORA COM BOT√ÉO MATH üî¢
  const areaStats = document.getElementById('statsArea');
  areaStats.innerHTML = "";
  const statsMap = [
    {k:'vida', l:'Vida', c:'c-vida'}, {k:'energia', l:'Energia', c:'c-ener'},
    {k:'vigor', l:'Vigor', c:'c-vigo'}, {k:'integridade', l:'Integ.', c:'c-inte'}
  ];
  statsMap.forEach(s => {
    const st = f[s.k];
    if(!st) return;
    const pct = Math.min(100, (st.atual/st.max)*100);
    
    areaStats.innerHTML += `
      <div class="stat-row">
        <div class="stat-head">
          <span>${s.l}</span> 
          <div>
            <span class="editable" onclick="editarCampo(this, '${s.k}.atual', 'number')">${st.atual}</span> / 
            <span class="editable" onclick="editarCampo(this, '${s.k}.max', 'number')">${st.max}</span>
          </div>
        </div>
        <div class="bar-bg"><div class="bar-fill ${s.c}" style="width:${pct}%"></div></div>
        <div class="stat-ctrl">
          <div class="btn-calc" onclick="mathStat('${s.k}', '${s.l}')" title="Calcular Dano/Cura">üî¢</div>
          <div class="btn-mini" onclick="upStat('${s.k}', -1)">-</div>
          <div class="btn-mini" onclick="upStat('${s.k}', 1)">+</div>
        </div>
      </div>`;
  });

  // Per√≠cias
  const nivel = f.nivel || 1;
  const bonusTreino = 2 + Math.floor((nivel - 1) / 4);
  document.getElementById('treinoDisplay').innerText = `Treino: +${bonusTreino}`;

  const listaSkills = document.getElementById('skillsList');
  listaSkills.innerHTML = "";
  const metadeNivel = Math.floor(nivel / 2);
  const userPericias = f.pericias || {}; 

  PERICIAS_DEF.forEach(p => {
    const attrVal = f.atributos[p.a] || 10;
    const modAttr = Math.floor((attrVal - 10) / 2);
    const saved = userPericias[p.n] || { t: false, m: false };
    
    let total = modAttr + metadeNivel;
    if (saved.t) total += bonusTreino;
    if (saved.m) total += 1;

    listaSkills.innerHTML += `
      <div class="skill-row">
        <span class="sk-name">${p.n}</span>
        <span class="sk-attr">${ATR_SHORT[p.a]}</span>
        <span class="sk-total">${total>=0?'+':''}${total}</span>
        <div class="sk-btn-group">
           <div class="sk-btn ${saved.t ? 'active-t' : ''}" onclick="togglePericia('${p.n}', 't')">T</div>
           <div class="sk-btn ${saved.m ? 'active-m' : ''}" onclick="togglePericia('${p.n}', 'm')">M</div>
        </div>
      </div>`;
  });

  document.getElementById('ataquesList').innerHTML = (f.ataques||[]).map(i=>`<li>${i}</li>`).join('');
  document.getElementById('habsList').innerHTML = (f.habilidades||[]).map(i=>`<li>${i}</li>`).join('');
}

// === C√ÅLCULO DE DANO/CURA (MATH) ===
window.mathStat = async (key, nomeDisplay) => {
  // Pede o valor ao usu√°rio
  const input = prompt(`ALTERAR ${nomeDisplay.toUpperCase()}\nDigite o valor para SOMAR.\n(Use negativo para dano, ex: -12)`);
  
  if (!input) return; // Cancelou
  
  const valor = Number(input);
  if (isNaN(valor)) return alert("Por favor, digite um n√∫mero v√°lido.");

  const st = ficha[key];
  let novo = Number(st.atual) + valor;

  // Trava nos limites (0 e M√°ximo)
  novo = Math.max(0, Math.min(st.max, novo));

  await updateDoc(doc(db, "fichas", id), { [`${key}.atual`]: novo });
};

// === EDI√á√ÉO INLINE ===
window.editarCampo = (el, field, type) => {
  if (el.querySelector('input')) return;
  editandoId = field;
  const valorAtual = el.innerText;
  el.innerHTML = `<input id="inputEdit" class="inline-input" type="${type}" value="${valorAtual}">`;
  const input = document.getElementById('inputEdit');
  input.focus();
  const salvar = async () => {
    let novoValor = input.value;
    if (type === 'number') novoValor = Number(novoValor);
    el.innerHTML = novoValor;
    editandoId = null;
    try { await updateDoc(doc(db, "fichas", id), { [field]: novoValor }); } 
    catch (e) { console.error(e); el.innerText = valorAtual; }
  };
  input.addEventListener('blur', salvar);
  input.addEventListener('keydown', (e) => { if (e.key === 'Enter') input.blur(); });
};

window.togglePericia = async (skillName, tipo) => {
  const pericias = ficha.pericias || {};
  if (!pericias[skillName]) pericias[skillName] = { t: false, m: false };
  pericias[skillName][tipo] = !pericias[skillName][tipo];
  await updateDoc(doc(db, "fichas", id), { pericias: pericias });
};

window.upStat = async (key, val) => {
  const st = ficha[key];
  const novo = Math.max(0, Math.min(st.max, Number(st.atual)+val));
  await updateDoc(doc(db, "fichas", id), { [`${key}.atual`]: novo });
};

// Configura√ß√µes e Listas
window.abrirConfig = () => {
  document.getElementById('configModal').style.display = 'block';
  document.getElementById('editImgUrl').value = ficha.imagem || "";
  document.getElementById('editAtaques').value = (ficha.ataques||[]).join('\n');
  document.getElementById('editHabs').value = (ficha.habilidades||[]).join('\n');
}

window.salvarImg = async () => {
  await updateDoc(doc(db, "fichas", id), { imagem: document.getElementById('editImgUrl').value });
  alert("Imagem atualizada!");
}

window.salvarListas = async () => {
  const getArr = (id) => document.getElementById(id).value.split('\n').filter(x=>x.trim());
  await updateDoc(doc(db, "fichas", id), {
    ataques: getArr('editAtaques'),
    habilidades: getArr('editHabs')
  });
  alert("Listas salvas!");
  document.getElementById('configModal').style.display = 'none';
}

window.excluirPersonagem = async () => {
  if(prompt("Digite DELETAR para confirmar:")==="DELETAR") {
    await deleteDoc(doc(db, "fichas", id));
    window.location="index.html";
  }
};
</script>
</body>
</html>
