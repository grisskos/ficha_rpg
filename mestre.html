<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Escudo do Mestre</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root { 
    --bg: #0a0a0a; --card: #141414; 
    --primary: #e63946; --energy: #58E8DA; --vigor: #69E858; --integridade: #D073FA;
    --apice: #f4d35e; --corpo: #9d4edd;
    --text: #f1f1f1; 
  }
  
  body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; padding: 20px; margin: 0; }
  
  /* HEADER E FILTROS */
  header { 
    display: flex; justify-content: space-between; align-items: center; 
    background: #111; padding: 15px; border-bottom: 2px solid var(--primary); margin-bottom: 20px; flex-wrap: wrap; gap: 10px;
  }
  h1 { margin: 0; color: var(--primary); text-transform: uppercase; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
  
  .filter-group { display: flex; gap: 10px; align-items: center; }
  select { background: #222; color: white; border: 1px solid #444; padding: 8px; border-radius: 4px; outline: none; }
  
  .btn-back { background: #333; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
  .btn-back:hover { background: #444; }

  /* GRID DE PERSONAGENS */
  .gm-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
  
  .char-card { 
    background: var(--card); border: 1px solid #333; border-radius: 8px; 
    padding: 15px; position: relative; transition: transform 0.2s, border-color 0.2s; display: flex; flex-direction: column; gap: 8px;
  }
  .char-card:hover { border-color: var(--primary); transform: translateY(-2px); }
  
  /* Header do Card */
  .card-header { display: flex; align-items: center; border-bottom: 1px solid #222; padding-bottom: 10px; }
  .char-img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--primary); object-fit: cover; margin-right: 12px; }
  .char-info h3 { margin: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
  .char-info small { color: #888; display: block; margin-top: 2px; cursor: pointer; }
  .char-info small:hover { color: var(--energy); text-decoration: underline; }

  .lvl-badge { font-size: 0.7rem; background: #333; color: #fff; padding: 2px 6px; border-radius: 4px; border: 1px solid #555; }

  /* Barras */
  .stat-row { font-size: 0.8rem; font-family: monospace; display: flex; flex-direction: column; gap: 2px; }
  .stat-label { display: flex; justify-content: space-between; color: #ccc; }
  .bar-bg { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; }
  .bar-fill { height: 100%; width: 0%; transition: width 0.5s ease; }
  .hp .bar-fill { background: var(--primary); }
  .en .bar-fill { background: var(--energy); }
  .int .bar-fill { background: var(--integridade); }

  /* Controles do Mestre (Rodap√© do Card) */
  .card-footer { 
    display: flex; justify-content: space-between; align-items: center; 
    margin-top: 5px; padding-top: 10px; border-top: 1px solid #222; 
  }
  
  .transf-toggles { display: flex; gap: 5px; }
  .btn-toggle { 
    width: 30px; height: 30px; border-radius: 50%; border: 2px solid #444; background: #222; 
    color: #555; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1rem; transition: 0.2s; 
  }
  
  /* Estados Ativos */
  .btn-toggle.apice.active { border-color: var(--apice); color: var(--apice); box-shadow: 0 0 8px var(--apice); }
  .btn-toggle.corpo.active { border-color: var(--corpo); color: var(--corpo); box-shadow: 0 0 8px var(--corpo); }

  .btn-aptidao { background: #222; border: 1px solid #555; color: #ccc; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
  .btn-aptidao:hover { border-color: white; color: white; }

  .btn-spy { 
    position: absolute; top: 10px; right: 10px; background: transparent; border: none; 
    color: #666; font-size: 1.2rem; cursor: pointer; 
  }
  .btn-spy:hover { color: white; }

  /* MODAL DE APTID√ïES */
  .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; align-items: center; justify-content: center; }
  .modal-content { background: var(--card); padding: 20px; border-radius: 10px; width: 90%; max-width: 500px; border: 1px solid var(--primary); max-height: 80vh; overflow-y: auto; }
  .modal h2 { margin-top: 0; color: var(--primary); border-bottom: 1px solid #333; padding-bottom: 10px; }
  
  .apt-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #222; }
  .apt-name { color: #ddd; font-size: 0.9rem; }
  .apt-ctrl { display: flex; align-items: center; gap: 10px; }
  .lvl-display { font-weight: bold; color: var(--energy); width: 30px; text-align: center; }
  .btn-adjust { width: 25px; height: 25px; background: #333; border: 1px solid #555; color: white; border-radius: 4px; cursor: pointer; }
  .btn-adjust:hover { background: var(--primary); border-color: var(--primary); color: black; }

  #loading { text-align: center; color: #666; margin-top: 20px; }
</style>
</head>
<body>

<div id="loading">Verificando Credenciais do Mestre...</div>

<div id="app" style="display:none;">
  <header>
    <h1>üõ°Ô∏è Painel do Mestre</h1>
    
    <div class="filter-group">
      <label>Mesa:</label>
      <select id="mesaFilter" onchange="filtrarMesas()">
        <option value="todas">Todas as Mesas</option>
      </select>
      <button class="btn-back" onclick="window.location='index.html'">Sair</button>
    </div>
  </header>

  <div id="grid" class="gm-grid">Carregando...</div>
</div>

<div id="aptModal" class="modal">
  <div class="modal-content">
    <h2 id="aptModalTitle">Gerenciar Aptid√µes</h2>
    <div id="aptList"></div>
    <button class="btn-back" style="width:100%; margin-top:15px;" onclick="fecharModal()">Fechar</button>
  </div>
</div>

<script type="module">
import { db, auth, collection, query, onSnapshot, orderBy, doc, updateDoc, onAuthStateChanged } from "./firebase.js";

const MESTRE_EMAIL = "grisskos@fake.com";
let allCharacters = []; 

// LISTA COMPLETA PARA O MESTRE DAR NIVEIS
const APTIDOES_LIST = [
  { nome: "Libera√ß√£o de Energia", max: 10 },
  { nome: "Prote√ß√£o", max: 8 },
  { nome: "Proje√ß√£o", max: 5 },
  { nome: "Cria√ß√£o", max: 5 },
  { nome: "Concentra√ß√£o", max: 5 },
  { nome: "Transforma√ß√£o", max: 5 },
  { nome: "Aura Elemental", max: 5 },
  { nome: "Molde", max: 5 },
  { nome: "Intensifica√ß√£o", max: 5 },
  { nome: "Solidifica√ß√£o", max: 5 },
  { nome: "Encasular", max: 5 },
  { nome: "Redirecionar", max: 5 },
  { nome: "Esconder", max: 5 },
  { nome: "Perturba√ß√£o", max: 5 },
  // NOVAS APTID√ïES ADICIONADAS
  { nome: "Infestar", max: 3 },
  { nome: "Destruir", max: 3 },
  { nome: "Torturar", max: 3 },
  { nome: "Assombrar", max: 3 },
  // TRANSFORMA√á√ïES
  { nome: "√Åpice Humano", max: 1 },
  { nome: "Corpo Amaldi√ßoado", max: 1 }
];

// Seguran√ßa
onAuthStateChanged(auth, user => {
  if (user && user.email === MESTRE_EMAIL) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    iniciarMonitoramento();
  } else {
    alert("ACESSO NEGADO: Apenas o Mestre pode entrar aqui.");
    window.location = "index.html";
  }
});

function iniciarMonitoramento() {
  const q = query(collection(db, "fichas"), orderBy("nome"));

  onSnapshot(q, (snapshot) => {
    allCharacters = [];
    const mesasSet = new Set();

    snapshot.forEach((doc) => {
      const f = doc.data();
      f.id = doc.id;
      f.mesa = f.mesa || "Sem Mesa"; 
      mesasSet.add(f.mesa);
      allCharacters.push(f);
    });

    atualizarFiltroMesas(Array.from(mesasSet));
    renderGrid();
  });
}

function atualizarFiltroMesas(mesas) {
  const select = document.getElementById('mesaFilter');
  const atual = select.value;
  
  select.innerHTML = '<option value="todas">Todas as Mesas</option>';
  
  mesas.sort().forEach(m => {
    const opt = document.createElement('option');
    opt.value = m;
    opt.innerText = m;
    select.appendChild(opt);
  });
  
  select.value = atual; 
}

window.filtrarMesas = () => {
  renderGrid();
};

function renderGrid() {
  const grid = document.getElementById("grid");
  const filtro = document.getElementById('mesaFilter').value;
  
  grid.innerHTML = ""; 
  
  const filtrados = allCharacters.filter(c => filtro === "todas" || c.mesa === filtro);

  if (filtrados.length === 0) {
    grid.innerHTML = "<p style='color:#666'>Nenhum personagem nesta mesa.</p>";
    return;
  }

  filtrados.forEach(f => {
    const pVida = calcPct(f.vida);
    const pEnergia = calcPct(f.energia);
    const pIntegridade = calcPct(f.integridade); 
    
    const apiceActive = f.transfUnlocked?.apice ? 'active' : '';
    const corpoActive = f.transfUnlocked?.corpo ? 'active' : '';

    grid.innerHTML += `
      <div class="char-card">
        <button class="btn-spy" onclick="window.open('ficha.html?id=${f.id}', '_blank')" title="Abrir Ficha">üëÅÔ∏è</button>
        
        <div class="card-header">
          <img src="${f.imagem || 'https://via.placeholder.com/50'}" class="char-img">
          <div class="char-info">
            <h3>${f.nome} <span class="lvl-badge">Nvl ${f.nivel||1}</span></h3>
            <small onclick="mudarMesa('${f.id}', '${f.mesa}')">üìç ${f.mesa}</small>
          </div>
        </div>

        <div class="stat-row hp">
          <div class="stat-label"><span>VIDA</span> <span>${f.vida?.atual||0}/${f.vida?.max||0}</span></div>
          <div class="bar-bg"><div class="bar-fill" style="width:${pVida}%"></div></div>
        </div>

        <div class="stat-row en">
          <div class="stat-label"><span>ENERGIA</span> <span>${f.energia?.atual||0}/${f.energia?.max||0}</span></div>
          <div class="bar-bg"><div class="bar-fill" style="width:${pEnergia}%"></div></div>
        </div>

        <div class="stat-row int">
          <div class="stat-label"><span>INTEGRIDADE</span> <span>${f.integridade?.atual||0}/${f.integridade?.max||0}</span></div>
          <div class="bar-bg"><div class="bar-fill" style="width:${pIntegridade}%"></div></div>
        </div>

        <div class="card-footer">
           <div class="transf-toggles">
             <div class="btn-toggle apice ${apiceActive}" onclick="toggleUnlock('${f.id}', 'apice', ${!f.transfUnlocked?.apice})" title="Desbloquear √Åpice">‚ö°</div>
             <div class="btn-toggle corpo ${corpoActive}" onclick="toggleUnlock('${f.id}', 'corpo', ${!f.transfUnlocked?.corpo})" title="Desbloquear Corpo">üëπ</div>
           </div>
           <button class="btn-aptidao" onclick="abrirAptidoes('${f.id}')">üß† Aptid√µes</button>
        </div>
      </div>
    `;
  });
}

function calcPct(stat) {
  if (!stat || !stat.max) return 0;
  return Math.min(100, Math.max(0, (stat.atual / stat.max) * 100));
}

// === A√á√ïES DO MESTRE ===

window.mudarMesa = async (id, atual) => {
  const nova = prompt("Nome da Mesa para este personagem:", atual);
  if(nova && nova !== atual) {
    await updateDoc(doc(db, "fichas", id), { mesa: nova });
  }
};

window.toggleUnlock = async (id, tipo, novoEstado) => {
  const char = allCharacters.find(c => c.id === id);
  const unlocked = char.transfUnlocked || {};
  unlocked[tipo] = novoEstado;
  await updateDoc(doc(db, "fichas", id), { transfUnlocked: unlocked });
};

// === MODAL DE APTID√ïES ===
let currentEditId = null;

window.abrirAptidoes = (id) => {
  currentEditId = id;
  const char = allCharacters.find(c => c.id === id);
  const listDiv = document.getElementById('aptList');
  const modal = document.getElementById('aptModal');
  
  document.getElementById('aptModalTitle').innerText = `Aptid√µes: ${char.nome}`;
  listDiv.innerHTML = "";

  const progresso = char.progressoAptidoes || {};
  const todas = [...APTIDOES_LIST, ...(char.aptidoesCustom || [])];

  todas.forEach(apt => {
    const nivel = progresso[apt.nome] || 0;
    
    listDiv.innerHTML += `
      <div class="apt-item">
        <div class="apt-name">${apt.nome} <span style="color:#666; font-size:0.8rem;">(Max ${apt.max || apt.maxNivel})</span></div>
        <div class="apt-ctrl">
          <button class="btn-adjust" onclick="ajustarApt('${apt.nome}', -1)">-</button>
          <span class="lvl-display">${nivel}</span>
          <button class="btn-adjust" onclick="ajustarApt('${apt.nome}', 1)">+</button>
        </div>
      </div>
    `;
  });

  modal.style.display = 'flex';
};

window.ajustarApt = async (nome, delta) => {
  if(!currentEditId) return;
  const char = allCharacters.find(c => c.id === currentEditId);
  const progresso = char.progressoAptidoes || {};
  
  let novoNivel = (progresso[nome] || 0) + delta;
  if(novoNivel < 0) novoNivel = 0;
  
  progresso[nome] = novoNivel;
  
  await updateDoc(doc(db, "fichas", currentEditId), { progressoAptidoes: progresso });
  
  char.progressoAptidoes = progresso;
  abrirAptidoes(currentEditId);
};

window.fecharModal = () => {
  document.getElementById('aptModal').style.display = 'none';
  currentEditId = null;
};

</script>
</body>
</html>
