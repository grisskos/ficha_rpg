<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Portal RPG</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root { --bg: #0f0f0f; --card: #1c1c1c; --primary: #e63946; --text: #f1f1f1; }
  body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; padding: 20px; display: flex; flex-direction: column; align-items: center; }
  
  h1 { color: var(--primary); text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 10px rgba(230, 57, 70, 0.5); }
  
  .container { width: 100%; max-width: 500px; }
  .card { background: var(--card); padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); border: 1px solid #333; }
  
  input { width: 100%; padding: 12px; margin: 10px 0; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 6px; box-sizing: border-box; }
  input:focus { outline: none; border-color: var(--primary); }

  button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; }
  button:hover { background: #d62828; box-shadow: 0 0 15px var(--primary); }
  button.outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
  button.outline:hover { background: var(--primary); color: white; }

  /* Lista de Personagens */
  .ficha-item { display: flex; align-items: center; background: #252525; padding: 10px 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid var(--primary); transition: transform 0.2s; position: relative; }
  .ficha-item:hover { transform: translateX(5px); background: #2a2a2a; }
  
  .ficha-content { display: flex; align-items: center; flex-grow: 1; cursor: pointer; }
  .ficha-item img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-right: 15px; border: 2px solid var(--primary); }
  .ficha-info { flex-grow: 1; }
  .ficha-info h3 { margin: 0; font-size: 1.1rem; }
  
  /* Bot√£o Lixeira */
  .btn-trash { 
    background: transparent; border: none; padding: 10px; width: auto; margin: 0 0 0 10px; 
    color: #555; font-size: 1.2rem; cursor: pointer; z-index: 10;
  }
  .btn-trash:hover { color: #e63946; background: transparent; box-shadow: none; transform: scale(1.1); }
  
  .hidden { display: none; }
  
  /* Bot√£o Mestre Especial */
  .btn-gm-access {
    border-color: #D073FA; color: #D073FA; margin-top: 10px;
  }
  .btn-gm-access:hover { background: #D073FA; color: #000; box-shadow: 0 0 15px #D073FA; }
</style>
</head>
<body>

<div class="container">
  <h1>‚öîÔ∏è Grim√≥rio de Fichas</h1>

  <div id="loginBox" class="card">
    <h2 style="margin-top:0">Acesso</h2>
    <input id="emailInput" placeholder="Usu√°rio (Login simples)">
    <input id="passInput" placeholder="Senha" type="password">
    <button id="btnLogin">Entrar</button>
    <button id="btnCreate" class="outline">Criar Nova Conta</button>
  </div>

  <div id="userArea" class="card hidden">
    <p>Conectado como: <strong id="userEmail" style="color:var(--primary)"></strong></p>
    <a href="create.html"><button>+ Novo Personagem</button></a>
    
    <div id="gmArea"></div>

    <button id="btnLogout" class="outline" style="border-color:#555; color:#888; margin-top:10px;">Sair</button>
  </div>

  <div id="lista"></div>
</div>

<script type="module">
import { 
  db, auth, collection, query, where, onSnapshot, doc, deleteDoc,
  onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut 
} from "./firebase.js";

const MESTRE_EMAIL = "grisskos@fake.com";
const emailInput = document.getElementById('emailInput');
const passInput = document.getElementById('passInput');

// Autentica√ß√£o
onAuthStateChanged(auth, user => {
  if (user) {
    document.getElementById("loginBox").classList.add("hidden");
    document.getElementById("userArea").classList.remove("hidden");
    document.getElementById("userEmail").innerText = user.email.replace("@fake.com", "");
    
    // VERIFICA SE √â O MESTRE
    const gmArea = document.getElementById("gmArea");
    gmArea.innerHTML = ""; // Limpa
    if (user.email === MESTRE_EMAIL) {
      gmArea.innerHTML = `<a href="mestre.html"><button class="outline btn-gm-access">üõ°Ô∏è Escudo do Mestre</button></a>`;
    }

    carregarFichas(user.uid);
  } else {
    document.getElementById("loginBox").classList.remove("hidden");
    document.getElementById("userArea").classList.add("hidden");
    document.getElementById("lista").innerHTML = "";
  }
});

function carregarFichas(uid) {
  const q = query(collection(db, "fichas"), where("uid", "==", uid));
  onSnapshot(q, snapshot => {
    const lista = document.getElementById("lista");
    lista.innerHTML = "";
    
    if (snapshot.empty) {
      lista.innerHTML = "<p style='text-align:center; color:#666;'>Nenhum personagem encontrado.</p>";
      return;
    }

    snapshot.forEach(docSnap => {
      const f = docSnap.data();
      const origemTxt = f.origem ? `‚Ä¢ ${f.origem}` : "";
      const nivel = f.nivel || 1;

      lista.innerHTML += `
        <div class="ficha-item">
          <div class="ficha-content" onclick="window.location='ficha.html?id=${docSnap.id}'">
            <img src="${f.imagem || 'https://via.placeholder.com/150/e63946/FFFFFF?text=RPG'}">
            <div class="ficha-info">
              <h3>${f.nome} <span style="font-size:0.8rem; background:#333; padding:2px 6px; border-radius:4px; color:white;">Lvl ${nivel}</span></h3>
              <small style="color:#888">${f.classe || 'Aventureiro'} ${origemTxt}</small>
            </div>
          </div>
          
          <button class="btn-trash" onclick="deletar(event, '${docSnap.id}', '${f.nome}')" title="Excluir">üóëÔ∏è</button>
        </div>`;
    });
  });
}

// Fun√ß√£o Global de Deletar
window.deletar = async (event, id, nome) => {
  event.stopPropagation(); // IMPEDE QUE O CLIQUE ABRA A FICHA
  const confirmacao = prompt(`Para apagar ${nome} permanentemente, digite 'DELETAR':`);
  if (confirmacao === "DELETAR") {
    try {
      await deleteDoc(doc(db, "fichas", id));
    } catch(e) {
      alert("Erro ao deletar: " + e.message);
    }
  }
};

// Bot√µes de Login
document.getElementById('btnLogin').addEventListener('click', () => {
  signInWithEmailAndPassword(auth, emailInput.value + "@fake.com", passInput.value).catch(e => alert("Erro: " + e.message));
});

document.getElementById('btnCreate').addEventListener('click', () => {
  createUserWithEmailAndPassword(auth, emailInput.value + "@fake.com", passInput.value).catch(e => alert("Erro: " + e.message));
});

document.getElementById('btnLogout').addEventListener('click', () => signOut(auth));
</script>
</body>
</html>
