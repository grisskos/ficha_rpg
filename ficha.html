<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Ficha RPG</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root { 
    --bg: #0f0f0f; --card: #141414; 
    --primary: #e63946; --energy: #58E8DA; --vigor: #69E858; --integridade: #D073FA; 
    --apice: #f4d35e; --corpo: #9d4edd;
    --text: #f1f1f1; --dim: #888;
    --inv-bg: #1e1e1e; --inv-hover: #2a2a2a;
  }
  
  body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; padding: 20px; margin: 0; }
  
  /* === LAYOUT === */
  .main-layout { display: grid; grid-template-columns: 280px 1fr 300px; gap: 20px; max-width: 1600px; margin: 0 auto; padding-bottom: 80px; }
  @media (max-width: 1200px) { .main-layout { grid-template-columns: 280px 1fr; } }
  @media (max-width: 900px) { .main-layout { grid-template-columns: 1fr; } }

  .col-side, .col-center, .col-right { display: flex; flex-direction: column; gap: 20px; }
  .card { background: var(--card); padding: 20px; border-radius: 10px; border: 1px solid #2a2a2a; position: relative; }

  /* HEADER */
  .char-header { text-align: center; }
  .transf-container { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; }
  .transf-btn { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #444; background: #222; color: #555; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
  .transf-btn.locked { opacity: 0.5; cursor: not-allowed; }
  .transf-btn.unlocked { border-color: #fff; color: #fff; box-shadow: 0 0 5px rgba(255,255,255,0.2); }
  .transf-btn.apice.unlocked { border-color: var(--apice); color: var(--apice); }
  .transf-btn.apice.active { background: var(--apice); color: #000; box-shadow: 0 0 15px var(--apice); animation: pulse 2s infinite; }
  .transf-btn.corpo.unlocked { border-color: var(--corpo); color: var(--corpo); }
  .transf-btn.corpo.active { background: var(--corpo); color: #fff; box-shadow: 0 0 15px var(--corpo); animation: pulse 2s infinite; }
  @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 255, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); } }
  
  .char-img { width: 140px; height: 140px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); margin-bottom: 10px; }
  .char-name { font-size: 1.5rem; margin: 0; color: white; text-transform: uppercase; letter-spacing: 1px; }
  .badges { display: flex; justify-content: center; gap: 5px; flex-wrap: wrap; margin-top: 8px; }
  .badge { font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; background: #222; border: 1px solid #444; color: #ccc; }
  .b-lvl { color: white; border-color: white; font-weight: bold; }
  .b-cls { color: var(--primary); border-color: var(--primary); cursor: pointer; }
  .sequela-tag { display: block; background: #300; color: #f55; border: 1px solid #f00; padding: 5px; font-size: 0.8rem; border-radius: 4px; margin-top: 5px; text-align: center; }

  /* SOUL STATUS */
  .soul-badge { cursor: help; transition: 0.3s; font-weight: bold; border: 1px solid; }
  .soul-stable { border-color: var(--integridade); color: var(--integridade); }
  .soul-damaged { border-color: #f4d35e; color: #f4d35e; }
  .soul-unstable { border-color: #fb8500; color: #fb8500; border-width: 2px; }
  .soul-critical { border-color: #d00000; color: #d00000; border-width: 2px; animation: pulse-red 2s infinite; background: rgba(255,0,0,0.1); }
  .soul-dead { border-color: #555; color: #555; text-decoration: line-through; } 
  .soul-badge:hover::after { content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #222; color: #fff; padding: 8px; border-radius: 5px; border: 1px solid #555; width: 200px; font-size: 0.75rem; font-weight: normal; z-index: 100; pointer-events: none; margin-bottom: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); text-align: center; }
  @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); } }
  
  /* TOKENS */
  .shiki-container { display: flex; justify-content: center; gap: 8px; margin-top: 15px; flex-wrap: wrap; border-top: 1px solid #222; padding-top: 15px; }
  .shiki-token { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--energy); background: #000; object-fit: cover; cursor: pointer; transition: transform 0.2s; }
  .shiki-add { width: 40px; height: 40px; border-radius: 50%; border: 2px dashed #444; display: flex; align-items: center; justify-content: center; color: #555; cursor: pointer; font-size: 1.2rem; transition: 0.2s; }
  .shiki-add:hover { border-color: var(--energy); color: var(--energy); }

  /* UTILS */
  .editable { cursor: pointer; border-bottom: 1px dashed #555; display: inline-block; min-width: 20px; text-align: center; }
  .inline-input { background: #000; color: white; border: 2px solid var(--primary); border-radius: 4px; padding: 4px; font-family: inherit; font-size: inherit; width: 80px; text-align: center; outline: none; }
  .math-input { width: 40px; background: #fff; color: #000; border: none; border-radius: 3px; text-align: center; font-weight: bold; outline: none; }
  .btn-mini { background: #222; border: 1px solid #444; color: #ccc; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
  .btn-calc { background: #222; border: 1px solid #555; color: #ccc; width: 50px; height: 30px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-right: auto; }

  /* ATRIBUTOS & BARRAS */
  .attr-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .attr-box { background: #222; padding: 8px; border-radius: 6px; text-align: center; border: 1px solid #333; }
  .attr-lbl { font-size: 0.7rem; color: var(--dim); display: block; font-weight: bold; }
  .attr-val { font-size: 1.4rem; font-weight: bold; display: block; margin: 2px 0; color: var(--text); }
  .attr-raw { font-size: 0.8rem; color: #777; background: #111; padding: 2px 6px; border-radius: 3px; }
  .stat-row { margin-bottom: 12px; }
  .stat-head { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 4px; color: #ddd; font-weight: bold; }
  .bar-bg { background: #333; height: 10px; border-radius: 5px; overflow: hidden; }
  .bar-fill { height: 100%; transition: width 0.3s; }
  .stat-ctrl { display: flex; justify-content: flex-end; gap: 5px; margin-top: 4px; }

  /* COMBATE */
  .section-header { background: #111; color: var(--primary); padding: 8px; text-align: center; border: 1px solid #333; border-radius: 5px; margin: 0 0 10px 0; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition:0.2s; }
  .section-header:hover { background: #222; }
  .combat-grid { display: grid; gap: 10px; margin-bottom: 20px; } .cols-3 { grid-template-columns: repeat(3, 1fr); } .cols-5 { grid-template-columns: repeat(5, 1fr); }
  .combat-card { background: #1a1a1a; border: 1px solid var(--primary); border-radius: 6px; display: flex; flex-direction: column; overflow: hidden; text-align: center; }
  .cc-header { background: var(--primary); color: white; padding: 5px; font-size: 0.75rem; font-weight: bold; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 35px; }
  .cc-body { padding: 10px 0; font-size: 1.8rem; font-weight: bold; color: white; flex-grow: 1; background: #1a1a1a; }
  .cc-footer { background: #000; padding: 5px; display: flex; justify-content: center; align-items: center; gap: 5px; border-top: 1px solid #333; }
  .btn-toggle-attr { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.5); color: white; font-size: 0.6rem; padding: 1px 4px; border-radius: 3px; cursor: pointer; margin-top: 2px; }
  .bonus-input { background: #222; border: 1px solid #444; color: #aaa; width: 30px; text-align: center; padding: 2px; border-radius: 4px; font-size: 0.8rem; }
  .btn-train { width: 20px; height: 20px; border: 1px solid #444; background: #222; color: #666; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; border-radius: 3px; cursor: pointer; font-weight: bold; }
  .btn-train.active { background: var(--energy); border-color: var(--energy); color: #000; }
  select.mini-select { background: rgba(0,0,0,0.3); border: none; color: white; font-size: 0.6rem; max-width: 80px; margin-top: 2px; }
  select.mini-select option { background: #222; color: #fff; }

  /* VALORES ADICIONAIS */
  .derived-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .derived-box { background: #1a1a1a; border: 1px solid #333; border-radius: 6px; padding: 10px; text-align: center; }
  .derived-label { font-size: 0.7rem; color: var(--energy); font-weight: bold; text-transform: uppercase; margin-bottom: 5px; }
  .derived-value { font-size: 1.6rem; font-weight: bold; color: #fff; }
  .derived-calc { display: flex; justify-content: center; margin-top: 5px; }
  .derived-calc input { background: #111; border: 1px solid #444; color: #aaa; width: 40px; text-align: center; border-radius: 3px; font-size: 0.8rem; }

  /* HABILIDADES DE CLASSE */
  .toggle-body { display: none; } .toggle-body.open { display: block; animation: slideDown 0.3s ease-out; }
  @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
  .ability-select-btn { background: #1a1a1a; color: #aaa; border: 2px dashed #444; width: 100%; padding: 12px; font-weight: bold; cursor: pointer; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; transition: 0.2s; }
  .ability-select-btn:hover { background: #222; border-color: var(--primary); color: var(--primary); }
  .ability-card-display { background: #151515; border-left: 4px solid var(--primary); border-radius: 4px; padding: 15px; margin-bottom: 10px; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
  .ability-card-title { font-weight: bold; color: #fff; font-size: 1rem; margin-bottom: 5px; text-transform: uppercase; }
  .ability-card-desc { font-size: 0.9rem; color: #aaa; white-space: pre-wrap; line-height: 1.5; }
  .btn-remove-ability { position: absolute; top: 5px; right: 5px; background: transparent; border: none; color: #666; cursor: pointer; font-size: 1rem; transition: 0.2s; }
  .btn-remove-ability:hover { color: #d00000; }
  .class-ability-box { border-left: 4px solid var(--vigor); padding: 10px; background: #151515; margin-bottom: 10px; border-radius: 4px; }
  .class-ability-name { font-weight: bold; color: #fff; font-size: 0.95rem; display: flex; justify-content: space-between; align-items: center; }
  .class-ability-desc { font-size: 0.85rem; color: #aaa; margin-top: 5px; white-space: pre-wrap; line-height: 1.4; }
  .btn-add-origin { width: 100%; border: 1px dashed #555; background: transparent; color: #666; padding: 8px; cursor: pointer; margin-top: 5px; border-radius: 5px; }
  .btn-icon-tiny { background: transparent; border: none; color: #666; cursor: pointer; font-size: 1rem; margin-left: 10px; }
  .btn-icon-tiny:hover { color: white; }

  /* INVENT√ÅRIO */
  .inv-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
  .inv-card { background: #1a1a1a; border: 1px solid #444; border-radius: 6px; overflow: hidden; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; }
  .inv-row { background: var(--inv-bg); border-radius: 4px; overflow: hidden; border: 1px solid #333; transition: 0.2s; }
  .inv-row:hover { border-color: #555; }
  .inv-summary { padding: 10px; display: flex; align-items: center; cursor: pointer; justify-content: space-between; }
  .inv-check { width: 18px; height: 18px; border: 2px solid #444; border-radius: 3px; display: flex; align-items: center; justify-content: center; margin-right: 10px; color: transparent; font-size: 0.8rem; }
  .inv-check.equipped { border-color: var(--primary); background: rgba(230, 57, 70, 0.2); color: var(--primary); }
  .inv-main-info { flex-grow: 1; display: flex; flex-direction: column; }
  .inv-name { font-weight: bold; color: white; font-size: 0.95rem; }
  .inv-mini-stats { font-size: 0.75rem; color: #999; display: flex; gap: 10px; }
  .inv-mini-stats span b { color: var(--primary); }
  .inv-expand-icon { color: #555; font-size: 0.8rem; margin-left: 10px; transition: 0.3s; transform: rotate(0deg); }
  .inv-row.expanded .inv-expand-icon { transform: rotate(180deg); }
  .inv-details { display: none; padding: 15px; background: #151515; border-top: 1px solid #333; grid-template-columns: 1fr 80px; gap: 15px; }
  .inv-row.expanded .inv-details { display: grid; }
  .inv-stat-block { display: flex; flex-direction: column; gap: 4px; font-size: 0.85rem; color: #ccc; }
  .inv-stat-line { display: flex; justify-content: space-between; border-bottom: 1px solid #222; padding-bottom: 2px; }
  .inv-stat-label { color: var(--primary); font-weight: bold; }
  .inv-img-preview { width: 80px; height: 80px; object-fit: cover; border: 1px solid #444; background: #000; border-radius: 4px; }
  .inv-actions { grid-column: span 2; display: flex; justify-content: space-between; margin-top: 10px; border-top: 1px solid #333; padding-top: 10px; }
  .btn-txt-del { color: #d00000; background: transparent; border: none; cursor: pointer; font-size: 0.8rem; }
  .btn-txt-edit { color: #ccc; background: transparent; border: none; cursor: pointer; font-size: 0.8rem; }
  .inv-load-display { text-align: right; font-size: 0.8rem; color: #aaa; margin-bottom: 5px; }
  .load-num { background: #111; border: 1px solid #333; padding: 2px 6px; color: white; font-weight: bold; border-radius: 3px; margin: 0 2px; }
  .load-bar-container { background: #111; border: 1px solid #333; border-radius: 5px; height: 10px; position: relative; margin-bottom: 15px; overflow: hidden; }
  .load-fill { height: 100%; width: 0%; background: #444; transition: 0.3s; }
  .load-fill.over { background: #e63946; }
  .overburden-warning { color: #e63946; font-size: 0.8rem; text-align: center; display: none; margin-top: -10px; margin-bottom: 10px; font-weight: bold; }
  .inv-categories { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 10px; scrollbar-width: none; }
  .inv-cat-btn { background: #111; border: 1px solid #333; color: #888; padding: 4px 10px; border-radius: 15px; cursor: pointer; font-size: 0.8rem; white-space: nowrap; }
  .inv-cat-btn.active { border-color: var(--primary); color: var(--primary); background: rgba(230, 57, 70, 0.1); }
  .inv-header-controls { display: flex; gap: 10px; margin-bottom: 10px; }
  .inv-search { flex-grow: 1; background: #000; border: 1px solid #333; color: white; padding: 8px; border-radius: 4px; outline: none; }
  .btn-add-inv { background: var(--primary); color: white; border: none; width: 35px; height: 35px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }

  /* APTID√ïES */
  .aptidao-box { margin-bottom: 10px; border: 1px solid #333; border-radius: 6px; overflow: hidden; }
  .aptidao-header { background: #222; padding: 10px; font-weight: bold; color: var(--energy); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
  .aptidao-body { display: none; padding: 10px; background: #151515; }
  .aptidao-body.open { display: block; }
  .aptidao-desc { font-style: italic; color: #aaa; margin-bottom: 15px; font-size: 0.9rem; border-bottom: 1px solid #333; padding-bottom: 10px; white-space: pre-wrap; }
  .nivel-row { display: flex; align-items: flex-start; padding: 5px 0; border-bottom: 1px solid #222; font-size: 0.9rem; color: #555; }
  .nivel-row.unlocked { color: #fff; } 
  .nivel-check { width: 15px; height: 15px; border: 1px solid #444; border-radius: 50%; margin-right: 10px; margin-top: 2px; flex-shrink: 0; }
  .unlocked .nivel-check { background: var(--energy); border-color: var(--energy); box-shadow: 0 0 5px var(--energy); }

  /* PER√çCIAS */
  .skills-card { padding: 0; overflow: hidden; height: 100%; }
  .skills-header { padding: 15px; background: #222; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
  .skill-row { display: flex; align-items: center; padding: 4px 10px; border-bottom: 1px solid #222; font-size: 0.8rem; cursor: pointer; }
  .skill-row:hover { background: #1b1b1b; }
  .sk-name { flex-grow: 1; color: #999; font-weight: 500; }
  .sk-attr { font-size: 0.65rem; color: #444; width: 30px; text-transform: uppercase; font-weight: bold; }
  .sk-total { font-weight: bold; color: white; width: 30px; text-align: right; margin-right: 10px; font-size: 0.9rem; }
  .sk-btn-group { display: flex; gap: 3px; align-items: center; }
  .sk-btn { width: 20px; height: 20px; border-radius: 3px; border: 1px solid #333; background: #111; color: #555; font-size: 0.6rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
  .sk-btn:hover { border-color: #777; color: #aaa; }
  .sk-btn.active-t { background: rgba(88, 232, 218, 0.1); border-color: var(--energy); color: var(--energy); }
  .sk-btn.active-m { background: rgba(230, 57, 70, 0.1); border-color: var(--primary); color: var(--primary); }

  .btn-nav { background: transparent; width: 100%; padding: 10px; font-size: 1rem; cursor: pointer; border-radius: 5px; font-weight: bold; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 5px; border: 1px solid #444; color: #aaa; }
  .btn-summon { border-color: var(--integridade); color: var(--integridade); } .btn-summon:hover { background: var(--integridade); color: #000; }
  .btn-tech { border-color: var(--energy); color: var(--energy); } .btn-tech:hover { background: var(--energy); color: #000; }
  .btn-icon-sm { background: transparent; border: 1px solid #444; color: #888; width: 24px; height: 24px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; line-height: 1; transition: 0.2s; }
  .btn-icon-sm:hover { border-color: var(--primary); color: var(--primary); }

  /* MODALS */
  .fab-config { position: fixed; bottom: 20px; right: 20px; background: #222; color: white; border: 2px solid #555; width: 50px; height: 50px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.6); z-index: 100; transition: 0.2s; }
  .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; padding: 20px; overflow-y: auto; }
  .modal-content { background: var(--card); padding: 20px; border-radius: 10px; max-width: 600px; margin: 20px auto; border: 1px solid #444; }
  .form-group { margin-bottom: 15px; }
  .form-group label { display: block; color: #aaa; margin-bottom: 5px; font-size: 0.8rem; font-weight: bold; }
  input, textarea, select { width: 100%; background: #000; border: 1px solid #333; color: white; padding: 8px; border-radius: 4px; outline: none; box-sizing: border-box; font-family: inherit; }
  textarea { height: 80px; resize: vertical; }
  .list-adder { margin-top: 10px; border-top: 1px solid #333; padding-top: 10px; }
  .dynamic-list-item { background: #111; padding: 8px; margin-bottom: 5px; border-radius: 4px; display: flex; gap: 10px; align-items: flex-start; }
  .btn-del-item { background: transparent; border: none; color: #d00000; cursor: pointer; font-size: 1.2rem; line-height: 1; }
  .btn-add-item { background: #222; border: 1px solid #444; color: #ccc; width: 100%; padding: 5px; cursor: pointer; margin-top: 5px; }
  .gm-controls { display: none; margin-left: auto; gap: 5px; } 
  .gm-visible .gm-controls { display: flex; }
  .btn-gm { background: #333; border: 1px solid #555; color: #fff; width: 20px; height: 20px; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 3px; }
  .btn-edit-apt { background: transparent; border: none; color: #666; cursor: pointer; font-size: 0.9rem; margin-left: 10px; }
  .sel-option { background: #111; padding: 10px; border-bottom: 1px solid #333; cursor: pointer; transition: 0.2s; }
  .sel-option:hover { background: #1a1a1a; border-left: 3px solid var(--primary); }
  .sel-title { font-weight: bold; color: white; font-size: 1rem; }
  .sel-desc { color: #aaa; font-size: 0.85rem; margin-top: 2px; }
</style>
</head>
<body>

<div class="main-layout">
  <div class="col-side">
    <div class="card char-header">
      <div class="transf-container">
        <div id="btnApice" class="transf-btn apice locked" title="√Åpice Humano" onclick="toggleTransformacao('apice')">‚ö°</div>
        <div id="btnCorpo" class="transf-btn corpo locked" title="Corpo Amaldi√ßoado" onclick="toggleTransformacao('corpo')">üëπ</div>
      </div>
      <div id="statusSequela"></div>
      <img id="charImg" class="char-img" src="">
      <h2 class="char-name"><span class="editable" id="nomeDisplay" onclick="editarCampo(this, 'nome', 'text')">...</span></h2>
      <div id="badges" class="badges"></div>
      <div id="shikiTokens" class="shiki-container"></div>
    </div>
    <div class="card"><div id="atributosArea" class="attr-grid"></div><p style="text-align:center;font-size:0.7rem;color:#666;margin:0;">Clique para editar</p></div>
    <div class="card"><div id="statsArea"></div></div>
    <button class="btn-nav btn-summon" onclick="irParaShikigamis()">üê∫ Invoca√ß√µes</button>
    <button class="btn-nav btn-tech" onclick="irParaFeiticos()">‚ö° T√©cnicas & Artes</button>
    <button class="btn-mini" style="width:100%; padding:10px; font-size:1rem; margin-top:10px;" onclick="window.location='index.html'">Voltar para Lista</button>
  </div>

  <div class="col-center">
    <div class="card" style="padding:10px;">
      <h3 class="section-header">Jogadas de Ataque</h3>
      <div id="combatAttacksArea" class="combat-grid cols-3"></div>
      <h3 class="section-header" style="margin-top:20px;">Testes de Resist√™ncia</h3>
      <div id="combatResistArea" class="combat-grid cols-5"></div>
    </div>

    <div class="card">
      <h3 class="section-header" style="margin-bottom:10px; cursor:pointer;" onclick="document.getElementById('classOriginBody').classList.toggle('open')">
        Habilidades de Classe & Origem <span style="float:right; font-size:0.8rem;">‚ñº</span>
      </h3>
      <div id="classOriginBody" class="toggle-body">
        <div id="classAbilitiesList"></div>
        <hr style="border-color:#222; margin:15px 0;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h4 style="margin:0; color:var(--vigor); font-size:0.9rem;">Origem e Especializa√ß√µes</h4>
            <button class="btn-icon-tiny" onclick="abrirModalOrigem()">+</button>
        </div>
        <div id="originAbilitiesList" style="margin-top:10px;"></div>
      </div>
    </div>
    
    <div style="text-align:right; margin-bottom:5px;">
       <button class="btn-mini" onclick="abrirClassManager()" style="font-size:0.8rem; width:auto; padding:0 8px;">Gerenciar Classes</button>
    </div>

    <div class="card">
      <div class="section-header" style="display:flex; justify-content:space-between; align-items:center; background:#111;">
        <span style="flex-grow:1; text-align:center;">Invent√°rio</span>
        <button class="btn-add-inv" onclick="abrirItemModal()">+</button>
      </div>
      <div class="inv-header-controls">
        <input type="text" id="invSearch" class="inv-search" placeholder="Filtrar..." onkeyup="renderInventario()">
      </div>
      <div class="inv-load-display">CARGA <span id="loadVal" class="load-num">0</span> / <span id="loadMax" class="load-num">20</span></div>
      <div class="load-bar-container"><div id="loadFill" class="load-fill"></div></div>
      <div id="overburdenMsg" class="overburden-warning">‚ö† SOBRECARREGADO</div>
      
      <div class="inv-categories">
        <button class="inv-cat-btn active" onclick="filtrarInv('todos', this)">Todos</button>
        <button class="inv-cat-btn" onclick="filtrarInv('Arma', this)">Arma</button>
        <button class="inv-cat-btn" onclick="filtrarInv('Prote√ß√£o', this)">Prote√ß√£o</button>
        <button class="inv-cat-btn" onclick="filtrarInv('Muni√ß√£o', this)">Muni√ß√£o</button>
        <button class="inv-cat-btn" onclick="filtrarInv('Geral', this)">Geral</button>
        <button class="inv-cat-btn" onclick="filtrarInv('Item Amald.', this)">Item Amald.</button>
      </div>
      <div id="inventoryList" class="inv-list"></div>
    </div>
    
    <div class="card" id="aptidoesCard">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h3 class="section-header" style="width:100%; margin:0;">Aptid√µes & Evolu√ß√£o</h3>
        <div id="gmControlsMain" style="display:none; gap:5px;">
          <button class="btn-mini" style="width:auto; padding:0 8px; font-size:0.7rem; border-color:var(--apice); color:var(--apice);" onclick="gmUnlock('apice')">Unlock √Åpice</button>
          <button class="btn-mini" style="width:auto; padding:0 8px; font-size:0.7rem; border-color:var(--corpo); color:var(--corpo);" onclick="gmUnlock('corpo')">Unlock Corpo</button>
          <button class="btn-mini" style="width:auto; padding:0 8px; font-size:0.7rem; border-color:#0f0; color:#0f0;" onclick="gmClearDebuff()">Curar Sequelas</button>
          <button class="btn-mini" style="width:auto; padding:0 8px;" onclick="addNovaAptidao()">+</button>
        </div>
      </div>
      <div id="listaAptidoes"></div>
    </div>
  </div>

  <div class="col-right">
    <div class="card">
      <h3 class="section-header" style="margin-bottom:10px;">Valores Adicionais</h3>
      <div class="derived-grid">
        <div class="derived-box"><div class="derived-label">DEFESA</div><div class="derived-value" id="valDefesa">10</div><div class="derived-calc"><input id="bonusDef" class="derived-calc input" placeholder="B√¥nus" onchange="setDerivadoBonus('defesa', this.value)"></div></div>
        <div class="derived-box"><div class="derived-label">ATEN√á√ÉO</div><div class="derived-value" id="valAtencao">10</div><div class="derived-calc"><input id="bonusAtencao" class="derived-calc input" placeholder="B√¥nus" onchange="setDerivadoBonus('atencao', this.value)"></div></div>
        <div class="derived-box"><div class="derived-label">INICIATIVA</div><div class="derived-value" id="valIniciativa">+0</div><div class="derived-calc"><input id="bonusIniciativa" class="derived-calc input" placeholder="B√¥nus" onchange="setDerivadoBonus('iniciativa', this.value)"></div></div>
        <div class="derived-box"><div class="derived-label">DESLOC.</div><div class="derived-value" id="valDesloc">9m</div><div class="derived-calc"><input id="bonusDesloc" class="derived-calc input" placeholder="B√¥nus" onchange="setDerivadoBonus('deslocamento', this.value)"></div></div>
      </div>
    </div>

    <div class="card skills-card">
      <div class="skills-header" style="padding-top:0;">
        <h3 style="margin-bottom:5px;">Per√≠cias</h3>
      </div>
      <div id="skillsList"></div>
    </div>
  </div>
</div>

<button class="fab-config" onclick="abrirConfig()">‚öôÔ∏è</button>

<div id="selectionModal" class="modal"><div class="modal-content"><h2 id="selectTitle" style="color:var(--primary);">Escolha</h2><div id="selectorFilters" style="margin-bottom:10px; display:flex; gap:5px; flex-wrap:wrap;"></div><div id="selectOptionsList" style="display:flex; flex-direction:column; gap:5px; max-height:60vh; overflow-y:auto;"></div><button onclick="document.getElementById('selectionModal').style.display='none'" style="background:#333; width:100%; padding:10px; color:white; border:none; cursor:pointer; margin-top:15px;">Cancelar</button></div></div>

<div id="configModal" class="modal"><div class="modal-content"><h2 style="color:var(--primary);">Configura√ß√µes</h2><label>Imagem (URL)</label><input id="editImgUrl" style="margin-bottom:15px;"><button onclick="salvarImg()" style="background:#333; color:white; border:none; padding:5px; width:100%;">Atualizar Imagem</button><br><br><button onclick="document.getElementById('configModal').style.display='none'" style="background:#333; width:100%; padding:10px; color:white; border:none; cursor:pointer;">Fechar</button><button onclick="excluirPersonagem()" style="background:transparent; color:#d00000; border:none; width:100%; margin-top:15px; cursor:pointer;">Excluir Personagem</button></div></div>

<div id="itemModal" class="modal">
  <div class="modal-content">
    <h2 id="itemModalTitle" style="color:var(--primary);">Novo Item</h2>
    <button onclick="abrirSeletor('item')" style="width:100%; background:#222; border:1px dashed var(--energy); color:var(--energy); padding:10px; margin-bottom:15px; cursor:pointer; font-weight:bold;">üìö Selecionar Item Pronto</button>

    <div style="display:grid; grid-template-columns: 2fr 1fr; gap:10px;">
      <div class="form-group"><label>Nome</label><input id="itNome"></div>
      <div class="form-group"><label>Tipo</label>
        <select id="itTipo">
          <option value="Arma">Arma</option>
          <option value="Prote√ß√£o">Prote√ß√£o</option>
          <option value="Muni√ß√£o">Muni√ß√£o</option>
          <option value="Geral">Geral</option>
          <option value="Item Amald.">Item Amald.</option>
        </select>
      </div>
    </div>
    
    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
      <div class="form-group"><label>Grau</label><select id="itGrau"><option value="4">Grau 4</option><option value="3">Grau 3</option><option value="2">Grau 2</option><option value="1">Grau 1</option><option value="0">Especial</option></select></div>
      <div class="form-group"><label>Espa√ßos</label><input type="number" id="itEspacos" value="1"></div>
      <div class="form-group"><label>B√¥nus</label><input id="itBonus" placeholder="+2 CA"></div>
    </div>

    <div class="form-group" style="border:1px solid #333; padding:10px; border-radius:4px; background:#111;">
      <label style="color:var(--primary);">Status de Combate (Opcional)</label>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:5px;">
         <input id="itDano" placeholder="Dano (ex: 1d12)">
         <input id="itCritico" placeholder="Cr√≠tico (ex: x3)">
      </div>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:5px;">
         <input id="itAlcance" placeholder="Alcance">
         <input id="itTipoDano" placeholder="Tipo de Dano">
      </div>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
         <select id="itTipoAtaque">
             <option value="">-- Tipo de Ataque --</option>
             <option value="Corpo a Corpo">Corpo a Corpo</option>
             <option value="Dist√¢ncia">Dist√¢ncia</option>
             <option value="Amaldi√ßoado">Amaldi√ßoado</option>
         </select>
         <input id="itAtributo" placeholder="Atributo (For√ßa)">
      </div>
      <div class="form-group" style="margin-top:5px;">
        <label>Ataque B√¥nus</label><input type="number" id="itAtkBonus" placeholder="0">
      </div>
    </div>

    <div class="form-group"><label>Imagem (URL)</label><input id="itImg" placeholder="http://..."></div>
    <div class="form-group"><label>Descri√ß√£o Geral</label><textarea id="itDesc" style="height:60px;"></textarea></div>
    
    <div class="list-adder">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <label>Propriedades</label>
        <button class="btn-mini" onclick="abrirSeletor('propriedade')" style="width:auto; padding:2px 8px;">üìö Escolher</button>
      </div>
      <div id="propList"></div>
      <button class="btn-add-item" onclick="addPropField()">+ Manual</button>
    </div>

    <div class="list-adder">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <label>Encantamentos</label>
        <button class="btn-mini" onclick="abrirSeletor('encantamento')" style="width:auto; padding:2px 8px;">üìö Escolher</button>
      </div>
      <div id="encantList"></div>
      <button class="btn-add-item" onclick="addEncantField()">+ Manual</button>
    </div>

    <div style="display:flex; gap:10px; margin-top:20px;">
      <button onclick="salvarItem()" style="background:var(--primary); flex-grow:1; padding:10px; border:none; color:white; cursor:pointer;">Salvar Item</button>
      <button onclick="excluirItem()" id="btnExcluirItem" style="background:transparent; border:1px solid #d00000; color:#d00000; padding:10px; cursor:pointer; display:none;">Excluir</button>
    </div>
    <button onclick="document.getElementById('itemModal').style.display='none'" style="background:#333; width:100%; padding:10px; margin-top:5px; border:none; color:white; cursor:pointer;">Cancelar</button>
  </div>
</div>

<div id="aptidaoEditorModal" class="modal"><div class="modal-content"><h2 style="color:var(--energy);">Editor de Aptid√£o</h2><div class="form-group"><label>Nome da Aptid√£o</label><input id="editAptNome"></div><div class="form-group"><label>Descri√ß√£o Geral</label><textarea id="editAptDesc" style="height:80px;"></textarea></div><div class="form-group"><label>N√≠vel M√°ximo (0 = Passiva)</label><input type="number" id="editAptMax" min="0" max="20" onchange="renderLevelInputs()"></div><div id="editAptLevelsContainer" style="margin-top:10px; display:flex; flex-direction:column; gap:5px;"></div><div style="display:flex; gap:10px; margin-top:20px;"><button onclick="salvarAptidaoCustom()" style="background:var(--energy); flex-grow:1; padding:10px; border:none; color:#000; cursor:pointer; font-weight:bold;">Salvar</button><button onclick="excluirAptidaoCustom()" id="btnExcluirApt" style="background:transparent; border:1px solid #d00000; color:#d00000; padding:10px; cursor:pointer;">Excluir</button></div><button onclick="document.getElementById('aptidaoEditorModal').style.display='none'" style="background:#333; width:100%; padding:10px; margin-top:5px; border:none; color:white; cursor:pointer;">Cancelar</button></div></div>
<div id="origemModal" class="modal"><div class="modal-content"><h2 id="origemModalTitle" style="color:var(--vigor);">Nova Habilidade de Origem</h2><div class="form-group"><label>Nome</label><input id="origemNome"></div><div class="form-group"><label>Descri√ß√£o</label><textarea id="origemDesc" style="height:150px;"></textarea></div><div style="display:flex; gap:10px; margin-top:20px;"><button onclick="salvarOrigem()" style="background:var(--vigor); flex-grow:1; padding:10px; border:none; color:#000; cursor:pointer; font-weight:bold;">Salvar</button></div><button onclick="document.getElementById('origemModal').style.display='none'" style="background:#333; width:100%; padding:10px; margin-top:5px; border:none; color:white; cursor:pointer;">Cancelar</button></div></div>
<div id="classManagerModal" class="modal"><div class="modal-content"><h2 style="color:var(--primary);">Gerenciar Classes</h2><div id="currentClassesList" style="margin-bottom:20px;"></div><div style="border-top:1px solid #333; padding-top:10px;"><label>Adicionar Nova Classe</label><div style="display:flex; gap:10px;"><select id="newClassSelect" style="flex-grow:1;"></select><button onclick="adicionarClasse()" style="background:var(--primary); border:none; color:white; padding:5px 10px; cursor:pointer;">Adicionar</button></div></div><button onclick="document.getElementById('classManagerModal').style.display='none'" style="background:#333; width:100%; padding:10px; margin-top:15px; border:none; color:white; cursor:pointer;">Fechar</button></div></div>

<script type="module">
// BANCOS DE DADOS (EMBUTIDOS)
// ========================================================

// 1. APTID√ïES
const APTIDOES_BASE = [
  { nome: "Libera√ß√£o de Energia", descricao: "Voc√™ aprende o b√°sico do uso de Energia. Sua aura passa a se manifestar como um vapor quente saindo do seu corpo. Voc√™ pode gastar at√© seu Limite de PE por turno, que cresce conforme o n√≠vel.", maxNivel: 10, niveis: ["NV 1 - Limite de PE por turno: +1", "NV 2 - Limite de PE por turno: +1", "NV 3 - Ganha 1 Caracter√≠stica √önica de Aura", "NV 4 - Limite de PE por turno: +1", "NV 5 - Limite de PE por turno: +1", "NV 6 - Ganha 1 Caracter√≠stica √önica de Aura", "NV 7 - Limite de PE por turno: +1", "NV 8 - Limite de PE por turno: +1", "NV 9 - Ganha 1 Caracter√≠stica √önica de Aura", "NV 10 - Sua aura fica completamente estabilizada. N√£o gasta mais 1 PE por turno para manter aura ativa. Ganha 1 Caracter√≠stica √önica Especial, exclusiva do seu personagem. Limite de PE por turno: +1"] },
  { nome: "Prote√ß√£o", descricao: "Voc√™ aprende a manter a aura no seu corpo, protegendo-se.", maxNivel: 8, niveis: ["NV 1 - +1 Redu√ß√£o de Dano.", "NV 2 - +1 Redu√ß√£o, +1 Dano.", "NV 3 - +1 Redu√ß√£o, +1 Dano.", "NV 4 - +2 Redu√ß√£o, +2 Dano. Custo: 2 PE/turno.", "NV 5 - +2 Redu√ß√£o, +2 Dano.", "NV 6 - Redu√ß√£o 1+X, Dano X (X=Metade Treino). Custo: 3 PE/turno.", "NV 7 - Redu√ß√£o Y+X, Dano Y+X. Custo: 4 PE/turno.", "NV 8 - Resist√™ncia F√≠sica, Dano X+Y. Custo: 5 PE/turno."] },
  { nome: "Proje√ß√£o", descricao: "Voc√™ aprende a projetar sua aura para ataques.", maxNivel: 5, niveis: ["NV 1 - Ataque 1d8. Cr√≠tico 20.", "NV 2 - Soma Atributo Mental. Imbuir objeto (+1d6).", "NV 3 - Soma Treinamento. Dano 1d10. Imbuir (+1d8+Mental). Custo 2 PE.", "NV 4 - Dano 2d8. Ignora RD (Treino). Imbuir (+2d6+Mental). Custo 3 PE.", "NV 5 - Dano 3d10. Ignora RD (Treino+Mental). Imbuir (+3d8+Mental). Custo 4 PE."] },
  { nome: "Cria√ß√£o", descricao: "Voc√™ pode criar coisas feitas de energia.", maxNivel: 5, niveis: ["NV 1 - Paredes 1x1. Vida = Metade N√≠vel x Treino. Custo 1 PE.", "NV 2 - Soma Atributo Mental na Vida.", "NV 3 - Paredes 3x3, formatos vari√°veis. Custo 2 PE.", "NV 4 - Vida = N√≠vel x Treino + Mental. Male√°veis.", "NV 5 - Vida = N√≠vel x Treino + 2x Mental. Imune ao 1¬∫ ataque. Custo 4 PE."] },
  { nome: "Concentra√ß√£o", descricao: "Foca energia para aumentar o dano.", maxNivel: 5, niveis: ["NV 1 - Aumenta dado de dano em 1 n√≠vel. Custo 2 PE.", "NV 2 - Soma modificador do maior atributo.", "NV 3 - +1 dado adicional no dano. Custo 3 PE.", "NV 4 - Aumenta dado em 2 n√≠veis. Custo 4 PE.", "NV 5 - Maximiza dados (qtd igual Treinamento). Custo 5 PE."] },
  { nome: "Transforma√ß√£o", descricao: "Altera propriedades da aura.", maxNivel: 5, niveis: ["NV 1 - L√≠quida (+1 CA/Ref), S√≥lida (+1 RD/Fort), Gasosa (+1 Dano/Integ).", "NV 2 - B√¥nus aumenta para +2.", "NV 3 - B√¥nus aumenta para +3. Custo 3 PE/turno.", "NV 4 - B√¥nus aumenta para +4.", "NV 5 - Estado M√°ximo. Custo 4 PE/turno."] },
  { nome: "Aura Elemental", descricao: "Imbui aura com elementos naturais.", maxNivel: 5, niveis: ["NV 1 - Mudar tipo de dano.", "NV 2 - Transformar objeto. +1d6 dano.", "NV 3 - Transformar aura do alvo.", "NV 4 - Elemento passivo.", "NV 5 - Causa 2d10 + Mental de dano."] },
  { nome: "Molde", descricao: "Esculpe energia em formas complexas.", maxNivel: 5, niveis: ["NV 1 - Moldar 1x1.", "NV 2 - +1 Vida.", "NV 3 - Moldar 3x3.", "NV 4 - Mecanismos.", "NV 5 - Caracter√≠stica extra."] },
  { nome: "Intensifica√ß√£o", descricao: "Comprime energia para efeitos mais potentes.", maxNivel: 5, niveis: ["NV 1 - +1 Dano/Defesa.", "NV 2 - +2 Dano/Defesa.", "NV 3 - +1 + Metade Treino.", "NV 4 - +1 N√≠vel Dano.", "NV 5 - Dano B√¥nus X+Y."] },
  { nome: "Solidifica√ß√£o", descricao: "Compacta aura como armadura.", maxNivel: 5, niveis: ["NV 1 - +1 Redu√ß√£o.", "NV 2 - +2 Redu√ß√£o.", "NV 3 - Redu√ß√£o 1+X.", "NV 4 - Redu√ß√£o Y+X.", "NV 5 - Res. F√≠sica e Dano X+Y."] },
  { nome: "Encasular", descricao: "Cria bolhas para prender ou proteger.", maxNivel: 5, niveis: ["NV 1 - Bolha 1x1.", "NV 2 - Bolha ganha HP.", "NV 3 - Dano peri√≥dico.", "NV 4 - M√∫ltiplos alvos.", "NV 5 - Quase impenetr√°vel."] },
  { nome: "Redirecionar", descricao: "Manipula a dire√ß√£o de ataques.", maxNivel: 5, niveis: ["NV 1 - Curvar ataque.", "NV 2 - Redirecionar proj√©teis.", "NV 3 - Redirecionar √°rea.", "NV 4 - N√≥s de redirecionamento.", "NV 5 - Refletir habilidade."] },
  { nome: "Esconder", descricao: "Oculta a aura.", maxNivel: 5, niveis: ["NV 1 - Indetect√°vel.", "NV 2 - Isca falsa.", "NV 3 - Oculta√ß√£o completa.", "NV 4 - Mascarar grupo.", "NV 5 - Indetect√°vel total."] },
  { nome: "Perturba√ß√£o", descricao: "Interfere na energia alheia.", maxNivel: 5, niveis: ["NV 1 - Alvo -1 testes.", "NV 2 - Teste Vontade.", "NV 3 - Zona perturba√ß√£o.", "NV 4 - Interromper recarga.", "NV 5 - Anular habilidade."] },
  { nome: "Infestar", descricao: "Impregnar √°reas/objetos/v√≠timas com part√≠culas de aura.", maxNivel: 3, niveis: ["NV 1 - Semente: Dano 1d4, -1 testes.", "NV 2 - Praga: √Årea, espalha.", "NV 3 - Fetidez: Drenagem de Energia, Vulnerabilidade."] },
  { nome: "Destruir", descricao: "Ataque concentrado para aniquilar mat√©ria/estruturas.", maxNivel: 3, niveis: ["NV 1 - Rasgar: 3d6+Mental. Dano em objetos.", "NV 2 - Praga: √Årea c√¥nica 3m, 4d8.", "NV 3 - Expurgar: 6d10, destro√ßa estruturas."] },
  { nome: "Torturar", descricao: "Dano direto e cont√≠nuo que foca em corroer.", maxNivel: 3, niveis: ["NV 1 - Dor: 2d6, penalidade f√≠sica.", "NV 2 - Cativeiro: 3d8, drena energia.", "NV 3 - Flagelo: 4d10, paralisia parcial."] },
  { nome: "Assombrar", descricao: "Impregnar aura em objetos ou corpos.", maxNivel: 3, niveis: ["NV 1 - Sombras do Inanimado.", "NV 2 - Marionete de Carne.", "NV 3 - Espectral (Possess√£o)."] },
  { nome: "√Åpice Humano", descricao: "Seu corpo atinge o pico absoluto.", maxNivel: 1, niveis: ["Desbloqueado"] },
  { nome: "Corpo Amaldi√ßoado", descricao: "Corpo de energia pura.", maxNivel: 1, niveis: ["Desbloqueado"] }
];

// 2. HABILIDADES DE CLASSE
const HABILIDADES_CLASSE = {
  "Lutador": [
    { 
      nivel: 1, 
      nome: "Empolga√ß√£o", 
      desc: "Uma boa luta √© empolgante e te motiva a se arriscar mais e mais, permitindo movimentos mais fortes e √∫nicos. Para isso, voc√™ precisa continuar acertando golpes: voc√™ come√ßa um combate com N√≠vel de Empolga√ß√£o 1 e, caso acerte pelo menos um ataque ou manobra (agarrar, empurrar etc.) durante seu turno, no come√ßo do seu pr√≥ximo turno voc√™ sobe um n√≠vel de empolga√ß√£o, at√© um m√°ximo de 5 n√≠veis.\n\nN√çVEL DE EMPOLGA√á√ÉO | DADO DE EMPOLGA√á√ÉO\nN√≠vel 2 | 1d4\nN√≠vel 3 | 1d6\nN√≠vel 4 | 2d4\nN√≠vel 5 | 2d6\n\nA empolga√ß√£o te permite realizar certas manobras especiais, as quais normalmente s√£o fortalecidas por um b√¥nus, que √© o Dado de Empolga√ß√£o, cujo valor varia com o n√≠vel, seguindo a tabela acima. Cada manobra pode ser realizada apenas uma vez por rodada. Caso passe uma rodada sem acertar um ataque, voc√™ desce um n√≠vel de empolga√ß√£o." 
    },
    {
      nivel: 1,
      nome: "Manobras de Combate (Escolha 2)",
      tipo: "selecao_multipla",
      qtd: 2,
      opcoes: [
        { nome: "Ajuste", desc: "√Äs vezes um bom golpe s√≥ precisa de um ajuste. Uma vez por rodada, ao realizar um ataque, voc√™ pode adicionar seu dado de empolga√ß√£o na rolagem de acerto e no dano. Voc√™ pode escolher adicionar o b√¥nus antes ou depois de saber o resultado da rolagem de acerto." },
        { nome: "Comando", desc: "Sua empolga√ß√£o pode acabar contagiando seus aliados. Ao realizar um ataque, voc√™ comanda um aliado dentro de 1,5 metros a realizar um ataque corpo-a-corpo o acompanhando no mesmo alvo, como uma rea√ß√£o dele. Voc√™ ou aliado deve pagar 1 ponto de energia amaldi√ßoada para realizar o ataque. Caso use essa habilidade, voc√™ n√£o pode utilizar ataque extra." },
        { nome: "Desarme", desc: "Uma boa luta n√£o deve ser contida pelo porte de uma arma. Ao acertar uma criatura com um ataque voc√™ aproveita para tentar a desarmar. Voc√™ adiciona seu dado de empolga√ß√£o ao dano desse ataque e o alvo deve fazer uma jogada de ataque corpo a corpo contra o resultado do seu ataque. Em uma falha ele larga um item √† sua escolha que esteja manejando." },
        { nome: "Esquiva", desc: "Com o sangue fervendo, √© mais f√°cil se esquivar de ataques. Ao ser acertado por um ataque corpo-a-corpo voc√™ pode usar sua rea√ß√£o para diminuir o dano em um valor igual a uma rolagem do seu dado de empolga√ß√£o + modificador de destreza." },
        { nome: "Trabalho de P√©s", desc: "Voc√™ usa da sua empolga√ß√£o para trabalhar o seu movimento. Como uma a√ß√£o b√¥nus, voc√™ pode escolher aumentar sua Defesa em um valor igual ao seu dado de empolga√ß√£o, at√© o come√ßo do seu pr√≥ximo turno." }
      ]
    },
    { nivel: 2, nome: "Reflexo Evasivo", desc: "Em busca de uma boa luta, e conseguir durar nela, voc√™ come√ßa a desenvolver um reflexo para evitar danos. Voc√™ recebe redu√ß√£o de dano a todo tipo, exceto alma, igual a metade do seu n√≠vel de Lutador." },
    { nivel: 4, nome: "Implemento Marcial", desc: "Voc√™ recebe +2 na CD de suas Habilidades de Especializa√ß√£o, Feiti√ßos e Aptid√µes Amaldi√ßoadas. Esse b√¥nus aumenta em 1 nos n√≠veis 8¬∞ e 16¬∞ de Lutador." },
    { nivel: 5, nome: "Gosto pela Luta", desc: "Voc√™ tem um gosto pelas lutas, o que come√ßa a cultivar uma for√ßa, precis√£o e resist√™ncia superiores. Voc√™ passa a adicionar +2 em jogadas de ataque desarmadas ou com armas marciais e +1 em rolagens de Fortitude e de dano. Nos n√≠veis 8, 12, 16 e 20 o b√¥nus em jogadas de ataque aumenta em +1, enquanto nos n√≠veis 9, 13 e 17 o b√¥nus em Fortitude e dano aumenta em +1." },
    {
      nivel: 6,
      nome: "Nova Manobra (N√≠vel 6)",
      tipo: "selecao_unica",
      opcoes: ["Ajuste", "Comando", "Desarme", "Esquiva", "Trabalho de P√©s"]
    },
    { nivel: 9, nome: "Teste de Resist√™ncia Mestre", desc: "Voc√™ se torna treinado em um segundo teste de resist√™ncia e mestre no concedido pela sua especializa√ß√£o." },
    { nivel: 11, nome: "Empolga√ß√£o M√°xima", desc: "O seu potencial e intensidade assumem um patamar superior, aprimorando suas capacidades. Os seus dados de empolga√ß√£o se tornam 2d4, 2d6, 2d8 e 3d6, respectivamente." },
    {
      nivel: 12,
      nome: "Nova Manobra (N√≠vel 12)",
      tipo: "selecao_unica",
      opcoes: ["Ajuste", "Comando", "Desarme", "Esquiva", "Trabalho de P√©s"]
    },
    {
      nivel: 18,
      nome: "Nova Manobra (N√≠vel 18)",
      tipo: "selecao_unica",
      opcoes: ["Ajuste", "Comando", "Desarme", "Esquiva", "Trabalho de P√©s"]
    },
    { nivel: 20, nome: "Lutador Superior", desc: "Tendo alcan√ßado o √°pice do seu corpo e das t√©cnicas de combate do lutador, voc√™ est√° em um n√≠vel superior. Seus ataques desarmados causam 1 dado de dano adicional e uma vez por rodada, voc√™ pode realizar um ataque desarmado como uma a√ß√£o livre gastando 2PE. Al√©m disso, voc√™ inicia todo combate com um N√≠vel de Empolga√ß√£o a mais." }
  ],

  "Especialista em Combate": [
    {
      nivel: 1,
      nome: "Repert√≥rio do Especialista (Estilo de Combate)",
      desc: "Como um Especialista em Combate, voc√™ pode escolher um estilo principal para seguir em sua especializa√ß√£o. No primeiro n√≠vel, voc√™ recebe um dos estilos de combate abaixo:",
      tipo: "selecao_unica",
      opcoes: [
        "Estilo Defensivo: Voc√™ foca em aprimorar a sua defesa. Sua Defesa aumenta em 2 e, nos n√≠veis 4, 8, 12 e 16 aumenta em +1.",
        "Estilo do Arremessador: Voc√™ se versa em armas de arremesso. Voc√™ pode sacar uma arma de arremesso como parte do ataque, al√©m de receber +2 em rolagens de dano com elas, o qual aumenta em +1 nos n√≠veis 4, 8, 12 e 16.",
        "Estilo do Duelista: Voc√™ foca em duelar com uma √∫nica arma em m√£os. Ao usar uma arma em uma m√£o e ter a outra livre, voc√™ recebe +2 em rolagens de acerto e dano, o qual aumenta em +1 nos n√≠veis 4, 8, 12 e 16.",
        "Estilo do Interceptador: Voc√™ se dedica a utilizar de suas armas para interceptar ataques em seus aliados. Quando um aliado dentro do seu alcance receber um ataque, voc√™ pode usar sua rea√ß√£o para reduzir o dano causado em 1d10 + seu modificador de for√ßa, destreza ou sabedoria, aumentando em um dado nos n√≠veis 4, 8, 12 e 16.",
        "Estilo do Protetor: Voc√™ se dedica a proteger seus aliados, buscando evitar um acerto. Quando uma criatura ataca um alvo al√©m de voc√™, que esteja dentro de 1,5 metros, voc√™ pode usar sua rea√ß√£o para impor desvantagem. Al√©m disso, voc√™ pode tamb√©m conceder vantagem no Teste de Resist√™ncia de um aliado dentro de 1,5 metros.",
        "Estilo Distante: Voc√™ sabe como usar armas que focam em atingir de maneira distante. Voc√™ recebe +2 em rolagens de acerto e dano com armas a dist√¢ncia, o qual aumenta em +1 nos n√≠veis 4, 8, 12 e 16.",
        "Estilo Duplo: Voc√™ sabe a maneira perfeita de manejar duas armas. Enquanto estiver lutando com duas armas, voc√™ pode adicionar o seu b√¥nus de atributo no dano do ataque com a segunda arma, al√©m de receber um b√¥nus de +1 em rolagens de dano, o qual aumenta em +1 nos n√≠veis 4, 8, 12 e 16.",
        "Estilo Massivo: Voc√™ domina armas pesadas e massivas. Quando rolar um 1 ou 2 em um dado na rolagem de dano com uma arma que esteja usando em duas m√£os ou que possua a propriedade pesada, voc√™ pode rolar novamente esse dado, ficando com o novo resultado. Al√©m disso, voc√™ recebe +1 em rolagens de dano com a arma, aumentando em +1 nos n√≠veis 4, 8, 12 e 16."
      ]
    },
    { 
      nivel: 1, 
      nome: "Artes do Combate", 
      desc: "Levando o combate como uma arte a se estudar e aperfei√ßoar, voc√™ sabe como se preparar e usar desse preparo para o possibilitar realizar a√ß√µes especiais dentro de um combate. Voc√™ recebe uma quantidade de Pontos de Preparo igual ao seu n√≠vel de Especialista em Combate + B√¥nus de treinamento, os quais s√£o usados para realizar artes de combate. Voc√™ sabe as seguintes artes de combate:\n\n‚Ä¢ Arremesso √Ågil. Ao realizar um ataque corpo-a-corpo, voc√™ pode gastar 1 ponto de preparo para, como uma a√ß√£o b√¥nus, realizar tamb√©m um ataque com uma arma de arremesso.\n‚Ä¢ Distra√ß√£o Letal. Ao realizar um ataque, voc√™ pode gastar 1 ponto de preparo para fazer com que ele foque em distrair o alvo. Caso o ataque acerte, a criatura atingida tem a sua Defesa reduzida em um valor igual ao seu b√¥nus de treinamento por uma rodada.\n‚Ä¢ Execu√ß√£o Silenciosa. Ao realizar um ataque em uma criatura desprevenida, voc√™ pode gastar 1 ponto de preparo para aumentar a letalidade do ataque, adicionando 1d6 de dano. A cada 5 n√≠veis, o dano aumenta em 1d6.\n‚Ä¢ Golpe Descendente. Ao realizar um ataque corpo-a-corpo, voc√™ pode gastar 1 ponto de preparo para fazer com que ele venha por cima. Ao acertar um golpe descendente, sua Defesa aumenta em um valor igual ao seu b√¥nus de treinamento at√© o come√ßo do seu pr√≥ximo turno.\n‚Ä¢ Investida Imediata. Ao realizar a a√ß√£o de ataque, voc√™ pode gastar 2 pontos de preparo para tornar esse ataque em uma investida imediata, aproximando-se at√© 4,5 metros de um alvo e realizando o ataque logo ap√≥s. Esse movimento n√£o causa ataques de oportunidade.\n\nSempre que eliminar um inimigo, voc√™ recupera um Ponto de Preparo; voc√™ pode usar sua a√ß√£o comum para analisar o campo de batalha, recuperando dois Pontos de Preparo. Em um descanso curto, voc√™ recupera metade do seu m√°ximo, enquanto em um descanso longo os recupera por completo." 
    },
    { 
      nivel: 4, 
      nome: "Golpe Especial", 
      desc: "Quando realizar um ataque, ou arte do combate que envolva um ataque, voc√™ pode o montar como um ataque especial, escolhendo entre as op√ß√µes abaixo:\n\n‚Ä¢ Amplo. O ataque atinge uma criatura a mais. +2PE\n‚Ä¢ Atroz. Em um acerto, o ataque causa 1 dado de dano adicional. +1PE\n‚Ä¢ Impactante. Empurra o alvo em 1,5 metros para cada 15 pontos de dano causados. Fortitude reduz √† metade. +1PE\n‚Ä¢ Letal. Diminui em 1 a margem de cr√≠tico do ataque. +2PE\n‚Ä¢ Longo. Aumenta o alcance da arma em 1,5 metros para corpo-a-corpo ou 9 metros para ataques a dist√¢ncia. +1PE\n‚Ä¢ Penetrante. Ignora redu√ß√£o a dano em um valor igual a metade do seu n√≠vel de personagem. +2PE\n‚Ä¢ Preciso. Recebe vantagem no ataque. Ap√≥s o primeiro uso na rodada, o custo aumenta para 2PE. +1PE/+2PE\n‚Ä¢ Sanguin√°rio. Uma criatura atingida sofre sangramento leve (CD de Especializa√ß√£o). Pode ser pego uma segunda vez para causar sangramento m√©dio ao inv√©s de leve. +2PE\n‚Ä¢ Lento. O ataque deve ser usado como a√ß√£o completa. -2PE\n‚Ä¢ Sacrif√≠cio. Recebe 15 de dano ao efetuar o ataque. -1PE\n‚Ä¢ Desfocado. O ataque recebe uma penalidade de 4 no acerto (cumulativo at√© tr√™s vezes). -1PE\n\nCertas propriedades aumentam ou diminuem o custo e, ao terminar de montar o ataque especial, voc√™ paga o seu custo total; um ataque especial deve custar no m√≠nimo 1 ponto de energia amaldi√ßoada (PE)." 
    },
    { nivel: 4, nome: "Implemento Marcial", desc: "Voc√™ recebe +2 na CD de suas Habilidades de Especializa√ß√£o, Feiti√ßos e Aptid√µes Amaldi√ßoadas. Esse b√¥nus aumenta em 1 nos n√≠veis 8¬∞ e 16¬∞ de Especialista em Combate." },
    {
      nivel: 6,
      nome: "Novo Estilo de Combate (N√≠vel 6)",
      tipo: "selecao_unica",
      opcoes: ["Defensivo", "Arremessador", "Duelista", "Interceptador", "Protetor", "Distante", "Duplo", "Massivo"]
    },
    { nivel: 6, nome: "Renova√ß√£o pelo Sangue", desc: "Com tamanha precis√£o e letalidade, voc√™ passa a ser capaz de renovar seu pr√≥prio estoque de energia a partir do sangue. Ao acertar um ataque cr√≠tico em um inimigo ou reduzir seus pontos de vida a 0, voc√™ recupera um ponto de energia amaldi√ßoada." },
    { nivel: 9, nome: "Teste de Resist√™ncia Mestre", desc: "Voc√™ se torna treinado em um segundo teste de resist√™ncia e mestre no concedido pela sua especializa√ß√£o." },
    {
      nivel: 12,
      nome: "Novo Estilo de Combate (N√≠vel 12)",
      tipo: "selecao_unica",
      opcoes: ["Defensivo", "Arremessador", "Duelista", "Interceptador", "Protetor", "Distante", "Duplo", "Massivo"]
    },
    { nivel: 20, nome: "Autossuficiente", desc: "Tornando-se um mestre das t√©cnicas armadas, voc√™ consegue ser autossuficiente na energia para usar seu golpe especial. Sempre que realizar um Golpe Especial, recebe 3 PE tempor√°rios para serem usados no ataque. Uma vez por cena, voc√™ pode escolher transformar esse valor em 6. Al√©m disso, todos seus ataques causam um dado de dano adicional, do mesmo tipo da arma manuseada." }
  ],

  "Especialista em T√©cnica": [
    {
      nivel: 1,
      nome: "Mudan√ßas de Fundamento (Escolha 2)",
      desc: "Como um especialista em t√©cnicas, voc√™ tem uma maior domin√¢ncia sobre os fundamentos da energia amaldi√ßoada e das suas habilidades. Voc√™ aprende duas das Mudan√ßas de Fundamento abaixo no primeiro n√≠vel:",
      tipo: "selecao_multipla",
      qtd: 2,
      opcoes: [
        { nome: "Feiti√ßo Cruel", desc: "Quando usar um Feiti√ßo que for√ßa um teste de resist√™ncia voc√™ pode gastar 1 ponto de energia amaldi√ßoada para aumentar a CD do teste em 2 ou 2 pontos para aumentar em 4." },
        { nome: "Feiti√ßo Cuidadoso", desc: "Quando usar um Feiti√ßo em √°rea voc√™ pode prevenir certas criaturas de serem afetadas. Voc√™ pode gastar uma quantidade de pontos igual ao seu modificador de Intelig√™ncia ou Sabedoria para fazer com que o dobro da quantidade de criaturas n√£o seja afetado." },
        { nome: "Feiti√ßo Distante", desc: "Quando usar um Feiti√ßo a dist√¢ncia, voc√™ pode gastar 2 pontos de energia amaldi√ßoada para dobrar seu alcance. Caso seja um Feiti√ßo corpo-a-corpo, voc√™ pode gastar 2 pontos de energia para a dar um alcance de 9 metros." },
        { nome: "Feiti√ßo Duplicado", desc: "Uma vez por rodada, quando usar um Feiti√ßo de dano cujo alvo seja apenas uma criatura, voc√™ pode gastar pontos de energia para dar um segundo alvo a habilidade. O custo √© igual ao dobro do n√≠vel do Feiti√ßo (considere 1 para Feiti√ßos n√≠vel 0)." },
        { nome: "Feiti√ßo Expansivo", desc: "Quando usar um Feiti√ßo em √°rea, voc√™ pode gastar 3 pontos de energia amaldi√ßoada para aumentar a √°rea em um valor igual a metade da √°rea padr√£o (1,5x do total)." },
        { nome: "Feiti√ßo Potente", desc: "Quando usar um Feiti√ßo de dano, voc√™ pode gastar 3 pontos de energia amaldi√ßoada e rolar novamente uma quantidade de dados de dano igual ao seu modificador de Intelig√™ncia ou Sabedoria, utilizando os melhores resultados." },
        { nome: "Feiti√ßo Preciso", desc: "Quando usar um Feiti√ßo que utilize um teste de ataque, voc√™ pode gastar 1 ponto de energia amaldi√ßoada para receber +2 de acerto ou 2 pontos de energia amaldi√ßoada para receber +4 de acerto." }
      ]
    },
    { nivel: 1, nome: "Conjura√ß√£o Aprimorada", desc: "Todos podem utilizar Feiti√ßos, mas voc√™ consegue os aprimorar e extrair um maior potencial. Sempre que utilizar um Feiti√ßo que cause dano, voc√™ soma um b√¥nus ao total de dano causado baseado no n√≠vel do Feiti√ßo, de acordo com a tabela abaixo. Al√©m disso, voc√™ passa a receber novos Feiti√ßos em todo n√≠vel, ao inv√©s de apenas nos n√≠veis pares.\n\nN√çVEL DA HABILIDADE | B√îNUS DE DANO\nN√≠vel 1 | Modificador de Atributo\nN√≠vel 2 | Modificador de Atributo\nN√≠vel 3 | Dobro do Modificador de Atributo\nN√≠vel 4 | 2x Mod. de Atributo + N√≠vel de Personagem\nN√≠vel 5 | 2x Mod. de Atributo + 2x N√≠vel de Personagem\nT√©cnica M√°xima | 3x Mod. de Atributo + 3x N√≠vel de Personagem" },
    { nivel: 4, nome: "Adiantar a Evolu√ß√£o", desc: "Focado em sua t√©cnica, voc√™ consegue adiantar a evolu√ß√£o das suas habilidades. Ao inv√©s de seguir o padr√£o para conseguir Feiti√ßos de n√≠vel superior, com o aumento de treinamento, voc√™ segue o seguinte padr√£o: no n√≠vel 4, voc√™ recebe acesso a Feiti√ßos n√≠vel 2; no n√≠vel 7, voc√™ recebe acesso a Feiti√ßos n√≠vel 3; no n√≠vel 11, voc√™ recebe acesso a Feiti√ßos n√≠vel 4; no n√≠vel 15, voc√™ recebe acesso a Feiti√ßos n√≠vel 5." },
    { nivel: 6, nome: "Feiti√ßo R√°pido (Desbloqueado na Lista)", desc: "Uma vez por rodada, quando for utilizar um Feiti√ßo cuja conjura√ß√£o seja uma A√ß√£o Completa ou Comum, voc√™ pode gastar PE para reduzir seu custo em a√ß√£o em um (Completa para Comum ou Comum para B√¥nus). O custo √© igual ao dobro do n√≠vel do Feiti√ßo (considere 1 para Feiti√ßos n√≠vel 0). Pr√©-Requisito: N√≠vel 6." },
    { nivel: 9, nome: "Teste de Resist√™ncia Mestre", desc: "Voc√™ se torna treinado em um segundo teste de resist√™ncia e mestre no concedido pela sua especializa√ß√£o." },
    {
      nivel: 10,
      nome: "Foco Amaldi√ßoado",
      desc: "Durante seu desenvolvimento, voc√™ se foca em certos aspectos do funcionamento da energia amaldi√ßoada, podendo escolher entre um dos tr√™s focos:",
      tipo: "selecao_unica",
      opcoes: [
        "Destrui√ß√£o: Todo Feiti√ßo que voc√™ conjurar causa +1 de dano para cada dado rolado nela. Al√©m disso, sempre que causar dano com um Feiti√ßo ou aptid√£o amaldi√ßoada, voc√™ soma o seu b√¥nus de treinamento no total de dano.",
        "Economia: O custo de todos os seus Feiti√ßos √© reduzido em 2, podendo reduzir o custo dos Feiti√ßos n√≠vel 1 para 0. Al√©m disso, voc√™ passa a somar o seu b√¥nus de treinamento no seu m√°ximo de energia amaldi√ßoada.",
        "Refino: Voc√™ recebe uma Aptid√£o Amaldi√ßoada ou Feiti√ßo adicional a sua escolha. Al√©m disso, voc√™ passa a somar metade do seu b√¥nus de treinamento no c√°lculo de todas as suas CDs e em jogadas de ataque amaldi√ßoado."
      ]
    },
    {
      nivel: 12,
      nome: "Nova Mudan√ßa de Fundamento",
      tipo: "selecao_unica",
      opcoes: ["Feiti√ßo Cruel", "Feiti√ßo Cuidadoso", "Feiti√ßo Distante", "Feiti√ßo Duplicado", "Feiti√ßo Expansivo", "Feiti√ßo Potente", "Feiti√ßo Preciso", "Feiti√ßo R√°pido"]
    },
    { nivel: 20, nome: "O Honrado", desc: "Entre os c√©us e a terra, voc√™ sozinho √© o honrado, com um controle de energia amaldi√ßoada insuper√°vel. Feiti√ßos de n√≠vel 1, 2 e 3 tem o seu custo reduzido pela metade; a CD de todos seus Feiti√ßos e Aptid√µes Amaldi√ßoadas aumenta em 5 e voc√™ recebe +5 em rolagens de ataque para Feiti√ßos e Aptid√µes Amaldi√ßoadas." }
  ],

  "Controlador": [
    { nivel: 1, nome: "Treinamento em Controle", desc: "Voc√™ √© treinado para controlar Invoca√ß√µes com maior efici√™ncia. Ao obter esta habilidade, voc√™:\n‚Ä¢ Recebe duas Invoca√ß√µes iniciais, as quais podem ser tanto shikigamis quanto corpos amaldi√ßoados. Nos n√≠veis 3, 6, 9, 10, 12, 15 e 18 voc√™ recebe uma Invoca√ß√£o adicional.\n‚Ä¢ A quantidade de Invoca√ß√µes que voc√™ pode manter ativas em campo aumenta em 1.\n‚Ä¢ Nos n√≠veis 6, 12 e 18 a quantidade de comandos que voc√™ realiza com uma A√ß√£o Comum e B√¥nus aumenta em um (no n√≠vel 6, uma A√ß√£o Comum permitiria duas Invoca√ß√µes realizarem uma a√ß√£o complexa ou uma Invoca√ß√£o realizar duas a√ß√µes complexas)." },
    { nivel: 4, nome: "Controle Aprimorado", desc: "Voc√™ √© naturalmente mais capaz em comandar invoca√ß√µes, aprimorando o desempenho delas. Suas invoca√ß√µes recebem um b√¥nus em testes que realizarem igual a +2, aumentando em +1 para cada grau acima do quarto (+3 para terceiro, +4 para segundo etc.)" },
    {
      nivel: 6,
      nome: "Apogeu (Estilo de Controle)",
      desc: "Voc√™ come√ßa a encontrar o caminho que deseja seguir como um controlador, especializando-o em um estilo espec√≠fico de controle. Escolha entre:",
      tipo: "selecao_unica",
      opcoes: [
        "Controle Concentrado: Voc√™ opta por concentrar suas for√ßas e foco em uma √∫nica invoca√ß√£o, a qual sozinha se torna uma arma absoluta. Ao inv√©s de invocar/ativar duas invoca√ß√µes como uma a√ß√£o b√¥nus, voc√™ pode invocar apenas uma como a√ß√£o livre.",
        "Controle Disperso: Voc√™ prefere controlar diversas invoca√ß√µes, mantendo a quantidade sempre em n√∫mero superior. O n√∫mero de invoca√ß√µes que voc√™ pode manter ativas em campo aumenta em 1, assim como a quantidade que voc√™ pode invocar/ativar com uma a√ß√£o aumenta em 1. Al√©m disso, voc√™ recebe acesso √† a√ß√£o Criar Horda (p.259). A partir do n√≠vel 12, o n√∫mero de invoca√ß√µes que voc√™ pode manter ativas em campo e invocar/ativar com uma a√ß√£o aumenta em 1, assim como voc√™ pode criar duas hordas como parte de uma mesma a√ß√£o de Criar Horda.",
        "Controle Sintonizado: Voc√™ prefere ficar em sintonia com suas invoca√ß√µes, n√£o deixando que apenas elas lutem sozinhas. Uma vez por rodada, quando uma invoca√ß√£o em campo realizar um ataque contra um alvo dentro do seu alcance, voc√™ pode pagar 2PE para, como uma A√ß√£o Livre, realizar um ataque contra o mesmo alvo. Al√©m disso, para cada invoca√ß√£o que possua em campo, voc√™ recebe +1 em acerto e dano, com elas te auxiliando."
      ]
    },
    { nivel: 9, nome: "Teste de Resist√™ncia Mestre", desc: "Voc√™ se torna treinado em um segundo teste de resist√™ncia e mestre no concedido pela sua especializa√ß√£o." },
    { nivel: 10, nome: "Reserva para Invoca√ß√£o", desc: "Voc√™ cria uma reserva dedicada para invocar ou ativar as suas invoca√ß√µes. Uma vez por descanso curto, voc√™ pode optar por usar a a√ß√£o Invocar para trazer duas invoca√ß√µes com o custo reduzido pela metade ou uma invoca√ß√£o sem custo. Caso utilize esta habilidade para Criar Horda, o custo total dela √© reduzido pela metade." },
    { nivel: 20, nome: "√Åpice do Controle", desc: "Voc√™ alcan√ßou o √°pice do controle, levando al√©m do limite a arte de ter invoca√ß√µes e as controlar, sendo uma presen√ßa √∫nica no mundo. Suas invoca√ß√µes recebem duas a√ß√µes/caracter√≠sticas adicionais, as quais n√£o influenciam no custo delas; voc√™ passa a poder invocar ou ativar suas invoca√ß√µes como uma a√ß√£o livre (caso ela j√° pudesse ser invocada como A√ß√£o Livre, ela tem seu custo reduzido em 2 PE). Al√©m disso, conhecendo bem as t√°ticas para utilizar invoca√ß√µes, voc√™ consegue prever parte dos movimentos delas: invoca√ß√µes de outras criaturas possuem desvantagem para realizar a√ß√µes ofensivas contra voc√™." }
  ],

  "Suporte": [
    { nivel: 1, nome: "Suporte em Combate", desc: "Um suporte disp√µe de um leque de capacidades que o permite auxiliar dentro do combate:\n‚Ä¢ Voc√™ pode usar Apoiar como uma a√ß√£o b√¥nus.\n‚Ä¢ Voc√™ pode, como uma a√ß√£o b√¥nus, curar uma criatura em alcance de toque em um valor igual a 2d6 + seu modificador de Presen√ßa ou Sabedoria, uma quantidade de vezes igual ao seu modificador de Presen√ßa ou Sabedoria, por descanso curto ou longo. No n√≠vel 4, essa cura se torna 2d12, no n√≠vel 8, se torna 3d12, no n√≠vel 12 se torna 6d8, no n√≠vel 16 se torna 6d10." },
    { nivel: 3, nome: "Presen√ßa Inspiradora", desc: "Sua presen√ßa inspira aqueles ao seu redor a tentarem seu m√°ximo. Voc√™ pode pagar 2 pontos de energia amaldi√ßoada para fazer com que, durante uma cena, todo aliado dentro de 9 metros de voc√™ fique inspirado. Um aliado inspirado recebe um b√¥nus de +1 em toda rolagem de per√≠cia. Ao utilizar esta habilidade, voc√™ pode gastar uma quantidade de PE adicional igual a metade do seu modificador de Presen√ßa, aumentando o b√¥nus em +1 para cada PE gasto dessa maneira." },
    { nivel: 5, nome: "Versatilidade", desc: "Sempre que realizar uma rolagem com uma per√≠cia na qual voc√™ n√£o seja treinado, voc√™ pode pagar 1 ponto de energia amaldi√ßoada para considerar como se fosse treinado. Voc√™ pode utilizar esta habilidade uma quantidade de vezes igual ao seu modificador de Sabedoria, por descanso curto ou longo." },
    { nivel: 6, nome: "Aptid√£o: Energia Reversa", desc: "Voc√™ recebe a aptid√£o amaldi√ßoada 'Energia Reversa'." },
    { nivel: 8, nome: "Aptid√£o: Libera√ß√£o de Energia Reversa", desc: "Voc√™ recebe a aptid√£o amaldi√ßoada 'Libera√ß√£o de Energia Reversa'." },
    { nivel: 9, nome: "Teste de Resist√™ncia Mestre", desc: "Voc√™ se torna treinado em um segundo teste de resist√™ncia e mestre no concedido pela sua especializa√ß√£o." },
    { nivel: 10, nome: "Medicina Infal√≠vel", desc: "Voc√™ consegue dominar seus conhecimentos m√©dicos e auxiliares ao ponto de elev√°-los para um patamar superior. Uma quantidade de vezes igual a metade do seu n√≠vel de Suporte + b√¥nus de treinamento, voc√™ pode, quando realizar uma rolagem para curar uma criatura, maximizar o valor de um dos dados dessa cura; voc√™ pode gastar v√°rios usos para maximizar mais de um dado da mesma cura. Voc√™ recupera os usos ap√≥s um descanso curto ou longo. Al√©m disso, voc√™ soma o seu b√¥nus de treinamento no total de toda cura que realizar." },
    { nivel: 20, nome: "Suporte Absoluto", desc: "Voc√™ √© o suporte absoluto que se pode ter em campo, mudando o rumo da batalha para todos seus aliados. Uma vez por rodada, voc√™ pode utilizar Apoiar como uma A√ß√£o Livre. Al√©m disso, sua quantidade de usos da habilidade Suporte em Combate s√£o dobrados e voc√™ soma seu modificador de atributo escolhido para CD de especializa√ß√£o em toda cura que realizar." }
  ],

  "Restringido": [
    { nivel: 1, nome: "Restrito pelos C√©us", desc: "Para compensar sua falta de energia amaldi√ßoada, um restringido recebe v√°rios benef√≠cios atrelados ao seu f√≠sico maior e aptid√£o ao combate:\n‚Ä¢ Voc√™ pode escolher adicionar tamb√©m seu modificador de For√ßa ou de Constitui√ß√£o na sua Defesa, limitado pelo seu n√≠vel.\n‚Ä¢ Voc√™ come√ßa com uma ferramenta amaldi√ßoada de quarto grau e um meio de ver maldi√ß√µes (√≥culos ou lente). A partir do segundo n√≠vel, voc√™ recebe acesso ao Arsenal Amaldi√ßoado, detalhado no final da especializa√ß√£o.\n‚Ä¢ No 4¬∞ n√≠vel, e depois a cada 4 n√≠veis, voc√™ recebe uma D√°diva do C√©u, listadas no final desta especializa√ß√£o.\n‚Ä¢ Por n√£o ter energia amaldi√ßoada, voc√™ possui Pontos de Estamina, os quais s√£o baseados na sua pr√≥pria for√ßa vital, e s√£o usados por certas habilidades. Voc√™ inicia com 4 pontos de estamina, e recebe mais 4 a cada n√≠vel. Voc√™ os recupera por completo em um descanso longo, ou metade em um descanso curto.\nAl√©m disso, voc√™ possui um Estilo Marcial, explicado ap√≥s as habilidades da especializa√ß√£o." },
    { nivel: 2, nome: "Ataque Furtivo", desc: "Uma vez por turno, ao realizar um ataque surpresa ou contra um inimigo desprevenido, voc√™ pode adicionar 1d8 ao dano dele. Caso voc√™ esteja flanqueando um inimigo, n√£o √© necess√°rio ser um ataque surpresa ou um alvo desprevenido para aplicar o dano adicional. No n√≠vel 3, o dano se torna 2d8, no n√≠vel 6 se torna 3d8, no n√≠vel 9 se torna 4d8, no n√≠vel 12 se torna 5d8, no n√≠vel 15 se torna 6d8." },
    { nivel: 2, nome: "Versatilidade", desc: "Voc√™ pretende se tornar um pouco mais vers√°til em tudo. Voc√™ recebe +1 em todas as per√≠cias. No 10¬∞ n√≠vel esse b√¥nus se torna +2." },
    { nivel: 3, nome: "Esquiva Sobre-humana", desc: "Voc√™ recebe +1 em sua Defesa e em rolagens de Reflexos. No n√≠vel 9 e no n√≠vel 16, esse b√¥nus aumenta em +1. Al√©m disso, a partir do 10¬∞ n√≠vel, voc√™ se torna mestre no TR de Reflexos e o valor necess√°rio para obter um sucesso cr√≠tico nela reduz em um valor igual a metade do seu b√¥nus de treinamento." },
    { nivel: 4, nome: "Implemento Celeste", desc: "Voc√™ recebe +2 na CD de suas habilidades de restringido e t√©cnicas marciais. Esse b√¥nus aumenta em 1 nos n√≠veis 8 e 16 de Restringido." },
    { nivel: 9, nome: "Teste de Resist√™ncia Mestre", desc: "Voc√™ se torna mestre nos dois Testes de Resist√™ncia conferidos por sua Especializa√ß√£o." },
    { nivel: 10, nome: "Restri√ß√£o Definitiva", desc: "Seu n√≠vel de energia amaldi√ßoada alcan√ßou o zero absoluto, rejeitando-a por completo em troca de um f√≠sico absoluto. Voc√™ recebe os seguintes benef√≠cios:\n‚Ä¢ Voc√™ tem vantagem em testes de furtividade contra qualquer usu√°rio de energia amaldi√ßoada e eles possuem desvantagem em testes para o perceber.\n‚Ä¢ Voc√™ passa a ver o tra√ßado da alma (veja p√°gina 311), assim como n√£o necessita mais de uma ferramenta amaldi√ßoada para enxergar maldi√ß√µes.\n‚Ä¢ Toda arma que voc√™ manejar conta como um n√≠vel de dano acima e seu valor de deslocamento aumenta em 3 metros.\n‚Ä¢ Se for mestre em uma per√≠cia ou teste de resist√™ncia que utilize For√ßa, Destreza ou Constitui√ß√£o voc√™ soma seu b√¥nus de treinamento inteiro ao inv√©s de metade dele na per√≠cia.\n‚Ä¢ Voc√™ se torna imune a expans√µes de dom√≠nio, veja a p√°gina 247." },
    { nivel: 20, nome: "Liberta√ß√£o do Destino", desc: "Subvertendo a sua restri√ß√£o celeste, voc√™ se libertou completamente do destino, alcan√ßando um n√≠vel de poder invej√°vel e √∫nico para um ser humano como voc√™. Voc√™ recebe resist√™ncia a todo tipo de dano f√≠sico (cortante, perfurante e de impacto), al√©m de mais um tipo de dano a sua escolha, exceto na alma. Voc√™ tamb√©m recebe +5 em rolagens de ataque e soma metade do seu n√≠vel de personagem no total de dano." }
  ]
};

// 3. ITENS ESPECIAIS
const ITENS_ESPECIAIS = [
  { custo: 1, nome: "Ant√≠doto Simples", tipo: "Item", grau: "4", desc: "[F√°rmaco] Cura veneno leve." },
  { custo: 2, nome: "Amuleto do Vislumbre", tipo: "Item", grau: "3", desc: "[Acess√≥rio] Vis√£o no escuro." },
  { custo: 3, nome: "An√©is do Conhecimento", tipo: "Item", grau: "2", desc: "[Acess√≥rio] +2 Sabedoria." },
  { custo: 4, nome: "Elixir da Vida", tipo: "Item", grau: "1", desc: "[Espiritual] Cura total." }
];

// 4. PROPRIEDADES
const PROPRIEDADES_GERAIS = [{ nome: "Ampla", desc: "Afeta adjacente." }, { nome: "Aparar", desc: "+2 Defesa." }, { nome: "Apunhaladora", desc: "+Dano surpresa." }, { nome: "Arremess√°vel", desc: "Pode arremessar." }, { nome: "Duas M√£os", desc: "Usa 2 m√£os." }, { nome: "Dupla", desc: "Ataque extra." }, { nome: "Emperrar", desc: "Falha cr√≠tica trava." }, { nome: "En√©rgica", desc: "+Dano sucessivo." }, { nome: "Fatal", desc: "Cr√≠tico mortal." }, { nome: "Fineza", desc: "Usa Destreza." }, { nome: "Leve", desc: "Usa na secund√°ria." }, { nome: "Marcial", desc: "B√¥nus de lutador." }, { nome: "Modular", desc: "Muda dano." }, { nome: "Mortal", desc: "+1 dado crit." }, { nome: "Oscilante", desc: "+2 se errar." }, { nome: "Pesada", desc: "Requer For√ßa." }, { nome: "Recarga", desc: "A√ß√£o para recarregar." }, { nome: "Vers√°til", desc: "1 ou 2 m√£os." }];
const PROPRIEDADES_ESPECIAIS = [{ nome: "Adagas Duplas", desc: "Ligadas." }, { nome: "Alabarda", desc: "+2 Derrubar." }, { nome: "Bazuca", desc: "Explos√£o." }, { nome: "Chakram", desc: "Retorna." }, { nome: "Chicote", desc: "Agarrar." }, { nome: "Escopeta", desc: "Cone." }, { nome: "Katana", desc: "Corte preciso." }, { nome: "Metralhadora", desc: "Tiro r√°pido." }, { nome: "Sniper", desc: "Longo alcance." }, { nome: "Soco Ingl√™s", desc: "Dano desarmado." }];
const ENCANTAMENTOS_ARMAS = [{ nome: "Afiada", desc: "Fatal." }, { nome: "Amplificadora", desc: "+Dano feiti√ßo." }, { nome: "Armazenadora", desc: "Guarda PE." }, { nome: "Balanceada", desc: "+Manobra." }, { nome: "Canalizadora", desc: "+CD." }, { nome: "Certeira", desc: "-1 Margem Crit." }, { nome: "Cruel", desc: "+3 Dano." }, { nome: "Destruidora", desc: "+1 Dado Crit." }, { nome: "Drenadora", desc: "Recupera PE." }, { nome: "Elemental", desc: "Dano elemental." }, { nome: "Harmonizada", desc: "-Custo." }, { nome: "Potente", desc: "+1 Dado." }, { nome: "Precisa", desc: "+2 Acerto." }];
const ENCANTAMENTOS_ESCUDOS = [{ nome: "Bloqueador", desc: "Cobertura." }, { nome: "Espinhoso", desc: "Dano ao defender." }, { nome: "Refor√ßado", desc: "+RD." }];
const ENCANTAMENTOS_UNIFORMES = [{ nome: "Ajustado", desc: "-Penalidade." }, { nome: "Blindado", desc: "+2 Defesa." }, { nome: "Furtivo", desc: "+Furtividade." }, { nome: "Marcial", desc: "+Manobra." }, { nome: "Resiliente", desc: "RD Elemental." }];


import { db, auth, doc, updateDoc, deleteDoc, onSnapshot, collection } from "./firebase.js";

const params = new URLSearchParams(location.search);
const id = params.get("id");
window.id = id;
let ficha = {}; 
let editandoId = null;
let editingItemIndex = -1;
let editingAptIndex = -1;
let editingOriginIndex = -1;
const MESTRE_EMAIL = "grisskos@fake.com";
let isMestre = false;
let currentInvFilter = "todos";

const PERICIAS_DEF = [
  { n: "Atletismo", a: "forca" }, { n: "Acrobacia", a: "destreza" }, { n: "Furtividade", a: "destreza" },
  { n: "Prestidigita√ß√£o", a: "destreza" }, { n: "Feiti√ßaria", a: "inteligencia" }, { n: "Hist√≥ria", a: "inteligencia" },
  { n: "Investiga√ß√£o", a: "inteligencia" }, { n: "Of√≠cio 1", a: "inteligencia" }, { n: "Tecnologia", a: "inteligencia" },
  { n: "Teologia", a: "inteligencia" }, { n: "Dire√ß√£o", a: "sabedoria" }, { n: "Intui√ß√£o", a: "sabedoria" },
  { n: "Medicina", a: "sabedoria" }, { n: "Ocultismo", a: "sabedoria" }, { n: "Percep√ß√£o", a: "sabedoria" },
  { n: "Sobreviv√™ncia", a: "sabedoria" }, { n: "Engana√ß√£o", a: "presenca" }, { n: "Intimida√ß√£o", a: "presenca" },
  { n: "Performance", a: "presenca" }, { n: "Persuas√£o", a: "presenca" }
];
const ATR_SHORT = { forca:"FOR", destreza:"DES", constituicao:"CON", inteligencia:"INT", sabedoria:"SAB", presenca:"PRE" };

auth.onAuthStateChanged(user => {
  if(user && user.email === MESTRE_EMAIL) {
    isMestre = true;
    const el = document.getElementById('gmControlsMain');
    if(el) el.style.display = 'flex';
  }
});

onSnapshot(doc(db, "fichas", id), (docSnap) => {
  if (docSnap.exists()) { 
    ficha = docSnap.data();
    // Init defaults
    if (!ficha.classes) ficha.classes = [{ nome: ficha.classe || "Lutador", nivel: Number(ficha.nivel || 1) }];
    if (!ficha.atributos) ficha.atributos = { forca:10, destreza:10, constituicao:10, inteligencia:10, sabedoria:10, presenca:10 };
    if (!ficha.pericias) ficha.pericias = {};
    if (!ficha.vida) ficha.vida = { atual: 10, max: 10 };
    if (!ficha.energia) ficha.energia = { atual: 10, max: 10 };
    if (!ficha.vigor) ficha.vigor = { atual: 5, max: 5 };
    if (!ficha.integridade) ficha.integridade = { atual: 100, max: 100 };
    if (!ficha.combate) ficha.combate = {}; 
    if (!ficha.inventario) ficha.inventario = []; 
    if (!ficha.progressoAptidoes) ficha.progressoAptidoes = {};
    if (!ficha.transfUnlocked) ficha.transfUnlocked = { apice: false, corpo: false };
    if (!ficha.transfActive) ficha.transfActive = null; 
    if (!ficha.sequelas) ficha.sequelas = { exaustao: false, corrupcao: false };
    if (!ficha.aptidoesCustom) ficha.aptidoesCustom = [];
    if (!ficha.derivados) ficha.derivados = { defesa:0, atencao:0, iniciativa:0, deslocamento:0 };
    if (!ficha.escolhasClasse) ficha.escolhasClasse = {};
    if (!ficha.habilidadesOrigem) ficha.habilidadesOrigem = [];
    
    if(!editandoId) renderFicha(); 
  }
});

// SHIKIGAMIS
onSnapshot(collection(db, "fichas", id, "shikigamis"), (snap) => {
  const shikiArea = document.getElementById('shikiTokens');
  if(shikiArea) {
    shikiArea.innerHTML = "";
    let count = 0;
    snap.forEach(docShiki => {
      const s = docShiki.data();
      const imgUrl = s.imagem || `https://via.placeholder.com/40/222/58E8DA?text=${(s.nome||'?').charAt(0)}`;
      shikiArea.innerHTML += `<img src="${imgUrl}" class="shiki-token" title="${s.nome}" onclick="irParaShikigamis()">`;
      count++;
    });
    if(count < 20) shikiArea.innerHTML += `<div class="shiki-add" onclick="irParaShikigamis()" title="Nova Invoca√ß√£o">+</div>`;
  }
});

function renderFicha() {
  const f = ficha;
  const totalLevel = f.classes.reduce((acc, c) => acc + Number(c.nivel), 0);
  
  const nomeEl = document.getElementById('nomeDisplay');
  if(nomeEl && !nomeEl.querySelector('input')) nomeEl.innerText = f.nome || "Sem Nome";
  document.getElementById('charImg').src = f.imagem || "";
  const classBadgeText = f.classes.map(c => `${c.nome} ${c.nivel}`).join(" / ");
  document.getElementById('badges').innerHTML = `<span class="badge b-lvl">NVL ${totalLevel}</span><span class="badge b-cls" onclick="abrirClassManager()">${classBadgeText || 'Sem Classe'}</span><span class="badge soul-badge" id="soulBadge">Est√°vel</span>`;

  // Soul
  const intPct = f.integridade.max > 0 ? (f.integridade.atual / f.integridade.max) * 100 : 100;
  const soulBadge = document.getElementById('soulBadge');
  let soulClass = "badge soul-stable"; let soulText = "Est√°vel"; let soulTip = "Alma Est√°vel.";
  if(f.integridade.atual <= 0) { soulText = "Morto"; soulClass = "badge soul-dead"; } 
  else if(intPct < 25) { soulText = "Cr√≠tico"; soulClass = "badge soul-critical"; } 
  else if(intPct < 50) { soulText = "Inst√°vel"; soulClass = "badge soul-unstable"; } 
  else if(intPct < 75) { soulText = "Danificado"; soulClass = "badge soul-damaged"; }
  soulBadge.innerText = soulText; soulBadge.className = soulClass; soulBadge.setAttribute("data-tooltip", soulTip);

  const btnApice = document.getElementById('btnApice');
  const btnCorpo = document.getElementById('btnCorpo');
  const divSequela = document.getElementById('statusSequela');
  btnApice.className = "transf-btn apice locked"; btnCorpo.className = "transf-btn corpo locked"; divSequela.innerHTML = "";
  if(f.transfUnlocked.apice) { btnApice.classList.remove('locked'); btnApice.classList.add('unlocked'); if(f.transfActive === 'apice') btnApice.classList.add('active'); }
  if(f.transfUnlocked.corpo) { btnCorpo.classList.remove('locked'); btnCorpo.classList.add('unlocked'); if(f.transfActive === 'corpo') btnCorpo.classList.add('active'); }
  if(f.sequelas.exaustao) divSequela.innerHTML += `<span class="sequela-tag">‚ö† EXAUST√ÉO</span>`;
  if(f.sequelas.corrupcao) divSequela.innerHTML += `<span class="sequela-tag">‚ò† CORRUP√á√ÉO</span>`;

  const areaAttr = document.getElementById('atributosArea');
  areaAttr.innerHTML = "";
  Object.keys(ATR_SHORT).forEach(key => {
    const val = f.atributos[key] || 10;
    const mod = Math.floor((val - 10) / 2);
    areaAttr.innerHTML += `<div class="attr-box"><span class="attr-lbl">${ATR_SHORT[key]}</span><span class="attr-val">${mod>=0?'+':''}${mod}</span><span class="attr-raw editable" onclick="editarCampo(this, 'atributos.${key}', 'number')">${val}</span></div>`;
  });

  const areaStats = document.getElementById('statsArea');
  areaStats.innerHTML = "";
  const statsMap = [{k:'vida', l:'Vida', color:'var(--primary)'}, {k:'energia', l:'Energia', color:'var(--energy)'}, {k:'vigor', l:'Vigor', color:'var(--vigor)'}, {k:'integridade', l:'Integ.', color:'var(--integridade)'}];
  statsMap.forEach(s => {
    const st = f[s.k] || {atual:0, max:0};
    const pct = st.max > 0 ? Math.min(100, (st.atual/st.max)*100) : 0;
    areaStats.innerHTML += `<div class="stat-row"><div class="stat-head"><span>${s.l}</span><div><span class="editable" onclick="editarCampo(this, '${s.k}.atual', 'number')">${st.atual}</span> / <span class="editable" onclick="editarCampo(this, '${s.k}.max', 'number')">${st.max}</span></div></div><div class="bar-bg"><div class="bar-fill" style="width:${pct}%; background:${s.color}; box-shadow: 0 0 8px ${s.color};"></div></div><div class="stat-ctrl"><div class="btn-calc" onclick="mathStat(this, '${s.k}')">üî¢</div><div class="btn-mini" onclick="upStat('${s.k}', -1)">-</div><div class="btn-mini" onclick="upStat('${s.k}', 1)">+</div></div></div>`;
  });

  renderDerivados(totalLevel);
  renderHabilidadesClasse();
  renderInventario();

  const attacksArea = document.getElementById('combatAttacksArea');
  attacksArea.innerHTML = "";
  const cCorpo = f.combate?.corpo || {};
  const modFor = Math.floor(((f.atributos?.forca || 10) - 10) / 2);
  const modDes = Math.floor(((f.atributos?.destreza || 10) - 10) / 2);
  const attrCorpo = cCorpo.usaDes ? modDes : modFor;
  const metadeNivel = Math.floor(totalLevel / 2);
  const bonusTreino = 2 + Math.floor((totalLevel - 1) / 4);
  let totCorpo = attrCorpo + metadeNivel + (cCorpo.treino ? bonusTreino : 0) + (cCorpo.outros || 0);
  attacksArea.innerHTML += `<div class="combat-card"><div class="cc-header">Corpo a Corpo <div class="btn-toggle-attr" onclick="toggleMeleeAttr()">${cCorpo.usaDes?'DES':'FOR'}</div></div><div class="cc-body">${totCorpo>=0?'+':''}${totCorpo}</div><div class="cc-footer"><div class="btn-train ${cCorpo.treino?'active':''}" onclick="toggleCombatTrain('corpo')">T</div><input class="bonus-input" placeholder="+" value="${cCorpo.outros||''}" onchange="setCombatOther('corpo', this.value)"></div></div>`;

  const cDist = f.combate?.distancia || {};
  let totDist = modDes + metadeNivel + (cDist.treino ? bonusTreino : 0) + (cDist.outros || 0);
  attacksArea.innerHTML += `<div class="combat-card"><div class="cc-header">Dist√¢ncia</div><div class="cc-body">${totDist>=0?'+':''}${totDist}</div><div class="cc-footer"><div class="btn-train ${cDist.treino?'active':''}" onclick="toggleCombatTrain('distancia')">T</div><input class="bonus-input" placeholder="+" value="${cDist.outros||''}" onchange="setCombatOther('distancia', this.value)"></div></div>`;
  
  const cMagic = f.combate?.magico || {};
  const valMagic = (f.atributos && f.atributos[cMagic.atributo || 'inteligencia']) || 10;
  const modMagic = Math.floor((valMagic - 10) / 2);
  let totMagic = modMagic + metadeNivel + bonusTreino + (cMagic.outros || 0);
  attacksArea.innerHTML += `<div class="combat-card"><div class="cc-header">Amaldi√ßoado <select class="mini-select" onchange="setMagicAttr(this.value)">${Object.keys(ATR_SHORT).map(k => `<option value="${k}" ${k===(cMagic.atributo||'inteligencia')?'selected':''}>${ATR_SHORT[k]}</option>`).join('')}</select></div><div class="cc-body">${totMagic>=0?'+':''}${totMagic}</div><div class="cc-footer"><span style="font-size:0.7rem; color:var(--energy);">[T]</span><input class="bonus-input" placeholder="+" value="${cMagic.outros||''}" onchange="setCombatOther('magico', this.value)"></div></div>`;

  const resistArea = document.getElementById('combatResistArea');
  resistArea.innerHTML = "";
  const resistencias = [{ k: 'astucia', l: 'Ast√∫cia', a: 'inteligencia' }, { k: 'fortitude', l: 'Fortitude', a: 'constituicao' }, { k: 'integridade', l: 'Integ.', a: 'constituicao' }, { k: 'reflexos', l: 'Reflexos', a: 'destreza' }, { k: 'vontade', l: 'Vontade', a: 'sabedoria' }];
  resistencias.forEach(res => {
    const rData = (f.combate && f.combate[res.k]) || {};
    const rVal = (f.atributos && f.atributos[res.a]) ? f.atributos[res.a] : 10;
    const rMod = Math.floor((rVal - 10) / 2);
    let rTotal = rMod + metadeNivel + (rData.treino ? bonusTreino : 0) + (rData.outros || 0);
    resistArea.innerHTML += `<div class="combat-card"><div class="cc-header">${res.l}</div><div class="cc-body" style="font-size:1.5rem;">${rTotal>=0?'+':''}${rTotal}</div><div class="cc-footer"><div class="btn-train ${rData.treino?'active':''}" onclick="toggleCombatTrain('${res.k}')">T</div><input class="bonus-input" placeholder="+" value="${rData.outros||''}" onchange="setCombatOther('${res.k}', this.value)"></div></div>`;
  });

  const containerApt = document.getElementById('listaAptidoes');
  containerApt.innerHTML = "";
  const todasAptidoes = [...APTIDOES_BASE, ...(ficha.aptidoesCustom || [])];
  todasAptidoes.forEach((apt, index) => {
    let nivelAtual = (ficha.progressoAptidoes || {})[apt.nome] || 0;
    if (!isMestre && nivelAtual === 0) return;
    let niveisHtml = "";
    if(apt.niveis) {
      apt.niveis.forEach((desc, idx) => {
        const lvl = idx + 1;
        const isUnlocked = lvl <= nivelAtual;
        if (!isMestre && !isUnlocked) return;
        const controls = isMestre ? `<div class="gm-controls"><div class="btn-gm" onclick="setAptidao('${apt.nome}', ${lvl})">üîì</div><div class="btn-gm" style="border-color:#d00000;color:#d00000;" onclick="setAptidao('${apt.nome}', ${lvl-1})">üîí</div></div>` : "";
        niveisHtml += `<div class="nivel-row ${isUnlocked ? 'unlocked' : ''}"><div class="nivel-check"></div><div style="flex-grow:1;">${desc}</div>${controls}</div>`;
      });
    }
    let editBtn = "";
    if (isMestre && index >= APTIDOES_BASE.length) {
      const realIndex = index - APTIDOES_BASE.length;
      editBtn = `<button class="btn-edit-apt" onclick="abrirEditorAptidao(${realIndex})">‚úé</button>`;
    }
    containerApt.innerHTML += `<div class="aptidao-box"><div class="aptidao-header" onclick="this.nextElementSibling.classList.toggle('open')"><span>${apt.nome} <span style="font-size:0.8rem;color:#666;">(${nivelAtual}/${apt.maxNivel})</span>${editBtn}</span><span>‚ñº</span></div><div class="aptidao-body"><div class="aptidao-desc">${apt.descricao || 'Sem descri√ß√£o.'}</div>${niveisHtml}</div></div>`;
  });

  const listaSkills = document.getElementById('skillsList');
  listaSkills.innerHTML = "";
  PERICIAS_DEF.forEach(p => {
    const attrVal = (f.atributos && f.atributos[p.a]) ? f.atributos[p.a] : 10;
    const modAttr = Math.floor((attrVal - 10) / 2);
    const saved = (f.pericias||{})[p.n] || { t: false, m: false, bonus: 0 };
    let total = modAttr + metadeNivel;
    if (saved.t) total += bonusTreino;
    if (saved.m) total += 1;
    total += Number(saved.bonus || 0);
    listaSkills.innerHTML += `<div class="skill-row"><span class="sk-name">${p.n}</span><span class="sk-attr">${ATR_SHORT[p.a]}</span><span class="sk-total">${total>=0?'+':''}${total}</span><div class="sk-btn-group"><input class="bonus-input" placeholder="0" value="${saved.bonus || ''}" onchange="setSkillBonus('${p.n}', this.value)"><div class="sk-btn ${saved.t ? 'active-t' : ''}" onclick="togglePericia('${p.n}', 't')">T</div><div class="sk-btn ${saved.m ? 'active-m' : ''}" onclick="togglePericia('${p.n}', 'm')">M</div></div></div>`;
  });
}

// === RENDER INVENT√ÅRIO ===
window.renderInventario = () => {
  const strMod = Math.floor(((ficha.atributos?.forca || 10) - 10) / 2);
  const limit = 8 + (strMod * 2); 
  const currentLoad = (ficha.inventario || []).reduce((acc, item) => acc + (Number(item.espacos)||0), 0);
  
  document.getElementById('loadVal').innerText = currentLoad;
  document.getElementById('loadMax').innerText = limit;
  document.getElementById('overburdenMsg').style.display = currentLoad > limit ? 'block' : 'none';
  
  const invList = document.getElementById('inventoryList');
  invList.innerHTML = "";
  const termo = document.getElementById('invSearch').value.toLowerCase();
  
  (ficha.inventario || []).forEach((item, idx) => {
    if(currentInvFilter !== 'todos' && item.tipo !== currentInvFilter) return;
    if(termo && !item.nome.toLowerCase().includes(termo)) return;

    const imgUrl = item.imagem || 'https://via.placeholder.com/100?text=Item';
    const isEquipped = item.equipado ? 'equipped' : '';

    invList.innerHTML += `
      <div class="inv-row" id="inv-row-${idx}">
        <div class="inv-summary" onclick="toggleInvRow(${idx})">
          <div class="inv-check ${isEquipped}" onclick="event.stopPropagation(); toggleEquipItem(${idx})">‚úî</div>
          <div class="inv-main-info">
             <div class="inv-name">${item.nome}</div>
             <div class="inv-mini-stats">
                <span>Dano: <b>${item.dano || '-'}</b></span>
                <span>Crit: <b>${item.critico || '-'}</b></span>
             </div>
          </div>
          <div class="inv-expand-icon">‚ñº</div>
        </div>
        <div class="inv-details">
           <div>
             <div class="inv-stat-block">
               <div class="inv-stat-line"><span class="inv-stat-label">Tipo:</span> <span>${item.tipo || '-'} ‚Ä¢ Grau ${['Esp','1','2','3','4'][item.grau] || '-'}</span></div>
               <div class="inv-stat-line"><span class="inv-stat-label">Atk B√¥nus:</span> <span>${item.atkBonus || 0}</span></div>
               <div class="inv-stat-line"><span class="inv-stat-label">Tipo Dano:</span> <span>${item.tipoDano || '-'}</span></div>
               <div class="inv-stat-line"><span class="inv-stat-label">Alcance:</span> <span>${item.alcance || '-'}</span></div>
               <div class="inv-stat-line"><span class="inv-stat-label">Tipo Atk:</span> <span>${item.tipoAtaque || '-'}</span></div>
               <div class="inv-stat-line"><span class="inv-stat-label">Atributo:</span> <span>${item.atributo || '-'}</span></div>
               <div class="inv-stat-line"><span class="inv-stat-label">Espa√ßos:</span> <span>${item.espacos || 1}</span></div>
             </div>
             <p style="font-size:0.85rem; color:#aaa; margin-top:10px; white-space:pre-wrap;">${item.descricao || ''}</p>
             <div style="margin-top:10px;">
                ${(item.propriedades||[]).map(p => `<div><b style="color:var(--primary)">${p.nome}:</b> <span style="color:#ccc;font-size:0.8rem;">${p.desc}</span></div>`).join('')}
                ${(item.encantamentos||[]).map(e => `<div><b style="color:var(--energy)">${e.nome}:</b> <span style="color:#ccc;font-size:0.8rem;">${e.desc}</span></div>`).join('')}
             </div>
           </div>
           <div style="display:flex; flex-direction:column; gap:10px;">
             <img src="${imgUrl}" class="inv-img-preview">
           </div>
           <div class="inv-actions">
              <button class="btn-txt-del" onclick="excluirItem(${idx})">Remover</button>
              <button class="btn-txt-edit" onclick="abrirItemModal(${idx})">Editar</button>
           </div>
        </div>
      </div>
    `;
  });
};

window.filtrarInv = (cat, btn) => {
  currentInvFilter = cat;
  document.querySelectorAll('.inv-cat-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderInventario();
};
window.toggleInvRow = (idx) => { document.getElementById(`inv-row-${idx}`).classList.toggle('expanded'); };
window.toggleEquipItem = async (idx) => { ficha.inventario[idx].equipado = !ficha.inventario[idx].equipado; await updateDoc(doc(db, "fichas", id), { inventario: ficha.inventario }); renderInventario(); };

window.abrirItemModal = (index = -1) => { editingItemIndex = index; document.getElementById('itemModal').style.display = 'block'; document.getElementById('propList').innerHTML = ""; document.getElementById('encantList').innerHTML = ""; document.getElementById('btnExcluirItem').style.display = index === -1 ? 'none' : 'block'; document.getElementById('itemModalTitle').innerText = index === -1 ? 'Novo Item' : 'Editar Item'; if (index > -1) { const item = ficha.inventario[index]; document.getElementById('itNome').value = item.nome; document.getElementById('itTipo').value = item.tipo; document.getElementById('itGrau').value = item.grau; document.getElementById('itEspacos').value = item.espacos; document.getElementById('itBonus').value = item.bonus || ""; document.getElementById('itImg').value = item.imagem; document.getElementById('itDesc').value = item.descricao; document.getElementById('itDano').value = item.dano || ""; document.getElementById('itCritico').value = item.critico || ""; document.getElementById('itAlcance').value = item.alcance || ""; document.getElementById('itTipoDano').value = item.tipoDano || ""; document.getElementById('itTipoAtaque').value = item.tipoAtaque || ""; document.getElementById('itAtributo').value = item.atributo || ""; document.getElementById('itAtkBonus').value = item.atkBonus || 0; (item.propriedades || []).forEach(p => addPropField(p.nome, p.desc)); (item.encantamentos || []).forEach(e => addEncantField(e.nome, e.desc)); } else { document.getElementById('itNome').value = ""; document.getElementById('itEspacos').value = 1; document.getElementById('itBonus').value = ""; document.getElementById('itImg').value = ""; document.getElementById('itDesc').value = ""; document.getElementById('itDano').value = ""; document.getElementById('itCritico').value = ""; document.getElementById('itTipoAtaque').value = ""; } };
window.salvarItem = async () => { 
  const novoItem = { nome: document.getElementById('itNome').value || "Item", tipo: document.getElementById('itTipo').value, grau: document.getElementById('itGrau').value, espacos: Number(document.getElementById('itEspacos').value), bonus: document.getElementById('itBonus').value, imagem: document.getElementById('itImg').value, descricao: document.getElementById('itDesc').value, dano: document.getElementById('itDano').value, critico: document.getElementById('itCritico').value, alcance: document.getElementById('itAlcance').value, tipoDano: document.getElementById('itTipoDano').value, tipoAtaque: document.getElementById('itTipoAtaque').value, atributo: document.getElementById('itAtributo').value, atkBonus: Number(document.getElementById('itAtkBonus').value), propriedades: [], encantamentos: [] }; 
  document.querySelectorAll('#propList .dynamic-list-item').forEach(el => { novoItem.propriedades.push({ nome: el.querySelector('.prop-name').value, desc: el.querySelector('.prop-desc').value }); }); 
  document.querySelectorAll('#encantList .dynamic-list-item').forEach(el => { novoItem.encantamentos.push({ nome: el.querySelector('.encant-name').value, desc: el.querySelector('.encant-desc').value }); }); 
  if (!ficha.inventario) ficha.inventario = []; if (editingItemIndex === -1) ficha.inventario.push(novoItem); else ficha.inventario[editingItemIndex] = novoItem; await updateDoc(doc(db, "fichas", id), { inventario: ficha.inventario }); document.getElementById('itemModal').style.display = 'none'; 
};
window.excluirItem = async () => { if (editingItemIndex === -1) return; if (!confirm("Excluir?")) return; ficha.inventario.splice(editingItemIndex, 1); await updateDoc(doc(db, "fichas", id), { inventario: ficha.inventario }); document.getElementById('itemModal').style.display = 'none'; };

// ... (Mantenha as fun√ß√µes auxiliares do arquivo anterior para Aptid√µes, Habilidades Classe e SELETOR)
window.setDerivadoBonus = async (key, val) => { const derivados = ficha.derivados || {}; derivados[key] = Number(val); await updateDoc(doc(db, "fichas", id), { derivados: derivados }); };
window.toggleTransformacao = async (tipo) => { if (!ficha.transfUnlocked[tipo]) return; let novoEstado = null; if (ficha.transfActive === tipo) { novoEstado = null; if (tipo === 'apice') await aplicarSequela('exaustao'); if (tipo === 'corpo') await aplicarSequela('corrupcao'); } else { novoEstado = tipo; } await updateDoc(doc(db, "fichas", id), { transfActive: novoEstado }); };
async function aplicarSequela(tipo) { const seq = ficha.sequelas || {}; seq[tipo] = true; if (tipo === 'corrupcao') { const dano = (ficha.nivel || 1) * 2; const novoMax = Math.max(1, (ficha.vida.max - dano)); const novoAtual = Math.min(ficha.vida.atual, novoMax); await updateDoc(doc(db, "fichas", id), { sequelas: seq, "vida.max": novoMax, "vida.atual": novoAtual }); alert(`Transforma√ß√£o cessou. -${dano} Vida M√°xima.`); } else { await updateDoc(doc(db, "fichas", id), { sequelas: seq }); alert("Transforma√ß√£o cessou. Exaust√£o aplicada."); } }
window.gmUnlock = async (tipo) => { const unlocked = ficha.transfUnlocked || {}; unlocked[tipo] = true; await updateDoc(doc(db, "fichas", id), { transfUnlocked: unlocked }); };
window.gmClearDebuff = async () => { await updateDoc(doc(db, "fichas", id), { sequelas: { exaustao: false, corrupcao: false } }); alert("Sequelas removidas."); };
window.setSkillBonus = async (skillName, val) => { const pericias = ficha.pericias || {}; if (!pericias[skillName]) pericias[skillName] = { t: false, m: false, bonus: 0 }; pericias[skillName].bonus = Number(val); await updateDoc(doc(db, "fichas", id), { pericias: pericias }); };
window.setAptidao = async (nomeApt, novoNivel) => { if (!isMestre) return; const progresso = ficha.progressoAptidoes || {}; progresso[nomeApt] = novoNivel; await updateDoc(doc(db, "fichas", id), { progressoAptidoes: progresso }); };
window.addNovaAptidao = async () => { if (!isMestre) return; const nome = prompt("Nome da Nova Aptid√£o:"); if (!nome) return; const nova = { nome: nome, maxNivel: 5, descricao: "Descri√ß√£o...", niveis: ["NV 1...", "NV 2...", "NV 3...", "NV 4...", "NV 5..."] }; const custom = ficha.aptidoesCustom || []; custom.push(nova); await updateDoc(doc(db, "fichas", id), { aptidoesCustom: custom }); alert("Criada!"); };
window.abrirEditorAptidao = (index) => { editingAptIndex = index; const modal = document.getElementById('aptidaoEditorModal'); if(index > -1) { const apt = ficha.aptidoesCustom[index]; document.getElementById('editAptNome').value = apt.nome; document.getElementById('editAptDesc').value = apt.descricao; document.getElementById('editAptMax').value = apt.maxNivel; renderLevelInputs(apt.niveis); document.getElementById('btnExcluirApt').style.display = 'block'; } else { document.getElementById('editAptNome').value = ""; document.getElementById('editAptDesc').value = ""; document.getElementById('editAptMax').value = 5; renderLevelInputs(); document.getElementById('btnExcluirApt').style.display = 'none'; } modal.style.display = 'flex'; };
window.renderLevelInputs = (existingLevels = []) => { const max = Number(document.getElementById('editAptMax').value); const container = document.getElementById('editAptLevelsContainer'); container.innerHTML = ""; for(let i=0; i<max; i++) { const val = existingLevels[i] || ""; container.innerHTML += `<input class="inline-input" style="width:100%; text-align:left;" placeholder="Descri√ß√£o N√≠vel ${i+1}" value="${val}">`; } };
window.salvarAptidaoCustom = async () => { const max = Number(document.getElementById('editAptMax').value); const niveis = []; document.querySelectorAll('#editAptLevelsContainer input').forEach(input => niveis.push(input.value)); const novaApt = { nome: document.getElementById('editAptNome').value, descricao: document.getElementById('editAptDesc').value, maxNivel: max, niveis: niveis }; if(!ficha.aptidoesCustom) ficha.aptidoesCustom = []; if(editingAptIndex === -1) ficha.aptidoesCustom.push(novaApt); else ficha.aptidoesCustom[editingAptIndex] = novaApt; await updateDoc(doc(db, "fichas", id), { aptidoesCustom: ficha.aptidoesCustom }); document.getElementById('aptidaoEditorModal').style.display = 'none'; };
window.excluirAptidaoCustom = async () => { if(editingAptIndex === -1 || !confirm("Excluir?")) return; ficha.aptidoesCustom.splice(editingAptIndex, 1); await updateDoc(doc(db, "fichas", id), { aptidoesCustom: ficha.aptidoesCustom }); document.getElementById('aptidaoEditorModal').style.display = 'none'; };
window.abrirModalOrigem = (index = -1) => { editingOriginIndex = index; const modal = document.getElementById('origemModal'); if (index > -1) { const h = ficha.habilidadesOrigem[index]; document.getElementById('origemNome').value = h.nome; document.getElementById('origemDesc').value = h.desc; document.getElementById('origemModalTitle').innerText = "Editar Origem"; } else { document.getElementById('origemNome').value = ""; document.getElementById('origemDesc').value = ""; document.getElementById('origemModalTitle').innerText = "Nova Habilidade de Origem"; } modal.style.display = 'flex'; };
window.salvarOrigem = async () => { const nome = document.getElementById('origemNome').value; const desc = document.getElementById('origemDesc').value; if(!ficha.habilidadesOrigem) ficha.habilidadesOrigem = []; if(editingOriginIndex === -1) { ficha.habilidadesOrigem.push({ nome, desc }); } else { ficha.habilidadesOrigem[editingOriginIndex] = { nome, desc }; } await updateDoc(doc(db, "fichas", id), { habilidadesOrigem: ficha.habilidadesOrigem }); document.getElementById('origemModal').style.display = 'none'; };
window.excluirOrigem = async (index) => { if(!confirm("Excluir?")) return; ficha.habilidadesOrigem.splice(index, 1); await updateDoc(doc(db, "fichas", id), { habilidadesOrigem: ficha.habilidadesOrigem }); };
window.toggleCombatTrain = async (key) => { const combate = ficha.combate || {}; if (!combate[key]) combate[key] = { treino: false, outros: 0 }; combate[key].treino = !combate[key].treino; await updateDoc(doc(db, "fichas", id), { combate: combate }); };
window.setCombatOther = async (key, val) => { const combate = ficha.combate || {}; if (!combate[key]) combate[key] = { treino: false, outros: 0 }; combate[key].outros = Number(val); await updateDoc(doc(db, "fichas", id), { combate: combate }); };
window.toggleMeleeAttr = async () => { const combate = ficha.combate || {}; if (!combate.corpo) combate.corpo = { treino: false, outros: 0, usaDes: false }; combate.corpo.usaDes = !combate.corpo.usaDes; await updateDoc(doc(db, "fichas", id), { combate: combate }); };
window.setMagicAttr = async (attr) => { const combate = ficha.combate || {}; if (!combate.magico) combate.magico = { outros: 0, atributo: 'inteligencia' }; combate.magico.atributo = attr; await updateDoc(doc(db, "fichas", id), { combate: combate }); };
window.mathStat = (el, key) => { if(el.querySelector('input')) return; const originalHtml = el.innerHTML; el.innerHTML = ''; const input = document.createElement('input'); input.placeholder = "+/-"; input.className = 'math-input'; input.type = 'text'; el.appendChild(input); input.focus(); const executar = async () => { const val = input.value.trim(); if(!val) { el.innerHTML = originalHtml; return; } const num = Number(val); if(isNaN(num)) { el.innerHTML = originalHtml; return; } const st = ficha[key]; let novo = Number(st.atual) + num; novo = Math.max(0, Math.min(st.max, novo)); await updateDoc(doc(db, "fichas", id), { [`${key}.atual`]: novo }); el.innerHTML = originalHtml; }; input.addEventListener('blur', executar); input.addEventListener('keydown', (e) => { if(e.key === 'Enter') input.blur(); }); };
window.editarCampo = (el, field, type) => { if (el.querySelector('input')) return; editandoId = field; const valorAtual = el.innerText; el.innerHTML = `<input id="inputEdit" class="inline-input" type="${type}" value="${valorAtual}">`; const input = document.getElementById('inputEdit'); input.focus(); const salvar = async () => { let novoValor = input.value; if (type === 'number') novoValor = Number(novoValor); el.innerHTML = novoValor; editandoId = null; try { await updateDoc(doc(db, "fichas", id), { [field]: novoValor }); } catch (e) { console.error(e); el.innerText = valorAtual; } }; input.addEventListener('blur', salvar); input.addEventListener('keydown', (e) => { if (e.key === 'Enter') input.blur(); }); };
window.togglePericia = async (skillName, tipo) => { const pericias = ficha.pericias || {}; if (!pericias[skillName]) pericias[skillName] = { t: false, m: false }; pericias[skillName][tipo] = !pericias[skillName][tipo]; await updateDoc(doc(db, "fichas", id), { pericias: pericias }); };
window.upStat = async (key, val) => { const st = ficha[key]; const novo = Math.max(0, Math.min(st.max, Number(st.atual)+val)); await updateDoc(doc(db, "fichas", id), { [`${key}.atual`]: novo }); };
window.irParaShikigamis = () => { window.location = `shikigamis.html?charId=${id}`; };
window.irParaFeiticos = () => { window.location = `feiticos.html?id=${id}`; };
window.abrirConfig = () => { document.getElementById('configModal').style.display = 'block'; document.getElementById('editImgUrl').value = ficha.imagem || ""; };
window.salvarImg = async () => { await updateDoc(doc(db, "fichas", id), { imagem: document.getElementById('editImgUrl').value }); alert("Imagem atualizada!"); };
window.excluirPersonagem = async () => { if(prompt("Digite DELETAR para confirmar:")==="DELETAR") { await deleteDoc(doc(db, "fichas", id)); window.location="index.html"; } };
window.abrirClassManager = () => { const modal = document.getElementById('classManagerModal'); const listDiv = document.getElementById('currentClassesList'); const select = document.getElementById('newClassSelect'); listDiv.innerHTML = ""; ficha.classes.forEach((cls, idx) => { listDiv.innerHTML += `<div style="display:flex; justify-content:space-between; align-items:center; background:#111; padding:8px; margin-bottom:5px; border-radius:4px;"><span style="font-weight:bold; color:white;">${cls.nome}</span><div style="display:flex; align-items:center; gap:5px;"><span style="color:#aaa; font-size:0.8rem;">Nvl:</span><input type="number" value="${cls.nivel}" style="width:40px; padding:2px; text-align:center;" onchange="atualizarNivelClasse(${idx}, this.value)"><button onclick="removerClasse(${idx})" style="background:transparent; border:none; color:#d00000; cursor:pointer; font-weight:bold;">√ó</button></div></div>`; }); select.innerHTML = `<option value="">-- Selecionar --</option>`; Object.keys(HABILIDADES_CLASSE).forEach(nome => { if(!ficha.classes.some(c => c.nome === nome)) { select.innerHTML += `<option value="${nome}">${nome}</option>`; } }); modal.style.display = 'flex'; };
window.adicionarClasse = async () => { const nome = document.getElementById('newClassSelect').value; if(!nome) return; ficha.classes.push({ nome: nome, nivel: 1 }); await updateDoc(doc(db, "fichas", id), { classes: ficha.classes }); abrirClassManager(); renderFicha(); };
window.atualizarNivelClasse = async (index, novoNivel) => { ficha.classes[index].nivel = Number(novoNivel); await updateDoc(doc(db, "fichas", id), { classes: ficha.classes }); renderFicha(); };
window.removerClasse = async (index) => { if(!confirm("Remover esta classe?")) return; ficha.classes.splice(index, 1); await updateDoc(doc(db, "fichas", id), { classes: ficha.classes }); abrirClassManager(); renderFicha(); };
window.addPropField = (nome = "", desc = "") => { const div = document.createElement('div'); div.className = 'dynamic-list-item'; div.innerHTML = `<div style="flex-grow:1; display:flex; flex-direction:column; gap:5px;"><input placeholder="Nome" value="${nome}" class="prop-name"><textarea placeholder="Descri√ß√£o" class="prop-desc" style="height:50px;">${desc}</textarea></div><button class="btn-del-item" onclick="this.parentElement.remove()">‚úñ</button>`; document.getElementById('propList').appendChild(div); };
window.addEncantField = (nome = "", desc = "") => { const div = document.createElement('div'); div.className = 'dynamic-list-item'; div.innerHTML = `<div style="flex-grow:1; display:flex; flex-direction:column; gap:5px;"><input placeholder="Nome" value="${nome}" class="encant-name" style="border-color:var(--energy);"><textarea placeholder="Descri√ß√£o" class="encant-desc" style="height:50px;">${desc}</textarea></div><button class="btn-del-item" onclick="this.parentElement.remove()">‚úñ</button>`; document.getElementById('encantList').appendChild(div); };
window.abrirSeletor = (tipo) => { const modal = document.getElementById('selectionModal'); const listDiv = document.getElementById('selectOptionsList'); const filtersDiv = document.getElementById('selectorFilters'); listDiv.innerHTML = ""; filtersDiv.innerHTML = ""; let opcoes = []; if(tipo === 'item') { document.getElementById('selectTitle').innerText = "Itens Especiais"; opcoes = ITENS_ESPECIAIS; opcoes.sort((a,b) => a.custo - b.custo); } else if (tipo === 'propriedade') { document.getElementById('selectTitle').innerText = "Propriedades"; opcoes = [...PROPRIEDADES_GERAIS, ...PROPRIEDADES_ESPECIAIS]; filtersDiv.innerHTML = `<button class="btn-mini" onclick="filtrarOpcoes('Gerais')">Gerais</button><button class="btn-mini" onclick="filtrarOpcoes('Especiais')">Especiais</button>`; } else { document.getElementById('selectTitle').innerText = "Encantamentos"; opcoes = [...ENCANTAMENTOS_ARMAS, ...ENCANTAMENTOS_ESCUDOS, ...ENCANTAMENTOS_UNIFORMES]; filtersDiv.innerHTML = `<button class="btn-mini" onclick="filtrarOpcoes('Armas')">Armas</button><button class="btn-mini" onclick="filtrarOpcoes('Escudos')">Escudos</button><button class="btn-mini" onclick="filtrarOpcoes('Uniformes')">Uniformes</button>`; } renderOpcoes(opcoes, tipo); modal.style.display = 'flex'; };
window.filtrarOpcoes = (categoria) => { let lista = []; if(categoria === 'Gerais') lista = PROPRIEDADES_GERAIS; if(categoria === 'Especiais') lista = PROPRIEDADES_ESPECIAIS; if(categoria === 'Armas') lista = ENCANTAMENTOS_ARMAS; if(categoria === 'Escudos') lista = ENCANTAMENTOS_ESCUDOS; if(categoria === 'Uniformes') lista = ENCANTAMENTOS_UNIFORMES; const tipo = (categoria === 'Gerais' || categoria === 'Especiais') ? 'propriedade' : 'encantamento'; renderOpcoes(lista, tipo); };
function renderOpcoes(lista, tipo) { const container = document.getElementById('selectOptionsList'); container.innerHTML = ""; lista.forEach(item => { const itemStr = JSON.stringify(item).replace(/'/g, "\\'"); let display = ""; if(tipo === 'item') { display = `<div class="sel-option" onclick='addSelecionado(${itemStr}, "item")'><div style="display:flex; justify-content:space-between;"><div class="sel-title">${item.nome}</div><div style="font-size:0.7rem; color:var(--energy);">Custo ${item.custo}</div></div><div class="sel-desc">${item.desc}</div></div>`; } else { display = `<div class="sel-option" onclick='addSelecionado(${itemStr}, "${tipo}")'><div class="sel-title">${item.nome}</div><div class="sel-desc">${item.desc}</div></div>`; } container.innerHTML += display; }); }
window.addSelecionado = (item, tipo) => { if(tipo === 'item') { document.getElementById('itNome').value = item.nome; document.getElementById('itTipo').value = item.tipo; const grauMap = {1:"4", 2:"3", 3:"2", 4:"1"}; if(grauMap[item.custo]) document.getElementById('itGrau').value = grauMap[item.custo]; document.getElementById('itDesc').value = item.desc; } else if (tipo === 'propriedade') { addPropField(item.nome, item.desc); } else { addEncantField(item.nome, item.desc); } document.getElementById('selectionModal').style.display = 'none'; };

function renderDerivados(totalLevel) {
  const desMod = Math.floor((ficha.atributos.destreza - 10) / 2);
  const sabMod = Math.floor((ficha.atributos.sabedoria - 10) / 2);
  const metadeNivel = Math.floor(totalLevel / 2);
  const bonusTreino = 2 + Math.floor(((totalLevel||1)-1)/4);
  const defBonus = Number(ficha.derivados.defesa || 0);
  const defesa = 10 + desMod + metadeNivel + defBonus;
  document.getElementById('valDefesa').innerText = defesa;
  document.getElementById('bonusDef').value = ficha.derivados.defesa || "";
  const pSaved = (ficha.pericias && ficha.pericias["Percep√ß√£o"]) || {t:false, m:false, bonus:0};
  let percTotal = sabMod + metadeNivel + Number(pSaved.bonus || 0);
  if(pSaved.t) percTotal += bonusTreino;
  if(pSaved.m) percTotal += 1;
  const atencaoBonus = Number(ficha.derivados.atencao || 0);
  const atencao = 10 + percTotal + atencaoBonus;
  document.getElementById('valAtencao').innerText = isNaN(atencao) ? 10 : atencao;
  document.getElementById('bonusAtencao').value = ficha.derivados.atencao || "";
  const iniBonus = Number(ficha.derivados.iniciativa || 0);
  const iniciativa = desMod + iniBonus;
  document.getElementById('valIniciativa').innerText = (iniciativa>=0?'+':'') + iniciativa;
  document.getElementById('bonusIniciativa').value = ficha.derivados.iniciativa || "";
  const desBonus = Number(ficha.derivados.deslocamento || 0);
  const desloc = 9 + desBonus;
  document.getElementById('valDesloc').innerText = desloc + "m";
  document.getElementById('bonusDesloc').value = ficha.derivados.deslocamento || "";
}

function renderHabilidadesClasse() {
  const container = document.getElementById('classAbilitiesList');
  container.innerHTML = "";
  ficha.classes.forEach((clsObj) => {
    const classeNome = clsObj.nome;
    const nivelClasse = Number(clsObj.nivel || 1);
    container.innerHTML += `<h4 style="margin:10px 0 5px 0; color:var(--primary); text-transform:uppercase;">${classeNome} (N√≠vel ${nivelClasse})</h4>`;
    if (HABILIDADES_CLASSE[classeNome]) {
      HABILIDADES_CLASSE[classeNome].forEach((hab, habIdx) => {
        if (hab.nivel > nivelClasse) return;
        const uniqueKey = `${classeNome}-${habIdx}`;
        let content = "";
        if (hab.tipo === "selecao_unica") {
          const savedChoice = (ficha.escolhasClasse || {})[uniqueKey] || "";
          if(savedChoice) {
            let title = savedChoice.includes(":") ? savedChoice.split(":")[0] : savedChoice;
            let desc = savedChoice.includes(":") ? savedChoice.split(":").slice(1).join(":").trim() : "";
            content = `<div class="ability-card-display"><button class="btn-remove-ability" onclick="salvarEscolhaClasse('${uniqueKey}', '')">‚úé</button><div class="ability-card-title">${title}</div><div class="ability-card-desc">${desc}</div></div>`;
          } else { content = `<div class="ability-select-btn" onclick="openSelectionModal('${uniqueKey}', 'unica', ${habIdx}, '${classeNome}')"><span>‚ûï Selecionar: ${hab.nome}</span><span>‚û§</span></div>`; }
        } else if (hab.tipo === "selecao_multipla") {
          const savedChoices = (ficha.escolhasClasse || {})[uniqueKey] || []; 
          const qtdMax = hab.qtd || 2;
          savedChoices.forEach(choice => {
             const choiceObj = hab.opcoes.find(op => op.nome === choice || op === choice);
             const title = choiceObj.nome || choiceObj;
             const desc = choiceObj.desc || "";
             content += `<div class="ability-card-display"><button class="btn-remove-ability" onclick="toggleEscolhaMultipla('${uniqueKey}', '${title}', ${qtdMax}, {checked:false})">√ó</button><div class="ability-card-title">${title}</div><div class="ability-card-desc">${desc}</div></div>`;
          });
          if(savedChoices.length < qtdMax) { content += `<div class="ability-select-btn" onclick="openSelectionModal('${uniqueKey}', 'multipla', ${habIdx}, '${classeNome}', ${qtdMax})"><span>‚ûï Adicionar: ${hab.nome} (${savedChoices.length}/${qtdMax})</span><span>‚û§</span></div>`; }
        } else { content = `<div class="class-ability-box"><div class="class-ability-name">${hab.nome}</div><div class="class-ability-desc">${hab.desc}</div></div>`; }
        container.innerHTML += content;
      });
    }
  });
  const originContainer = document.getElementById('originAbilitiesList');
  originContainer.innerHTML = "";
  (ficha.habilidadesOrigem || []).forEach((h, i) => {
    originContainer.innerHTML += `<div class="class-ability-box" style="border-color:var(--vigor);"><div style="display:flex; justify-content:space-between;"><div class="class-ability-name" style="cursor:pointer;" onclick="abrirModalOrigem(${i})">${h.nome}</div><div style="display:flex; gap:5px;"><button class="btn-icon-tiny" onclick="abrirModalOrigem(${i})">‚úé</button><button class="btn-icon-tiny" style="color:#d00000;" onclick="excluirOrigem(${i})">√ó</button></div></div><div class="class-ability-desc">${h.desc}</div></div>`;
  });
}

// MODALS E FUN√á√ïES
window.openSelectionModal = (key, type, habIndex, className, max = 1) => { currentSelectionKey = key; currentSelectionType = type; currentSelectionMax = max; const hab = HABILIDADES_CLASSE[className][habIndex]; const listDiv = document.getElementById('selectOptionsList'); const modal = document.getElementById('selectionModal'); document.getElementById('selectTitle').innerText = hab.nome; listDiv.innerHTML = ""; const savedChoices = (ficha.escolhasClasse || {})[key] || []; hab.opcoes.forEach(op => { let title = "", desc = "", rawValue = ""; if(typeof op === 'string') { if(op.includes(":")) { const parts = op.split(":"); title = parts[0]; desc = parts.slice(1).join(":").trim(); } else { title = op; } rawValue = op; } else { title = op.nome; desc = op.desc; rawValue = op.nome; } if(type === 'multipla' && savedChoices.includes(title)) return; listDiv.innerHTML += `<div class="sel-option" onclick="confirmSelection('${rawValue.replace(/'/g, "\\'")}')"><div class="sel-title">${title}</div><div class="sel-desc">${desc}</div></div>`; }); modal.style.display = 'flex'; }
let currentSelectionKey = ""; let currentSelectionType = ""; let currentSelectionMax = 0;
window.confirmSelection = async (value) => { if(currentSelectionType === 'unica') { await salvarEscolhaClasse(currentSelectionKey, value); } else { let valToSave = value; await toggleEscolhaMultipla(currentSelectionKey, valToSave, currentSelectionMax, {checked:true}); } document.getElementById('selectionModal').style.display = 'none'; renderFicha(); }
window.salvarEscolhaClasse = async (key, valor) => { const escolhas = ficha.escolhasClasse || {}; escolhas[key] = valor; await updateDoc(doc(db, "fichas", id), { escolhasClasse: escolhas }); };
window.toggleEscolhaMultipla = async (key, valorOpcao, max, checkbox) => { const escolhas = ficha.escolhasClasse || {}; let listaAtual = escolhas[key] || []; if (checkbox.checked) { if (listaAtual.length >= max) return; listaAtual.push(valorOpcao); } else { listaAtual = listaAtual.filter(item => item !== valorOpcao); } escolhas[key] = listaAtual; await updateDoc(doc(db, "fichas", id), { escolhasClasse: escolhas }); };
</script>
</body>
</html>

