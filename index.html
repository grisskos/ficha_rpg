<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema Vanguarda RPG</title>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #e0e0e0; padding: 20px; margin: 0; }
    
    /* Layout */
    .container { max-width: 800px; margin: 0 auto; }
    h1, h2 { color: #ff5252; text-transform: uppercase; letter-spacing: 1px; text-align: center; }
    
    /* Inputs e Cards */
    .card { background: #1e1e1e; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #333; }
    input, textarea { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #444; background: #2c2c2c; color: white; box-sizing: border-box; }
    input:focus, textarea:focus { border-color: #ff5252; outline: none; }
    
    /* Bot√µes Gerais */
    button { padding: 12px; width: 100%; border: none; border-radius: 4px; background: #c62828; color: white; font-weight: bold; cursor: pointer; transition: 0.2s; }
    button:hover { background: #b71c1c; }
    button.secondary { background: #444; margin-top: 10px; }

    /* ESTILO DA FICHA DE PERSONAGEM */
    .ficha-container { 
        display: grid; 
        grid-template-columns: 120px 1fr; /* Imagem na esquerda, resto na direita */
        gap: 20px; 
        background: #252525; 
        padding: 20px; 
        border-radius: 8px; 
        border-left: 5px solid #ff5252; 
        margin-bottom: 20px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }

    /* Imagem do Personagem */
    .char-img { 
        width: 100%; 
        height: 120px; 
        object-fit: cover; 
        border-radius: 8px; 
        border: 2px solid #444;
        background: #000;
    }

    /* Barras de Status */
    .status-group { margin-bottom: 5px; }
    .status-label { display: flex; justify-content: space-between; font-size: 0.85em; color: #bbb; margin-bottom: 2px; }
    
    .bar-bg { background: #444; height: 16px; border-radius: 8px; overflow: hidden; position: relative; }
    .bar-fill { height: 100%; transition: width 0.3s ease; }
    .bar-text { position: absolute; width: 100%; text-align: center; line-height: 16px; font-size: 11px; font-weight: bold; text-shadow: 1px 1px 2px black; top:0; left:0;}

    /* Cores das Barras */
    .hp-bar { background: linear-gradient(90deg, #d32f2f, #f44336); } /* Vida Vermelha */
    .ep-bar { background: linear-gradient(90deg, #1976d2, #2196f3); } /* Energia Azul */
    .vp-bar { background: linear-gradient(90deg, #388e3c, #4caf50); } /* Vigor Verde */
    .ip-bar { background: linear-gradient(90deg, #7b1fa2, #9c27b0); } /* Integridade Roxa */

    /* Bot√µes de Dano/Cura Pequenos */
    .ctrl-btn { 
        background: #333; color: white; border: 1px solid #555; 
        width: 25px; height: 25px; border-radius: 50%; 
        font-size: 14px; cursor: pointer; display: inline-flex; 
        align-items: center; justify-content: center; margin-left: 5px;
    }
    .ctrl-btn:hover { background: #555; }

    /* Abas de Detalhes (Ataques/Itens) */
    .details-box { margin-top: 15px; grid-column: span 2; background: #1e1e1e; padding: 10px; border-radius: 5px; }
    .details-title { font-size: 0.9em; color: #ff5252; border-bottom: 1px solid #444; margin-bottom: 5px; padding-bottom: 2px; }
    .details-content { font-size: 0.85em; color: #ccc; white-space: pre-wrap; }

    /* Responsivo para celular */
    @media (max-width: 600px) {
        .ficha-container { grid-template-columns: 1fr; }
        .char-img { height: 200px; margin: 0 auto; display: block; }
        .details-box { grid-column: span 1; }
    }
  </style>
</head>
<body>

<div class="container">
  <h1>Vanguarda RPG</h1>

  <div class="card" id="loginCard">
    <h2>Acesso</h2>
    <input id="emailInput" type="email" placeholder="Email" />
    <input id="passInput" type="password" placeholder="Senha" />
    <button onclick="fazerLogin()">Entrar</button>
    <button class="secondary" onclick="criarConta()">Criar Nova Conta</button>
  </div>

  <div id="userArea" style="display:none;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <span id="userInfo" style="color:#888;"></span>
        <button onclick="fazerLogout()" style="width:auto; padding: 5px 15px; background: #333;">Sair</button>
    </div>

    <div id="mestrePanel" class="card" style="display:none; border-color: #ffd700;">
      <h2 style="color:#ffd700">Painel do Mestre</h2>
      <textarea id="mestreNotes" rows="5" placeholder="Anota√ß√µes da campanha..."></textarea>
      <button onclick="salvarNotasMestre()" style="background:#b8860b">Salvar Notas</button>
    </div>

    <div class="card">
      <h2>Criar Personagem</h2>
      <div style="display:flex; gap:10px;">
          <input id="nomeChar" placeholder="Nome do Personagem" style="flex:2" />
          <input id="imgChar" placeholder="URL da Imagem (Link direto jpg/png)" style="flex:3" />
      </div>
      
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
          <input id="vidaMax" type="number" placeholder="Vida M√°xima" />
          <input id="energiaMax" type="number" placeholder="Energia M√°xima" />
          <input id="vigorMax" type="number" placeholder="Vigor M√°ximo" />
          <input id="integridadeMax" type="number" placeholder="Integridade M√°xima" />
      </div>

      <textarea id="ataques" placeholder="Lista de Ataques" rows="2"></textarea>
      <textarea id="habilidades" placeholder="Habilidades / Magias" rows="2"></textarea>
      <textarea id="itens" placeholder="Invent√°rio / Itens" rows="2"></textarea>
      
      <button onclick="criarFicha()">Criar Ficha</button>
    </div>

    <h2>Personagens em Jogo</h2>
    <div id="listaFichas"></div>
  </div>
</div>

<script>
  // --------------------------
  // CONFIGURA√á√ÉO DO FIREBASE
  // --------------------------
  const firebaseConfig = {
    apiKey: "AIzaSyAANME6i8psLUlX13AAi3PBgnd0IIvaY5Y",
    authDomain: "ficharpg-edc5c.firebaseapp.com",
    projectId: "ficharpg-edc5c",
    storageBucket: "ficharpg-edc5c.appspot.com",
    messagingSenderId: "522630132698",
    appId: "1:522630132698:web:30d3dc6f103916d70246e3",
    measurementId: "G-6PJKQYBRRC"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  const EMAIL_DO_MESTRE = "mestre@rpg.com";

  // --------------------------
  // AUTENTICA√á√ÉO
  // --------------------------
  auth.onAuthStateChanged(user => {
    if (user) {
      document.getElementById('loginCard').style.display = 'none';
      document.getElementById('userArea').style.display = 'block';
      document.getElementById('userInfo').innerText = user.email;

      if (user.email === EMAIL_DO_MESTRE) {
        document.getElementById('mestrePanel').style.display = 'block';
        carregarNotasMestre();
        carregarTodasFichas(); // Mestre v√™ tudo
      } else {
        document.getElementById('mestrePanel').style.display = 'none';
        carregarMinhasFichas(user.uid); // Jogador v√™ s√≥ as dele
      }
    } else {
      document.getElementById('loginCard').style.display = 'block';
      document.getElementById('userArea').style.display = 'none';
    }
  });

  function fazerLogin() {
    const e = document.getElementById('emailInput').value;
    const p = document.getElementById('passInput').value;
    auth.signInWithEmailAndPassword(e, p).catch(err => alert(err.message));
  }

  function criarConta() {
    const e = document.getElementById('emailInput').value;
    const p = document.getElementById('passInput').value;
    auth.createUserWithEmailAndPassword(e, p).then(()=>alert("Criado!")).catch(err=>alert(err.message));
  }
  function fazerLogout() { auth.signOut(); }

  // --------------------------
  // L√ìGICA DE FICHAS (CRUD)
  // --------------------------

  function criarFicha() {
    const user = auth.currentUser;
    if (!user) return;

    // Pega os valores m√°ximos
    const vMax = Number(document.getElementById('vidaMax').value);
    const eMax = Number(document.getElementById('energiaMax').value);
    const viMax = Number(document.getElementById('vigorMax').value);
    const iMax = Number(document.getElementById('integridadeMax').value);

    db.collection('fichas').add({
        uid: user.uid,
        dono: user.email,
        nome: document.getElementById('nomeChar').value,
        imagem: document.getElementById('imgChar').value || "https://via.placeholder.com/150",
        
        // Salvamos Atual e M√°ximo separados
        vida: { atual: vMax, max: vMax },
        energia: { atual: eMax, max: eMax },
        vigor: { atual: viMax, max: viMax },
        integridade: { atual: iMax, max: iMax },

        ataques: document.getElementById('ataques').value,
        habilidades: document.getElementById('habilidades').value,
        itens: document.getElementById('itens').value,
        
        dataCriacao: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
        alert("Personagem Criado!");
        // Limpa inputs b√°sicos
        document.getElementById('nomeChar').value = "";
    });
  }

  function carregarMinhasFichas(uid) {
    db.collection('fichas').where('uid', '==', uid).orderBy('dataCriacao', 'desc')
      .onSnapshot(renderizarFichas);
  }

  function carregarTodasFichas() {
    db.collection('fichas').orderBy('dataCriacao', 'desc')
      .onSnapshot(renderizarFichas);
  }

  // Essa fun√ß√£o gera o HTML de cada barra
  function gerarBarra(docId, label, corClasse, objDados, campoDb) {
      // Calcula %
      const pct = Math.max(0, Math.min(100, (objDados.atual / objDados.max) * 100));
      
      return `
      <div class="status-group">
          <div class="status-label">
              <span>${label}</span>
              <span>
                  <button class="ctrl-btn" onclick="alterarStat('${docId}', '${campoDb}', -1)">-</button>
                  ${objDados.atual} / ${objDados.max}
                  <button class="ctrl-btn" onclick="alterarStat('${docId}', '${campoDb}', 1)">+</button>
              </span>
          </div>
          <div class="bar-bg">
              <div class="bar-fill ${corClasse}" style="width: ${pct}%"></div>
              <div class="bar-text">${pct.toFixed(0)}%</div>
          </div>
      </div>`;
  }

  function renderizarFichas(snapshot) {
    const lista = document.getElementById('listaFichas');
    lista.innerHTML = '';

    snapshot.forEach(doc => {
        const f = doc.data();
        const id = doc.id;
        
        // Tratamento de erro caso a imagem esteja quebrada ou vazia
        const imgUrl = f.imagem ? f.imagem : "https://via.placeholder.com/150?text=Sem+Foto";

        const div = document.createElement('div');
        div.className = 'ficha-container';
        div.innerHTML = `
            <div>
                <img src="${imgUrl}" class="char-img" onerror="this.src='https://via.placeholder.com/150?text=Erro'">
                <div style="text-align:center; margin-top:5px; font-size:0.8em; color:#666;">${f.dono}</div>
            </div>

            <div>
                <strong style="font-size:1.4em; color:white;">${f.nome}</strong>
                <hr style="border-color:#333; margin: 10px 0;">

                ${gerarBarra(id, "Vida", "hp-bar", f.vida, "vida")}
                ${gerarBarra(id, "Energia", "ep-bar", f.energia, "energia")}
                ${gerarBarra(id, "Vigor", "vp-bar", f.vp-bar, "vigor")} ${gerarBarra(id, "Integridade", "ip-bar", f.integridade, "integridade")}
            </div>

            <div class="details-box">
                <div class="details-title">‚öîÔ∏è Ataques</div>
                <div class="details-content">${f.ataques || "Nenhum"}</div>
            </div>
            <div class="details-box">
                <div class="details-title">‚ú® Habilidades</div>
                <div class="details-content">${f.habilidades || "Nenhuma"}</div>
            </div>
            <div class="details-box">
                <div class="details-title">üéí Itens</div>
                <div class="details-content">${f.itens || "Vazio"}</div>
            </div>
        `;
        lista.appendChild(div);
    });
  }

  // Fun√ß√£o para dar dano ou curar (atualiza o banco)
  window.alterarStat = function(docId, campo, valor) {
    const docRef = db.collection('fichas').doc(docId);
    
    db.runTransaction(transaction => {
        return transaction.get(docRef).then(doc => {
            if (!doc.exists) return;
            const dados = doc.data();
            const stat = dados[campo]; // Ex: dados['vida']

            let novoAtual = stat.atual + valor;
            // Garante que n√£o passa do M√°ximo nem fica menor que 0
            if (novoAtual > stat.max) novoAtual = stat.max;
            if (novoAtual < 0) novoAtual = 0;

            // Atualiza apenas o campo espec√≠fico (ex: vida.atual)
            const updateObj = {};
            updateObj[`${campo}.atual`] = novoAtual;
            
            transaction.update(docRef, updateObj);
        });
    }).catch(err => console.error("Erro ao atualizar:", err));
  };

  // Mestre
  function salvarNotasMestre() {
    db.collection('mestre').doc('painel').set({ anotacoes: document.getElementById('mestreNotes').value });
  }
  function carregarNotasMestre() {
    db.collection('mestre').doc('painel').onSnapshot(doc => { if (doc.exists) document.getElementById('mestreNotes').value = doc.data().anotacoes; });
  }

</script>
</body>
</html>
