<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Ficha RPG</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root { 
    --bg: #0f0f0f; --card: #141414; 
    --primary: #e63946; --energy: #58E8DA; --vigor: #69E858; --integridade: #D073FA; 
    --apice: #f4d35e; --corpo: #9d4edd;
    --text: #f1f1f1; --dim: #888;
  }
  
  body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; padding: 20px; margin: 0; }
  
  /* === LAYOUT === */
  .main-layout { display: grid; grid-template-columns: 280px 1fr 300px; gap: 20px; max-width: 1600px; margin: 0 auto; padding-bottom: 80px; }
  @media (max-width: 1200px) { .main-layout { grid-template-columns: 280px 1fr; } }
  @media (max-width: 900px) { .main-layout { grid-template-columns: 1fr; } }

  .col-side, .col-center, .col-right { display: flex; flex-direction: column; gap: 20px; }
  .card { background: var(--card); padding: 20px; border-radius: 10px; border: 1px solid #2a2a2a; position: relative; }

  /* HEADER */
  .char-header { text-align: center; }
  .transf-container { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; }
  .transf-btn { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #444; background: #222; color: #555; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
  .transf-btn.locked { opacity: 0.5; cursor: not-allowed; }
  .transf-btn.unlocked { border-color: #fff; color: #fff; box-shadow: 0 0 5px rgba(255,255,255,0.2); }
  .transf-btn.apice.unlocked { border-color: var(--apice); color: var(--apice); }
  .transf-btn.apice.active { background: var(--apice); color: #000; box-shadow: 0 0 15px var(--apice); animation: pulse 2s infinite; }
  .transf-btn.corpo.unlocked { border-color: var(--corpo); color: var(--corpo); }
  .transf-btn.corpo.active { background: var(--corpo); color: #fff; box-shadow: 0 0 15px var(--corpo); animation: pulse 2s infinite; }
  @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 255, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); } }
  .char-img { width: 140px; height: 140px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); margin-bottom: 10px; }
  .char-name { font-size: 1.5rem; margin: 0; color: white; text-transform: uppercase; letter-spacing: 1px; }
  .badges { display: flex; justify-content: center; gap: 5px; flex-wrap: wrap; margin-top: 8px; }
  .badge { font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; background: #222; border: 1px solid #444; color: #ccc; }
  .b-lvl { color: white; border-color: white; font-weight: bold; }
  .b-cls { color: var(--primary); border-color: var(--primary); }
  .sequela-tag { display: block; background: #300; color: #f55; border: 1px solid #f00; padding: 5px; font-size: 0.8rem; border-radius: 4px; margin-top: 5px; text-align: center; }

  /* TOKENS & UTILS */
  .shiki-container { display: flex; justify-content: center; gap: 8px; margin-top: 15px; flex-wrap: wrap; border-top: 1px solid #222; padding-top: 15px; }
  .shiki-token { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--energy); background: #000; object-fit: cover; cursor: pointer; transition: transform 0.2s; }
  .shiki-token:hover { transform: scale(1.15); box-shadow: 0 0 10px var(--energy); }
  .shiki-add { width: 40px; height: 40px; border-radius: 50%; border: 2px dashed #444; display: flex; align-items: center; justify-content: center; color: #555; cursor: pointer; font-size: 1.2rem; transition: 0.2s; }
  .shiki-add:hover { border-color: var(--energy); color: var(--energy); }
  .editable { cursor: pointer; border-bottom: 1px dashed #555; transition: 0.2s; display: inline-block; min-width: 20px; text-align: center; }
  .editable:hover { color: var(--primary); border-color: var(--primary); background: rgba(255,255,255,0.05); }
  .inline-input { background: #000; color: white; border: 2px solid var(--primary); border-radius: 4px; padding: 4px; font-family: inherit; font-size: inherit; width: 80px; text-align: center; outline: none; }
  .math-input { width: 40px; background: #fff; color: #000; border: none; border-radius: 3px; text-align: center; font-weight: bold; outline: none; }

  /* ATRIBUTOS & BARRAS */
  .attr-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .attr-box { background: #222; padding: 8px; border-radius: 6px; text-align: center; border: 1px solid #333; }
  .attr-lbl { font-size: 0.7rem; color: var(--dim); display: block; font-weight: bold; }
  .attr-val { font-size: 1.4rem; font-weight: bold; display: block; margin: 2px 0; color: var(--text); }
  .attr-raw { font-size: 0.8rem; color: #777; background: #111; padding: 2px 6px; border-radius: 3px; }
  .stat-row { margin-bottom: 12px; }
  .stat-head { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 4px; color: #ddd; font-weight: bold; }
  .bar-bg { background: #333; height: 10px; border-radius: 5px; overflow: hidden; }
  .bar-fill { height: 100%; transition: width 0.3s; }
  .stat-ctrl { display: flex; justify-content: flex-end; gap: 5px; margin-top: 4px; }
  .btn-mini { background: #222; border: 1px solid #444; color: #ccc; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
  .btn-mini:hover { border-color: white; color: white; background: #333; }
  .btn-calc { background: #222; border: 1px solid #555; color: #ccc; width: 50px; height: 30px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-right: auto; transition: 0.2s; }
  .btn-calc:hover { border-color: var(--energy); color: var(--energy); }

  /* COMBATE */
  .section-header { background: #111; color: var(--primary); padding: 8px; text-align: center; border: 1px solid #333; border-radius: 5px; margin: 0 0 10px 0; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; display: flex; justify-content: space-between; align-items: center; }
  .combat-grid { display: grid; gap: 10px; margin-bottom: 20px; } .cols-3 { grid-template-columns: repeat(3, 1fr); } .cols-5 { grid-template-columns: repeat(5, 1fr); }
  @media (max-width: 600px) { .cols-3 { grid-template-columns: 1fr; } .cols-5 { display: flex; overflow-x: auto; padding-bottom: 10px; } .combat-card { min-width: 80px; } }
  .combat-card { background: #1a1a1a; border: 1px solid var(--primary); border-radius: 6px; display: flex; flex-direction: column; overflow: hidden; text-align: center; }
  .cc-header { background: var(--primary); color: white; padding: 5px; font-size: 0.75rem; font-weight: bold; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 35px; }
  .cc-body { padding: 10px 0; font-size: 1.8rem; font-weight: bold; color: white; flex-grow: 1; background: #1a1a1a; }
  .cc-footer { background: #000; padding: 5px; display: flex; justify-content: center; align-items: center; gap: 5px; border-top: 1px solid #333; }
  .btn-toggle-attr { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.5); color: white; font-size: 0.6rem; padding: 1px 4px; border-radius: 3px; cursor: pointer; margin-top: 2px; }
  .bonus-input { background: #222; border: 1px solid #444; color: #aaa; width: 30px; text-align: center; padding: 2px; border-radius: 4px; font-size: 0.8rem; }
  .btn-train { width: 20px; height: 20px; border: 1px solid #444; background: #222; color: #666; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; border-radius: 3px; cursor: pointer; font-weight: bold; }
  .btn-train.active { background: var(--energy); border-color: var(--energy); color: #000; }
  select.mini-select { background: rgba(0,0,0,0.3); border: none; color: white; font-size: 0.6rem; max-width: 80px; margin-top: 2px; }
  select.mini-select option { background: #222; color: #fff; }

  /* VALORES ADICIONAIS */
  .derived-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .derived-box { background: #1a1a1a; border: 1px solid #333; border-radius: 6px; padding: 10px; text-align: center; }
  .derived-label { font-size: 0.7rem; color: var(--energy); font-weight: bold; text-transform: uppercase; margin-bottom: 5px; }
  .derived-value { font-size: 1.6rem; font-weight: bold; color: #fff; }
  .derived-calc { display: flex; justify-content: center; margin-top: 5px; }
  .derived-calc input { background: #111; border: 1px solid #444; color: #aaa; width: 40px; text-align: center; border-radius: 3px; font-size: 0.8rem; }
  .derived-calc input:focus { border-color: var(--energy); color: white; outline: none; }

  /* PER√çCIAS */
  .skills-card { padding: 0; overflow: hidden; height: 100%; }
  .skills-header { padding: 15px; background: #222; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
  .skills-header h3 { margin: 0; font-size: 1.1rem; color: var(--primary); }
  .skill-row { display: flex; align-items: center; padding: 4px 10px; border-bottom: 1px solid #222; font-size: 0.8rem; }
  .skill-row:hover { background: #1b1b1b; }
  .sk-name { flex-grow: 1; color: #999; font-weight: 500; }
  .sk-attr { font-size: 0.65rem; color: #444; width: 30px; text-transform: uppercase; font-weight: bold; }
  .sk-total { font-weight: bold; color: white; width: 30px; text-align: right; margin-right: 10px; font-size: 0.9rem; }
  .sk-btn-group { display: flex; gap: 3px; align-items: center; }
  .sk-btn { width: 20px; height: 20px; border-radius: 3px; border: 1px solid #333; background: #111; color: #555; font-size: 0.6rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
  .sk-btn:hover { border-color: #777; color: #aaa; }
  .sk-btn.active-t { background: rgba(88, 232, 218, 0.1); border-color: var(--energy); color: var(--energy); }
  .sk-btn.active-m { background: rgba(230, 57, 70, 0.1); border-color: var(--primary); color: var(--primary); }

  /* INVENT√ÅRIO & APTID√ïES */
  .inv-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
  .inv-card { background: #1a1a1a; border: 1px solid #444; border-radius: 6px; overflow: hidden; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; }
  .inv-card:hover { border-color: white; transform: translateY(-3px); }
  .inv-card.grade-4 { border-left: 3px solid #888; } .inv-card.grade-3 { border-left: 3px solid #4cc9f0; } .inv-card.grade-2 { border-left: 3px solid #4361ee; } .inv-card.grade-1 { border-left: 3px solid #f72585; } .inv-card.grade-0 { border-left: 3px solid #ff9e00; box-shadow: 0 0 5px #ff9e00; }
  .inv-img { width: 100%; height: 80px; object-fit: cover; background: #000; }
  .inv-body { padding: 8px; flex-grow: 1; display: flex; flex-direction: column; gap: 3px; }
  .inv-title { font-weight: bold; font-size: 0.9rem; color: #fff; line-height: 1.1; }
  .inv-type { font-size: 0.7rem; color: #aaa; text-transform: uppercase; }
  .inv-stats { font-size: 0.75rem; color: var(--energy); font-weight: bold; margin-top: auto; }
  .inv-slots { font-size: 0.7rem; color: #666; text-align: right; margin-top: 5px; }
  .load-bar-container { background: #111; border: 1px solid #333; border-radius: 5px; height: 20px; position: relative; margin-bottom: 15px; overflow: hidden; }
  .load-fill { height: 100%; width: 0%; background: #2a9d8f; transition: 0.3s; }
  .load-text { position: absolute; top: 0; left: 0; width: 100%; text-align: center; font-size: 0.8rem; line-height: 20px; color: #fff; text-shadow: 0 0 3px #000; }
  .load-fill.over { background: #e9c46a; } .load-fill.full { background: #e63946; }
  .overburden-warning { color: #e63946; font-size: 0.8rem; text-align: center; display: none; margin-top: -10px; margin-bottom: 10px; font-weight: bold; }

  .aptidao-box { margin-bottom: 10px; border: 1px solid #333; border-radius: 6px; overflow: hidden; }
  .aptidao-header { background: #222; padding: 10px; font-weight: bold; color: var(--energy); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
  .aptidao-header:hover { background: #2a2a2a; }
  .aptidao-body { display: none; padding: 10px; background: #151515; }
  .aptidao-body.open { display: block; }
  .aptidao-desc { font-style: italic; color: #aaa; margin-bottom: 15px; font-size: 0.9rem; border-bottom: 1px solid #333; padding-bottom: 10px; white-space: pre-wrap; }
  .nivel-row { display: flex; align-items: flex-start; padding: 5px 0; border-bottom: 1px solid #222; font-size: 0.9rem; color: #555; white-space: pre-wrap; }
  .nivel-row.unlocked { color: #fff; } 
  .nivel-check { width: 15px; height: 15px; border: 1px solid #444; border-radius: 50%; margin-right: 10px; margin-top: 2px; flex-shrink: 0; }
  .unlocked .nivel-check { background: var(--energy); border-color: var(--energy); box-shadow: 0 0 5px var(--energy); }
  .gm-controls { display: none; margin-left: auto; gap: 5px; } 
  .gm-visible .gm-controls { display: flex; }
  .btn-gm { background: #333; border: 1px solid #555; color: #fff; width: 20px; height: 20px; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 3px; }
  .btn-gm:hover { border-color: var(--primary); color: var(--primary); }
  .btn-edit-apt { background: transparent; border: none; color: #666; cursor: pointer; font-size: 0.9rem; margin-left: 10px; }
  .btn-edit-apt:hover { color: var(--primary); }

  /* LISTAS & NAV */
  .list-box ul { padding-left: 20px; margin: 0; color: #ccc; } .list-box li { margin-bottom: 5px; }
  .btn-nav { background: transparent; width: 100%; padding: 10px; font-size: 1rem; cursor: pointer; border-radius: 5px; font-weight: bold; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 5px; border: 1px solid #444; color: #aaa; }
  .btn-summon { border-color: var(--integridade); color: var(--integridade); } .btn-summon:hover { background: var(--integridade); color: #000; }
  .btn-tech { border-color: var(--energy); color: var(--energy); } .btn-tech:hover { background: var(--energy); color: #000; }

  /* MODALS */
  .fab-config { position: fixed; bottom: 20px; right: 20px; background: #222; color: white; border: 2px solid #555; width: 50px; height: 50px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.6); z-index: 100; transition: 0.2s; }
  .fab-config:hover { background: var(--primary); border-color: var(--primary); }
  .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; padding: 20px; overflow-y: auto; }
  .modal-content { background: var(--card); padding: 20px; border-radius: 10px; max-width: 600px; margin: 20px auto; border: 1px solid #444; }
  .form-group { margin-bottom: 15px; }
  .form-group label { display: block; color: #aaa; margin-bottom: 5px; font-size: 0.8rem; font-weight: bold; }
  input, textarea, select { width: 100%; background: #000; border: 1px solid #333; color: white; padding: 8px; border-radius: 4px; outline: none; box-sizing: border-box; font-family: inherit; }
  textarea { height: 80px; resize: vertical; }
  .list-adder { margin-top: 10px; border-top: 1px solid #333; padding-top: 10px; }
  .dynamic-list-item { background: #111; padding: 8px; margin-bottom: 5px; border-radius: 4px; display: flex; gap: 10px; align-items: flex-start; }
  .btn-del-item { background: transparent; border: none; color: #d00000; cursor: pointer; font-size: 1.2rem; line-height: 1; }
  .btn-add-item { background: #222; border: 1px solid #444; color: #ccc; width: 100%; padding: 5px; cursor: pointer; margin-top: 5px; }
</style>
</head>
<body>

<div class="main-layout">
  <div class="col-side">
    <div class="card char-header">
      <div class="transf-container">
        <div id="btnApice" class="transf-btn apice locked" title="√Åpice Humano" onclick="toggleTransformacao('apice')">‚ö°</div>
        <div id="btnCorpo" class="transf-btn corpo locked" title="Corpo Amaldi√ßoado" onclick="toggleTransformacao('corpo')">üëπ</div>
      </div>
      <div id="statusSequela"></div>
      <img id="charImg" class="char-img" src="">
      <h2 class="char-name"><span class="editable" id="nomeDisplay" onclick="editarCampo(this, 'nome', 'text')">...</span></h2>
      <div id="badges" class="badges"></div>
      <div id="shikiTokens" class="shiki-container"></div>
    </div>
    <div class="card"><div id="atributosArea" class="attr-grid"></div><p style="text-align:center;font-size:0.7rem;color:#666;margin:0;">Clique para editar</p></div>
    <div class="card"><div id="statsArea"></div></div>
    <button class="btn-nav btn-summon" onclick="irParaShikigamis()">üê∫ Invoca√ß√µes</button>
    <button class="btn-nav btn-tech" onclick="irParaFeiticos()">‚ö° T√©cnicas & Artes</button>
    <button class="btn-mini" style="width:100%; padding:10px; font-size:1rem; margin-top:10px;" onclick="window.location='index.html'">Voltar para Lista</button>
  </div>

  <div class="col-center">
    <div class="card" style="padding:10px;">
      <h3 class="section-header">Jogadas de Ataque</h3>
      <div id="combatAttacksArea" class="combat-grid cols-3"></div>
      <h3 class="section-header" style="margin-top:20px;">Testes de Resist√™ncia</h3>
      <div id="combatResistArea" class="combat-grid cols-5"></div>
    </div>

    <div class="card">
      <div class="section-header" style="display:flex; justify-content:space-between; align-items:center; background:#111;">
        <span style="flex-grow:1; text-align:center;">Invent√°rio</span>
        <button class="btn-icon-sm" onclick="abrirItemModal()" title="Adicionar Item">+</button>
      </div>
      <div class="load-bar-container"><div id="loadFill" class="load-fill"></div><div id="loadText" class="load-text">0 / 8 Espa√ßos</div></div>
      <div id="overburdenMsg" class="overburden-warning">‚ö† SOBRECARREGADO</div>
      <div id="inventoryGrid" class="inv-grid"></div>
    </div>
    
    <div class="card" id="aptidoesCard">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h3 class="section-header" style="width:100%; margin:0;">Aptid√µes & Evolu√ß√£o</h3>
        <div id="gmControlsMain" style="display:none; gap:5px;">
          <button class="btn-mini" style="width:auto; padding:0 8px; font-size:0.7rem; border-color:var(--apice); color:var(--apice);" onclick="gmUnlock('apice')">Unlock √Åpice</button>
          <button class="btn-mini" style="width:auto; padding:0 8px; font-size:0.7rem; border-color:var(--corpo); color:var(--corpo);" onclick="gmUnlock('corpo')">Unlock Corpo</button>
          <button class="btn-mini" style="width:auto; padding:0 8px; font-size:0.7rem; border-color:#0f0; color:#0f0;" onclick="gmClearDebuff()">Curar Sequelas</button>
          <button class="btn-mini" style="width:auto; padding:0 8px;" onclick="addNovaAptidao()">+</button>
        </div>
      </div>
      <div id="listaAptidoes"></div>
    </div>
  </div>

  <div class="col-right">
    <div class="card">
      <h3 class="section-header" style="margin-bottom:10px;">Valores Adicionais</h3>
      <div class="derived-grid">
        <div class="derived-box">
          <div class="derived-label">DEFESA</div>
          <div class="derived-value" id="valDefesa">10</div>
          <div class="derived-calc"><input id="bonusDef" class="bonus-input" placeholder="B√¥nus" onchange="setDerivadoBonus('defesa', this.value)"></div>
        </div>
        <div class="derived-box">
          <div class="derived-label">ATEN√á√ÉO</div>
          <div class="derived-value" id="valAtencao">10</div>
          <div class="derived-calc"><input id="bonusAtencao" class="bonus-input" placeholder="B√¥nus" onchange="setDerivadoBonus('atencao', this.value)"></div>
        </div>
        <div class="derived-box">
          <div class="derived-label">INICIATIVA</div>
          <div class="derived-value" id="valIniciativa">+0</div>
          <div class="derived-calc"><input id="bonusIniciativa" class="bonus-input" placeholder="B√¥nus" onchange="setDerivadoBonus('iniciativa', this.value)"></div>
        </div>
        <div class="derived-box">
          <div class="derived-label">DESLOC.</div>
          <div class="derived-value" id="valDesloc">9m</div>
          <div class="derived-calc"><input id="bonusDesloc" class="bonus-input" placeholder="B√¥nus" onchange="setDerivadoBonus('deslocamento', this.value)"></div>
        </div>
      </div>
    </div>

    <div class="card skills-card">
      <div class="skills-header" style="padding-top:0;">
        <h3 style="margin-bottom:5px;">Per√≠cias</h3>
        <span id="treinoDisplay" style="font-size:0.8rem; color:#aaa; display:block;"></span>
      </div>
      <div id="skillsList"></div>
    </div>
  </div>
</div>

<button class="fab-config" onclick="abrirConfig()">‚öôÔ∏è</button>

<div id="configModal" class="modal">
  <div class="modal-content">
    <h2 style="color:var(--primary);">Configura√ß√µes</h2>
    <label>Imagem (URL)</label><input id="editImgUrl" style="margin-bottom:15px;">
    <button onclick="salvarImg()" style="background:#333; color:white; border:none; padding:5px; width:100%;">Atualizar Imagem</button>
    <br><br><button onclick="document.getElementById('configModal').style.display='none'" style="background:#333; width:100%; padding:10px; color:white; border:none; cursor:pointer;">Fechar</button>
    <button onclick="excluirPersonagem()" style="background:transparent; color:#d00000; border:none; width:100%; margin-top:15px; cursor:pointer;">Excluir Personagem</button>
  </div>
</div>

<div id="itemModal" class="modal">
  <div class="modal-content">
    <h2 id="itemModalTitle" style="color:var(--primary);">Novo Item</h2>
    <div style="display:grid; grid-template-columns: 2fr 1fr; gap:10px;">
      <div class="form-group"><label>Nome</label><input id="itNome"></div>
      <div class="form-group"><label>Tipo</label><select id="itTipo"><option value="Arma">Arma</option><option value="Uniforme">Uniforme</option><option value="Item">Item</option></select></div>
    </div>
    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
      <div class="form-group"><label>Grau</label><select id="itGrau"><option value="4">Grau 4</option><option value="3">Grau 3</option><option value="2">Grau 2</option><option value="1">Grau 1</option><option value="0">Especial</option></select></div>
      <div class="form-group"><label>Espa√ßos</label><input type="number" id="itEspacos" value="1"></div>
      <div class="form-group"><label>B√¥nus</label><input id="itBonus" placeholder="+2 CA"></div>
    </div>
    <div class="form-group"><label>Imagem (URL)</label><input id="itImg" placeholder="http://..."></div>
    <div class="form-group"><label>Descri√ß√£o Geral</label><textarea id="itDesc" style="height:60px;"></textarea></div>
    <div class="list-adder"><label>Propriedades</label><div id="propList"></div><button class="btn-add-item" onclick="addPropField()">+ Propriedade</button></div>
    <div class="list-adder"><label>Encantamentos</label><div id="encantList"></div><button class="btn-add-item" onclick="addEncantField()">+ Encantamento</button></div>
    <div style="display:flex; gap:10px; margin-top:20px;">
      <button onclick="salvarItem()" style="background:var(--primary); flex-grow:1; padding:10px; border:none; color:white; cursor:pointer;">Salvar Item</button>
      <button onclick="excluirItem()" id="btnExcluirItem" style="background:transparent; border:1px solid #d00000; color:#d00000; padding:10px; cursor:pointer; display:none;">Excluir</button>
    </div>
    <button onclick="document.getElementById('itemModal').style.display='none'" style="background:#333; width:100%; padding:10px; margin-top:5px; border:none; color:white; cursor:pointer;">Cancelar</button>
  </div>
</div>

<div id="aptidaoEditorModal" class="modal">
  <div class="modal-content">
    <h2 style="color:var(--energy);">Editor de Aptid√£o</h2>
    <div class="form-group"><label>Nome da Aptid√£o</label><input id="editAptNome"></div>
    <div class="form-group"><label>Descri√ß√£o Geral</label><textarea id="editAptDesc" style="height:80px;"></textarea></div>
    <div class="form-group"><label>N√≠vel M√°ximo (0 = Passiva)</label><input type="number" id="editAptMax" min="0" max="20" onchange="renderLevelInputs()"></div>
    <div id="editAptLevelsContainer" style="margin-top:10px; display:flex; flex-direction:column; gap:5px;"></div>
    <div style="display:flex; gap:10px; margin-top:20px;">
      <button onclick="salvarAptidaoCustom()" style="background:var(--energy); flex-grow:1; padding:10px; border:none; color:#000; cursor:pointer; font-weight:bold;">Salvar</button>
      <button onclick="excluirAptidaoCustom()" id="btnExcluirApt" style="background:transparent; border:1px solid #d00000; color:#d00000; padding:10px; cursor:pointer;">Excluir</button>
    </div>
    <button onclick="document.getElementById('aptidaoEditorModal').style.display='none'" style="background:#333; width:100%; padding:10px; margin-top:5px; border:none; color:white; cursor:pointer;">Cancelar</button>
  </div>
</div>

<script type="module">
import { db, auth, doc, updateDoc, deleteDoc, onSnapshot } from "./firebase.js";

const APTIDOES_BASE = [
  { nome: "Libera√ß√£o de Energia", descricao: "Voc√™ aprende o b√°sico do uso de Energia. Sua aura passa a se manifestar como um vapor quente saindo do seu corpo. Voc√™ pode gastar at√© seu Limite de PE por turno, que cresce conforme o n√≠vel.", maxNivel: 10, niveis: ["NV 1 - Limite de PE por turno: +1", "NV 2 - Limite de PE por turno: +1", "NV 3 - Ganha 1 Caracter√≠stica √önica de Aura", "NV 4 - Limite de PE por turno: +1", "NV 5 - Limite de PE por turno: +1", "NV 6 - Ganha 1 Caracter√≠stica √önica de Aura", "NV 7 - Limite de PE por turno: +1", "NV 8 - Limite de PE por turno: +1", "NV 9 - Ganha 1 Caracter√≠stica √önica de Aura", "NV 10 - Sua aura fica completamente estabilizada. N√£o gasta mais 1 PE por turno para manter aura ativa. Ganha 1 Caracter√≠stica √önica Especial, exclusiva do seu personagem. Limite de PE por turno: +1"] },
  { nome: "Prote√ß√£o", descricao: "Voc√™ aprende a manter a aura no seu corpo, contendo a mesma e evitando que ela saia para todos os lugares. Voc√™ passa a proteger melhor seu corpo. Com uma a√ß√£o b√¥nus voc√™ libera sua aura e ativa automaticamente sua prote√ß√£o. Voc√™ gasta 1 ponto de energia por turno com aura ativa.", maxNivel: 8, niveis: ["NV 1 - Voc√™ recebe +1 de redu√ß√£o a dano.", "NV 2 - Voc√™ recebe +1 de redu√ß√£o a dano e aumento de dano igual a 1.", "NV 3 - Voc√™ recebe +1 de redu√ß√£o a dano e aumento de dano igual a 1.", "NV 4 - Voc√™ recebe +2 de redu√ß√£o a dano e aumento de dano igual a 2. Aumenta o custo para manter a aura ativa para 2 PE por turno.", "NV 5 - Voc√™ recebe +2 de redu√ß√£o a dano e aumento de dano igual a 2.", "NV 6 - Voc√™ recebe redu√ß√£o de dano igual a 1 + X e aumento de dano igual a X. X = metade do seu Treinamento. Aumenta o custo para manter a aura ativa para 3 PE por turno.", "NV 7 - Voc√™ recebe redu√ß√£o de dano igual a Y + X e aumento de dano igual a Y + X. X = metade do seu N√≠vel e Y = Seu treinamento. Aumenta o custo para manter a aura ativa para 4 PE por turno.", "NV 8 - Voc√™ ganha resist√™ncia a danos f√≠sicos e X + Y de aumento de dano. X = metade do seu N√≠vel e Y = Seu treinamento. Aumenta o custo para manter a aura ativa para 5 PE por turno."] },
  { nome: "Proje√ß√£o", descricao: "Voc√™ aprende a projetar sua aura, imbuindo ela em pequenas coisas e podendo utilizar para ataques menores. Voc√™ gasta 1 ponto de energia e uma a√ß√£o comum para projetar sua energia. Custo de 1 PE. Seus ataques de proje√ß√£o causam um dano cr√≠tico no 20 natural.", maxNivel: 5, niveis: ["NV 1 - Voc√™ pode utilizar sua aura como um ataque amaldi√ßoado que causa 1d8 de dano.", "NV 2 - Voc√™ passa a adicionar um atributo mental a seus ataques de proje√ß√£o. Al√©m disso, pode imbuir um objeto com sua aura de proje√ß√£o, aumentando seu dano em 1d6.", "NV 3 - Voc√™ passa a adicionar seu treinamento a seus ataques de proje√ß√£o. Seu dano aumenta para 1d10 Al√©m disso, pode imbuir um objeto com sua aura de proje√ß√£o, aumentando seu dano em 1d8 + atributo mental a sua escolha. O custo aumenta para 2 PE.", "NV 4 - Seu dano base passa a ser 2d8 e seus ataques de proje√ß√£o passam a ignorar uma quantidade de RD igual a seu treinamento. Al√©m disso, pode imbuir um objeto com sua aura de proje√ß√£o, aumentando seu dano em 2d6 + atributo mental a sua escolha. O custo aumenta para 3 PE.", "NV 5 - Seu dano base passa a ser 3d10, e voc√™ passa a ignorar Treinamento + Atributo mental de RD. Al√©m disso, pode imbuir um objeto com sua aura de proje√ß√£o, aumentando seu dano em 3d8 + atributo mental √† sua escolha. O custo aumenta para 4 PE."] },
  { nome: "Cria√ß√£o", descricao: "Voc√™ entende o conceito de cria√ß√£o, aprendendo como a natureza funciona e as coisas ao seu redor podem ser utilizadas. Com uma a√ß√£o comum voc√™ √© capaz de criar coisas feitas de energia.", maxNivel: 5, niveis: ["NV 1 - Voc√™ se torna capaz de criar pequenas paredes de energia, com tamanho 1x1. A vida da sua parede de energia √© igual a metade do seu N√≠vel X Treinamento. Custo de 1 PE.", "NV 2 - Suas paredes se tornam levemente mais resistentes, voc√™ passa a adicionar o modificador de um atributo mental na vida das suas paredes.", "NV 3 - O tamanho das suas paredes e o formato delas passa a poder ser diferente. Voc√™ pode criar paredes de at√© 3x3 e elas podem ter formatos vari√°veis. Custo de 2 PE.", "NV 4 - A vida da sua parede de energia √© igual ao seu N√≠vel X Treinamento + Atributo mental. Elas passam a ser mais male√°veis, podendo ser moldadas como argila.", "NV 5 - A vida da sua parede de energia √© igual ao seu N√≠vel X Treinamento + Dobro Atributo mental. Elas passam a ser mais male√°veis, podendo ser moldadas como argila e se tornam imunes ao primeiro ataque realizado contra elas. Custo de 4 PE."] },
  { nome: "Concentra√ß√£o", descricao: "Gastando uma a√ß√£o b√¥nus, voc√™ concentra sua aura em pontos espec√≠ficos, focando causar um dano ou uma explos√£o maior de energia.", maxNivel: 5, niveis: ["NV 1 - Voc√™ aumenta seu dado de dano em 1 n√≠vel. Custo 2 PE.", "NV 2 - Voc√™ passa a adicionar seu modificador do maior atributo no seu dano.", "NV 3 - Voc√™ recebe 1 dado adicional no dano final. Custo 3 PE.", "NV 4 - Voc√™ passa a aumentar seu dado de dano em 2 n√≠veis ao inv√©s de 1. Custo 4 PE.", "NV 5 - Voc√™ passa a poder maximizar o dano de uma quantidade de dados igual a seu treinamento. Custo 5 PE."] },
  { nome: "Transforma√ß√£o", descricao: "Voc√™ aprende a ressignificar a sua aura e a energia ao seu redor, transformando seu efeito. √ötil para trocar tipo de dano, alterar forma de constru√ß√µes energ√©ticas ou transmutar temporariamente caracter√≠sticas f√≠sicas. Voc√™ pode transformar o formato de aura para situa√ß√µes formas espec√≠ficas. Voc√™ ativa os estados da transforma√ß√£o com uma a√ß√£o b√¥nus e paga 1 PE por turno para manter eles ativos.", maxNivel: 5, niveis: ["NV 1 ‚Äì Voc√™ pode aumentar as capacidades da sua aura:<br>- Aura L√≠quida: Voc√™ faz com que seja mais dif√≠cil encostar em voc√™. Aumenta sua CA em 1 ponto e ganha +1 em reflexos.<br>- Aura S√≥lida: Voc√™ resiste melhor a ataques realizados contra voc√™. Aumenta sua RD em 1 ponto e ganha +1 de fortitude.<br>- Aura Gasosa:Sua aura muda, ficando mais inst√°vel e explosiva.  Aumenta seu dano em +1 e ganha +1 em integridade.", "NV 2 ‚Äì Aumenta o b√¥nus da sua aura em +1.", "NV 3 ‚Äì Aumenta o b√¥nus da sua aura em +2. O custo para se manter ativo aumenta para 3 PE por turno.", "NV 4 ‚Äì Aumenta o b√¥nus da sua aura em +2.", "NV 5 ‚Äì Voc√™ atinge o estado m√°ximo de cada aura. O custo para se manter ativo aumenta para 4 PE por turno.<br>- Aura L√≠quida: Voc√™ recebe vantagem em testes de reflexos e recebe uma esquiva especial garantida na cena que a aura estiver ativa.<br>- Aura S√≥lida: Voc√™ recebe vantagem em testes de fortitude e aumenta recebe seu modificador mais alto em RD.<br>- Aura Gasosa: Voc√™ recebe vantagem em testes de integridade e aumenta seu dado de ataque em 1 dado adicional."] },
  { nome: "Aura Elemental", descricao: "Voc√™ imbui sua aura com propriedades da natureza (Fogo, Gelo, Raio, etc).", maxNivel: 5, niveis: ["NV 1 ‚Äì Voc√™ pode mudar o tipo de dano da sua proje√ß√£o/ataque para outro tipo (ex.: cortante ‚Üí queimante) por um n√∫mero de turnos igual ao seu Treinamento.", "NV 2 ‚Äì Al√©m do acima, voc√™ pode transformar um objeto em um foco elemental de energia por turnos iguais ao Treinamento; transforma tamb√©m um efeito elemental (por exemplo: calor ‚Üí frio). Al√©m disso, ao utilizar o elemento da sua aura, voc√™ pode adicionar 1d6 de dano adicional. A dura√ß√£o de sua aura passa a ser Cena.", "NV 3 ‚Äì Voc√™ passa a poder transformar a aura de um alvo atingido: Voc√™ pode alterar a propriedade elemental do mesmo para sua aura elemental atrav√©s de um teste de resist√™ncia. Voc√™ passa a adicionar seu atributo mental em rolagens de dano da aura.", "NV 4 ‚Äì Voc√™ passa a passivamente possuir um elemento na sua aura. Pode escolher um segundo elemento para transformar sua aura e utilizar os efeitos de transforma√ß√£o.", "NV 5 ‚Äì Voc√™ passa a causar 2d10+Atributo mental de dano de aura elemental."] },
  { nome: "Molde", descricao: "Voc√™ aprende a esculpir a energia com precis√£o, tornando cria√ß√µes e solidifica√ß√µes male√°veis e funcionais essenciais para criar formas complexas e ferramentas de energia. Para realizar a cria√ß√£o √© necess√°rio uma a√ß√£o comum.", maxNivel: 5, niveis: ["NV 1 ‚Äì Pode moldar cria√ß√µes simples de energia (1x1) em formas definidas (por ex.: pilar, l√¢mina, escudo). Dura√ß√£o: Treinamento turnos. Vida/HP da pe√ßa = metade do seu N√≠vel √ó Treinamento. Tem o custo de 2 PE para se erguerem.", "NV 2 ‚Äì As cria√ß√µes ganham +1 na vida e podem ser levemente mais complexas.", "NV 3 ‚Äì Pode criar formas at√© 3x3 com complexidade (partes m√≥veis b√°sicas). Vida das pe√ßas = metade do seu N√≠vel √ó Treinamento + Atrib uto Mental.", "NV 4 ‚Äì Permite criar ferramentas ou mecanismos (alavancas, portas energ√©ticas) que executam uma a√ß√£o simples por turno (ex.: emitir pulso, abrir/fechar). Dura√ß√£o aumentada em Treinamento.", "NV 5 ‚Äì Cria√ß√µes moldadas ganham uma caracter√≠stica extra (ex.: afiada, condutora, amortecedora) por escolha do usu√°rio; recebem imunidade ao primeiro ataque e t√™m sua vida = N√≠vel √ó Treinamento + Atributo Mental."] },
  { nome: "Intensifica√ß√£o", descricao: "Como uma rea√ß√£o, voc√™ aprende a comprimir e sobrecarregar a energia para torn√°-la mais potente: mais dano, mais defesa, efeitos mais longos ou maior alcance. Ao conjurar, atacar ou defender como gatilho, voc√™ pode intensificar.", maxNivel: 5, niveis: ["NV 1 ‚Äì Aumenta o dano ou defesa de uma habilidade de energia em +1 por ativa√ß√£o. Custo de 1 PE.", "NV 2 ‚Äì Aumenta o dano ou defesa em +2 e adiciona +1 de alcance/raio. Custo de 1 PE.", "NV 3 ‚Äì Aumenta dano ou defesa em 1 + metade do seu Treinamento e aplica um b√¥nus de ignorar RD igual a metade do seu Treinamento. Aumenta o custo para 2 PE.", "NV 4 ‚Äì Aumenta dano em 1 n√≠vel ou ganha seu modificador mais alto na defesa e a dura√ß√£o igual ao Treinamento. Aumenta o custo para 3 PE.", "NV 5 ‚Äì Voc√™ agrega X + Y de dano b√¥nus (X = metade do N√≠vel, Y = seu Treinamento) e pode sacrificar uma reserva de energia para aumentar o n√≠vel de dano em 2 n√≠veis ou se tornar resistente a um dano. Custo 5 PE."] },
  { nome: "Solidifica√ß√£o", descricao: "Utilizando uma a√ß√£o b√¥nus, voc√™ compacta e endurece sua aura em torno do corpo, transformando-a numa armadura energ√©tica. Enquanto a Solidifica√ß√£o est√° ativa ela modifica e melhora os efeitos da sua Prote√ß√£o, dando redu√ß√£o de dano, pontos de vida tempor√°rios e resist√™ncias graduais. Custo de 1 PE por turno.", maxNivel: 5, niveis: ["NV 1 ‚Äì Ao ativar Solidifica√ß√£o, sua Prote√ß√£o recebe +1 de redu√ß√£o de dano adicional. Voc√™ tamb√©m ganha PVs tempor√°rios = Treinamento enquanto durar a Solidifica√ß√£o.", "NV 2 ‚Äì Aumento de redu√ß√£o passa a ser +2. Enquanto a Solidifica√ß√£o estiver ativa voc√™ recebe +1 de aumento de dano nas suas proje√ß√µes/ataques energ√©ticos.", "NV 3 ‚Äì Aumento de redu√ß√£o = 1 + X, onde X = metade do seu Treinamento (arredondar para baixo). Voc√™ ganha Resist√™ncia a dano f√≠sico = X (reduz dano f√≠sico recebido em X) e PVs tempor√°rios = Treinamento + Modificador de Atributo Mental. Aumenta o custo para 2 PE por turno.", "NV 4 ‚Äì Aumento de redu√ß√£o = Y + X, onde Y = seu Treinamento e X = metade do seu N√≠vel. Enquanto ativa, a Solidifica√ß√£o concede redu√ß√£o extra contra ataques cr√≠ticos (o primeiro ataque que exceder sua redu√ß√£o tem seu dano reduzido em 50%) e prolonga a dura√ß√£o da Prote√ß√£o em + metade do seu N√≠vel (em turnos). Aumenta o custo para 3 PE por turno.", "NV 5 ‚Äì Voc√™ ganha resist√™ncia a danos f√≠sicos e + (X + Y) de aumento de dano em suas habilidades energ√©ticas quando a Solidifica√ß√£o est√° ativa. X = metade do seu N√≠vel; Y = seu Treinamento. Al√©m disso, a armadura energ√©tica concede imunidade ao primeiro efeito negativo que tentarem aplicar ao seu corpo enquanto a Solidifica√ß√£o durar (consome-se para negar o efeito). Aumenta o custo para 4 PE por turno."] },
  { nome: "Encasular", descricao: "Com uma a√ß√£o comum, voc√™ cria inv√≥lucros/bolhas de energia que prendem, isolam ou protegem, usado tanto defensivamente quanto para prender alvos. Alvos devem falhar em um teste de reflexos para serem presos. Custo de 1 PE por turno ativo.", maxNivel: 5, niveis: ["NV 1 ‚Äì Cria uma pequena bolha (1 alvo pequeno ou 1 espa√ßo 1x1) que reduz a mobilidade do interior e concede redu√ß√£o de dano aos que est√£o dentro igual a seu treinamento. Dura√ß√£o = Treinamento turnos.", "NV 2 ‚Äì Bolha ganha HP igual a N√≠vel √ó Treinamento + Atributo Mental, inimigos dentro tem desvantagem em testes f√≠sicos. Aumenta o custo para 2 PE por turno.", "NV 3 ‚Äì Pode infligir dano peri√≥dico (1 por turno + metade do seu Treinamento) a alvos presos, pode impedir comunica√ß√£o fazendo o casulo ser a prova de som.", "NV 4 ‚Äì Pode encasular m√∫ltiplos alvos (at√© X alvos, X = metade do seu Treinamento) ou aumentar o tamanho do inv√≥lucro (at√© 3x3). Encasulamento pode absorver um ataque dirigido ao interior (consome a bolha se quebrada). Aumenta o custo para 3 PE por turno.", "NV 5 ‚Äì Bolhas tornam-se quase impenetr√°veis por uma quantidade de turnos igual a metade do Treinamento. Feiti√ßos n√£o podem ser utilizados dentro da bolha. Aumenta o custo para 4 PE por turno."] },
  { nome: "Redirecionar", descricao: "Com uma rea√ß√£o, voc√™ manipula a dire√ß√£o dos fluxos de energia: pode curvar ataques, reencaminhar proje√ß√µes ou alterar trajet√≥rias. Sempre realizando um teste de feiti√ßaria contra o atacante, recebendo metade do dano em um sucesso e ignorando o dano em um sucesso cr√≠tico.", maxNivel: 5, niveis: ["NV 1 ‚Äì pode curvar um ataque de proje√ß√£o dirigido contra voc√™, mudando seu alvo para outro ponto adjacente. Tem o custo de 1 PE.", "NV 2 ‚Äì pode redirecionar proj√©teis/rajadas at√© alcance curto, inimigos que vieram de longa dist√¢ncia recebem desvantagem no pr√≥ximo ataque ap√≥s redirecionamento. Tem o custo de 1 PE.", "NV 3 ‚Äì pode redirecionar efeitos com origem n√£o-pessoal (explos√µes, piches de energia) para uma √°rea alternativa em at√© 3 metros. Tem o custo de 2 PE.", "NV 4 ‚Äì consegue criar n√≥s de redirecionamento iguais a X no campo que mudam trajet√≥rias automaticamente por X turnos. X = Metade do treinamento.", "NV 5 ‚Äì voc√™ pode refletir de volta uma habilidade de energia para o remetente, devolvendo metade do dano ou convertendo o ataque em forma diferente (alterando para o tipo de dano da sua aura). O valor do redirecionamento √© igual a metade do custo da habilidade utilizada pelo atacante. Tem o custo de 5 PE."] },
  { nome: "Esconder", descricao: "Voc√™ aprende a ocultar a sua aura e a energia de detec√ß√£o alheia, criando camadas de camuflagem e dissimula√ß√£o. 1 ponto de energia para ativar. Cada n√≠vel aumenta o custo em 1 ponto de energia.", maxNivel: 5, niveis: ["NV 1 ‚Äì Sua aura deixa de ser detect√°vel por m√©todos simples (detec√ß√µes b√°sicas, sensores de energia de baixa qualidade) por Treinamento turnos.", "NV 2 ‚Äì Pode projetar uma falsa assinatura de aura (pequena isca) que confunde detectores. Ganha seu treinamento nos testes de furtividade.", "NV 3 ‚Äì Cria oculta√ß√£o completa, voc√™ pode permanecer invis√≠vel a sensores energ√©ticos por turnos adicionais iguais √† metade do seu Treinamento, gastando 2 pontos de energia adicionais, pode duplicar sua assinatura para criar um ‚Äúeco‚Äù enganoso.", "NV 4 ‚Äì Pode emba√ßar a aura de aliados pr√≥ximos (raio = metade do seu N√≠vel) e mascarar presen√ßa de grupo.", "NV 5 ‚Äì Oculta√ß√£o avan√ßada torna-se indetect√°vel a todos os rastreios comuns por X turnos (X = metade do seu treinamento), pode assumir temporariamente a assinatura de outra fonte de energia conhecida."] },
  { nome: "Perturba√ß√£o", descricao: "Com uma a√ß√£o comum ou rea√ß√£o, voc√™ aprende a interferir no fluxo de energia dos outros: quebrar conjura√ß√µes, causar dispers√£o de efeitos e desestabilizar ataques.", maxNivel: 5, niveis: ["NV 1 ‚Äì alvo sofre -1 em testes de ativa√ß√£o de habilidades de energia por 1 turno. Custo 1 PE para a√ß√£o comum e 1 PE para rea√ß√£o.", "NV 2 ‚Äì alvo deve passar em um teste de vontade para completar conjura√ß√µes, falha = conjura√ß√£o interrompida. Custo 1 PE para a√ß√£o comum e 2 PE para rea√ß√£o.", "NV 3 ‚Äì Pode criar uma zona de perturba√ß√£o (at√© 3x3) que reduz a efic√°cia de habilidades energ√©ticas em X e causa dano menor peri√≥dico (1 por turno). Dura√ß√£o igual a X. X = metade do seu Treinamento. Custo 2 PE para a√ß√£o comum e 4 PE para rea√ß√£o.", "NV 4 ‚Äì Capaz de interromper temporariamente recarga/recupera√ß√£o de poderes em alvos atingidos por Y turnos (Y = metade do seu N√≠vel) se falharem em teste. Custo 3 PE para a√ß√£o comum e 6 PE para rea√ß√£o.", "NV 5 ‚Äì Por uma ativa√ß√£o poderosa voc√™ pode anular uma habilidade de um inimigo (cooldown for√ßado) ou inverter o efeito de uma habilidade de energia (transformar buff em debuff) por 1 turno + Treinamento se o alvo falhar em um teste dif√≠cil. Custo 4 PE para a√ß√£o comum e 8 PE para rea√ß√£o."] },
  { nome: "√Åpice Humano", descricao: "Seu corpo atinge o pico absoluto do desenvolvimento humano. Sua energia se estabiliza, seus m√∫sculos e reflexos chegam ao limite natural e sua mente se torna perfeitamente focada.\nEfeitos:\nSeu corpo passa a ser tratado como se estivesse sempre no m√°ximo humano poss√≠vel, voc√™ n√£o fica mais doente ou sente efeitos comuns humanos.\n\nVoc√™ recebe +Treinamento em redu√ß√£o de dano permanente.\n\nSeus testes f√≠sicos (Atletismo, Resist√™ncia, Reflexos) recebem Treinamento como b√¥nus.\n\n1 vez por descanso longo, voc√™ pode ativar o estado Corpo no Limite por Treinamento turnos, ganhando:\n\n+1 A√ß√£o extra por turno.\nResist√™ncia a todo dano f√≠sico.\nAo final, sofre Exaust√£o (perde ‚àí2 em todos os testes f√≠sicos por 1 hora)", maxNivel: 1, niveis: ["Desbloqueado"] },
  { nome: "Corpo Amaldi√ßoado", descricao: "Voc√™ transforma o corpo em uma extens√£o viva da sua energia, deixando de se limitar pelas amarras do ser humano comum. Sua forma f√≠sica √© male√°vel, inst√°vel e monstruosa, mas capaz de liberar o m√°ximo potencial da maldi√ß√£o.\nEfeitos:\nSeu corpo passa a contar como Energia Solidificada: qualquer teste ou efeito que afete mat√©ria ou energia pode afetar voc√™. Voc√™ passa a poder dar ataques f√≠sicos como ataque amaldi√ßoado.\nVoc√™ recebe +Treinamento em aumento de dano permanente.\nSeus testes de manipula√ß√£o de energia (Proje√ß√£o, Cria√ß√£o, Transforma√ß√£o) recebem +Treinamento em b√¥nus de rolagem.\n1 vez por descanso longo, voc√™ pode ativar o estado Forma Amaldi√ßoada por Treinamento turnos, ganhando:\n\nSeus ataques causam +N√≠vel d12 de dano de energia.\nVoc√™ pode moldar seu corpo livremente (aumentar alcance, gerar armas naturais, planar e etc.).\nImunidade a condi√ß√µes f√≠sicas (atordoamento, agarrado, paralisia) enquanto durar.\nAo final, voc√™ sofre 1 Marca de Corrup√ß√£o autom√°tica e perde N√≠vel √ó 2 PV que n√£o podem ser curados at√© um descanso longo. Limite te deixa com 1 PV.", maxNivel: 1, niveis: ["Desbloqueado"] }
];

const params = new URLSearchParams(location.search);
const id = params.get("id");
window.id = id;
let ficha = {}; 
let editandoId = null;
let editingItemIndex = -1;
let editingAptIndex = -1;
const MESTRE_EMAIL = "grisskos@fake.com";
let isMestre = false;

const PERICIAS_DEF = [
  { n: "Atletismo", a: "forca" }, { n: "Acrobacia", a: "destreza" }, { n: "Furtividade", a: "destreza" },
  { n: "Prestidigita√ß√£o", a: "destreza" }, { n: "Feiti√ßaria", a: "inteligencia" }, { n: "Hist√≥ria", a: "inteligencia" },
  { n: "Investiga√ß√£o", a: "inteligencia" }, { n: "Of√≠cio 1", a: "inteligencia" }, { n: "Tecnologia", a: "inteligencia" },
  { n: "Teologia", a: "inteligencia" }, { n: "Dire√ß√£o", a: "sabedoria" }, { n: "Intui√ß√£o", a: "sabedoria" },
  { n: "Medicina", a: "sabedoria" }, { n: "Ocultismo", a: "sabedoria" }, { n: "Percep√ß√£o", a: "sabedoria" },
  { n: "Sobreviv√™ncia", a: "sabedoria" }, { n: "Engana√ß√£o", a: "presenca" }, { n: "Intimida√ß√£o", a: "presenca" },
  { n: "Performance", a: "presenca" }, { n: "Persuas√£o", a: "presenca" }
];
const ATR_SHORT = { forca:"FOR", destreza:"DES", constituicao:"CON", inteligencia:"INT", sabedoria:"SAB", presenca:"PRE" };

auth.onAuthStateChanged(user => {
  if(user && user.email === MESTRE_EMAIL) {
    isMestre = true;
    document.getElementById('gmControlsMain').style.display = 'flex';
  }
});

onSnapshot(doc(db, "fichas", id), (docSnap) => {
  if (docSnap.exists()) { 
    ficha = docSnap.data();
    if (!ficha.atributos) ficha.atributos = { forca:10, destreza:10, constituicao:10, inteligencia:10, sabedoria:10, presenca:10 };
    if (!ficha.pericias) ficha.pericias = {};
    if (!ficha.shikigamis) ficha.shikigamis = [];
    if (!ficha.vida) ficha.vida = { atual: 10, max: 10 };
    if (!ficha.energia) ficha.energia = { atual: 10, max: 10 };
    if (!ficha.vigor) ficha.vigor = { atual: 5, max: 5 };
    if (!ficha.integridade) ficha.integridade = { atual: 100, max: 100 };
    if (!ficha.combate) ficha.combate = {}; 
    if (!ficha.inventario) ficha.inventario = []; 
    if (!ficha.progressoAptidoes) ficha.progressoAptidoes = {};
    if (!ficha.transfUnlocked) ficha.transfUnlocked = { apice: false, corpo: false };
    if (!ficha.transfActive) ficha.transfActive = null; 
    if (!ficha.sequelas) ficha.sequelas = { exaustao: false, corrupcao: false };
    if (!ficha.aptidoesCustom) ficha.aptidoesCustom = [];
    if (!ficha.derivados) ficha.derivados = { defesa:0, atencao:0, iniciativa:0, deslocamento:0 };
    
    if(!editandoId) renderFicha(); 
  }
});

function renderFicha() {
  const f = ficha;
  
  const nomeEl = document.getElementById('nomeDisplay');
  if(nomeEl && !nomeEl.querySelector('input')) nomeEl.innerText = f.nome || "Sem Nome";
  document.getElementById('charImg').src = f.imagem || "";

  document.getElementById('badges').innerHTML = `
    <span class="badge b-lvl">NVL <span class="editable" onclick="editarCampo(this, 'nivel', 'number')">${f.nivel||1}</span></span>
    <span class="badge b-cls">${f.classe || 'Aventureiro'}</span>
  `;

  const btnApice = document.getElementById('btnApice');
  const btnCorpo = document.getElementById('btnCorpo');
  const divSequela = document.getElementById('statusSequela');
  
  btnApice.className = "transf-btn apice locked"; btnCorpo.className = "transf-btn corpo locked"; divSequela.innerHTML = "";
  if(f.transfUnlocked.apice) { btnApice.classList.remove('locked'); btnApice.classList.add('unlocked'); if(f.transfActive === 'apice') btnApice.classList.add('active'); }
  if(f.transfUnlocked.corpo) { btnCorpo.classList.remove('locked'); btnCorpo.classList.add('unlocked'); if(f.transfActive === 'corpo') btnCorpo.classList.add('active'); }
  if(f.sequelas.exaustao) divSequela.innerHTML += `<span class="sequela-tag">‚ö† EXAUST√ÉO (-2 F√≠sico)</span>`;
  if(f.sequelas.corrupcao) divSequela.innerHTML += `<span class="sequela-tag">‚ò† CORRUP√á√ÉO (HP Max Reduzido)</span>`;

  const shikiArea = document.getElementById('shikiTokens');
  shikiArea.innerHTML = "";
  if(f.shikigamis.length > 0) {
    f.shikigamis.forEach(s => shikiArea.innerHTML += `<img src="${s.imagem||''}" class="shiki-token" onclick="irParaShikigamis()">`);
    if(f.shikigamis.length < 20) shikiArea.innerHTML += `<div class="shiki-add" onclick="irParaShikigamis()">+</div>`;
  } else { shikiArea.innerHTML += `<div class="shiki-add" onclick="irParaShikigamis()">+</div>`; }

  const areaAttr = document.getElementById('atributosArea');
  areaAttr.innerHTML = "";
  Object.keys(ATR_SHORT).forEach(key => {
    const val = f.atributos[key] || 10;
    const mod = Math.floor((val - 10) / 2);
    areaAttr.innerHTML += `<div class="attr-box"><span class="attr-lbl">${ATR_SHORT[key]}</span><span class="attr-val">${mod>=0?'+':''}${mod}</span><span class="attr-raw editable" onclick="editarCampo(this, 'atributos.${key}', 'number')">${val}</span></div>`;
  });

  const areaStats = document.getElementById('statsArea');
  areaStats.innerHTML = "";
  const statsMap = [{k:'vida', l:'Vida', color:'var(--primary)'}, {k:'energia', l:'Energia', color:'var(--energy)'}, {k:'vigor', l:'Vigor', color:'var(--vigor)'}, {k:'integridade', l:'Integ.', color:'var(--integridade)'}];
  statsMap.forEach(s => {
    const st = f[s.k] || {atual:0, max:0};
    const pct = st.max > 0 ? Math.min(100, (st.atual/st.max)*100) : 0;
    areaStats.innerHTML += `<div class="stat-row"><div class="stat-head"><span>${s.l}</span><div><span class="editable" onclick="editarCampo(this, '${s.k}.atual', 'number')">${st.atual}</span> / <span class="editable" onclick="editarCampo(this, '${s.k}.max', 'number')">${st.max}</span></div></div><div class="bar-bg"><div class="bar-fill" style="width:${pct}%; background:${s.color}; box-shadow: 0 0 8px ${s.color};"></div></div><div class="stat-ctrl"><div class="btn-calc" onclick="mathStat(this, '${s.k}')">üî¢</div><div class="btn-mini" onclick="upStat('${s.k}', -1)">-</div><div class="btn-mini" onclick="upStat('${s.k}', 1)">+</div></div></div>`;
  });

  const nivel = f.nivel || 1;
  const metadeNivel = Math.floor(nivel / 2);
  const bonusTreino = 2 + Math.floor((nivel - 1) / 4);
  const modFor = Math.floor((f.atributos.forca - 10) / 2);
  const modDes = Math.floor((f.atributos.destreza - 10) / 2);
  const cData = f.combate;

  let bonusPhysSkill_Apice = f.transfUnlocked.apice ? bonusTreino : 0;
  let bonusMagicSkill_Corpo = f.transfUnlocked.corpo ? bonusTreino : 0;
  if (f.sequelas.exaustao) bonusPhysSkill_Apice -= 2;

  renderDerivados();

  const attacksArea = document.getElementById('combatAttacksArea');
  attacksArea.innerHTML = "";
  
  const cCorpo = cData.corpo || {};
  const attrCorpo = cCorpo.usaDes ? modDes : modFor;
  let totCorpo = attrCorpo + metadeNivel + (cCorpo.treino ? bonusTreino : 0) + (cCorpo.outros || 0);
  attacksArea.innerHTML += `<div class="combat-card"><div class="cc-header">Corpo a Corpo <div class="btn-toggle-attr" onclick="toggleMeleeAttr()">${cCorpo.usaDes?'DES':'FOR'}</div></div><div class="cc-body">${totCorpo>=0?'+':''}${totCorpo}</div><div class="cc-footer"><div class="btn-train ${cCorpo.treino?'active':''}" onclick="toggleCombatTrain('corpo')">T</div><input class="bonus-input" placeholder="+" value="${cCorpo.outros||''}" onchange="setCombatOther('corpo', this.value)"></div></div>`;

  const cDist = cData.distancia || {};
  let totDist = modDes + metadeNivel + (cDist.treino ? bonusTreino : 0) + (cDist.outros || 0);
  attacksArea.innerHTML += `<div class="combat-card"><div class="cc-header">Dist√¢ncia</div><div class="cc-body">${totDist>=0?'+':''}${totDist}</div><div class="cc-footer"><div class="btn-train ${cDist.treino?'active':''}" onclick="toggleCombatTrain('distancia')">T</div><input class="bonus-input" placeholder="+" value="${cDist.outros||''}" onchange="setCombatOther('distancia', this.value)"></div></div>`;

  const cMagic = cData.magico || {};
  const valMagic = f.atributos[cMagic.atributo || 'inteligencia'];
  const modMagic = Math.floor((valMagic - 10) / 2);
  let totMagic = modMagic + metadeNivel + bonusTreino + (cMagic.outros || 0);
  if (f.transfActive === 'corpo' || f.transfUnlocked.corpo) totMagic += bonusMagicSkill_Corpo;
  attacksArea.innerHTML += `<div class="combat-card"><div class="cc-header">Amaldi√ßoado <select class="mini-select" onchange="setMagicAttr(this.value)">${Object.keys(ATR_SHORT).map(k => `<option value="${k}" ${k===(cMagic.atributo||'inteligencia')?'selected':''}>${ATR_SHORT[k]}</option>`).join('')}</select></div><div class="cc-body">${totMagic>=0?'+':''}${totMagic}</div><div class="cc-footer"><span style="font-size:0.7rem; color:var(--energy);">[T]</span><input class="bonus-input" placeholder="+" value="${cMagic.outros||''}" onchange="setCombatOther('magico', this.value)"></div></div>`;

  const resistArea = document.getElementById('combatResistArea');
  resistArea.innerHTML = "";
  const resistencias = [{ k: 'astucia', l: 'Ast√∫cia', a: 'inteligencia' }, { k: 'fortitude', l: 'Fortitude', a: 'constituicao' }, { k: 'integridade', l: 'Integ.', a: 'constituicao' }, { k: 'reflexos', l: 'Reflexos', a: 'destreza' }, { k: 'vontade', l: 'Vontade', a: 'sabedoria' }];
  resistencias.forEach(res => {
    const rData = cData[res.k] || {};
    const rMod = Math.floor((f.atributos[res.a] - 10) / 2);
    let rTotal = rMod + metadeNivel + (rData.treino ? bonusTreino : 0) + (rData.outros || 0);
    if (['fortitude','reflexos','integridade'].includes(res.k)) rTotal += bonusPhysSkill_Apice;
    resistArea.innerHTML += `<div class="combat-card"><div class="cc-header">${res.l}</div><div class="cc-body" style="font-size:1.5rem;">${rTotal>=0?'+':''}${rTotal}</div><div class="cc-footer"><div class="btn-train ${rData.treino?'active':''}" onclick="toggleCombatTrain('${res.k}')">T</div><input class="bonus-input" placeholder="+" value="${rData.outros||''}" onchange="setCombatOther('${res.k}', this.value)"></div></div>`;
  });

  const strMod = Math.floor((f.atributos.forca - 10) / 2);
  const limit = 8 + (strMod * 2); 
  const hardLimit = limit * 2;
  const currentLoad = (f.inventario || []).reduce((acc, item) => acc + (Number(item.espacos)||0), 0);
  document.getElementById('loadFill').style.width = Math.min(100, (currentLoad / hardLimit) * 100) + '%';
  document.getElementById('loadText').innerText = `${currentLoad} / ${limit} Espa√ßos`;
  document.getElementById('overburdenMsg').style.display = currentLoad > limit ? 'block' : 'none';
  
  const invGrid = document.getElementById('inventoryGrid');
  invGrid.innerHTML = "";
  (f.inventario || []).forEach((item, idx) => {
    const gradeClass = `grade-${item.grau || 4}`;
    const imgUrl = item.imagem || 'https://via.placeholder.com/150?text=Item';
    invGrid.innerHTML += `<div class="inv-card ${gradeClass}" onclick="abrirItemModal(${idx})"><img src="${imgUrl}" class="inv-img"><div class="inv-body"><div class="inv-title">${item.nome}</div><div class="inv-type">${item.tipo} ‚Ä¢ Grau ${['Esp','1','2','3','4'][item.grau]}</div><div class="inv-stats">${item.bonus || ''}</div><div class="inv-slots">${item.espacos} üì¶</div></div></div>`;
  });

  const containerApt = document.getElementById('listaAptidoes');
  containerApt.innerHTML = "";
  const todasAptidoes = [...APTIDOES_BASE, ...(ficha.aptidoesCustom || [])];

  todasAptidoes.forEach((apt, index) => {
    let nivelAtual = (ficha.progressoAptidoes || {})[apt.nome] || 0;
    if (apt.nome === "√Åpice Humano" && f.transfUnlocked.apice) nivelAtual = 1;
    if (apt.nome === "Corpo Amaldi√ßoado" && f.transfUnlocked.corpo) nivelAtual = 1;

    let isOpenClass = ''; 
    
    if (!isMestre && nivelAtual === 0) return;

    let niveisHtml = "";
    if(apt.niveis) {
      apt.niveis.forEach((desc, idx) => {
        const lvl = idx + 1;
        const isUnlocked = lvl <= nivelAtual;
        if (!isMestre && !isUnlocked) return;
        const controls = isMestre ? `<div class="gm-controls"><div class="btn-gm" onclick="setAptidao('${apt.nome}', ${lvl})">üîì</div><div class="btn-gm" style="border-color:#d00000;color:#d00000;" onclick="setAptidao('${apt.nome}', ${lvl-1})">üîí</div></div>` : "";
        niveisHtml += `<div class="nivel-row ${isUnlocked ? 'unlocked' : ''}"><div class="nivel-check"></div><div style="flex-grow:1;">${desc}</div>${controls}</div>`;
      });
    }

    let editBtn = "";
    if (isMestre && index >= APTIDOES_BASE.length) {
      const realIndex = index - APTIDOES_BASE.length;
      editBtn = `<button class="btn-edit-apt" onclick="abrirEditorAptidao(${realIndex})">‚úé</button>`;
    }

    containerApt.innerHTML += `<div class="aptidao-box"><div class="aptidao-header" onclick="this.nextElementSibling.classList.toggle('open')"><span>${apt.nome} <span style="font-size:0.8rem;color:#666;">(${nivelAtual}/${apt.maxNivel})</span>${editBtn}</span><span>‚ñº</span></div><div class="aptidao-body ${isOpenClass}"><div class="aptidao-desc">${apt.descricao || 'Sem descri√ß√£o.'}</div>${niveisHtml}</div></div>`;
  });

  const listaSkills = document.getElementById('skillsList');
  listaSkills.innerHTML = "";
  const PHYS_ATTRS = ['forca', 'destreza', 'constituicao'];
  PERICIAS_DEF.forEach(p => {
    const attrVal = f.atributos[p.a] || 10;
    const modAttr = Math.floor((attrVal - 10) / 2);
    const saved = (f.pericias||{})[p.n] || { t: false, m: false, bonus: 0 };
    let total = modAttr + metadeNivel;
    if (saved.t) total += bonusTreino;
    if (saved.m) total += 1;
    total += Number(saved.bonus || 0);
    if (f.transfUnlocked.apice && PHYS_ATTRS.includes(p.a)) total += bonusPhysSkill_Apice;

    listaSkills.innerHTML += `<div class="skill-row"><span class="sk-name">${p.n}</span><span class="sk-attr">${ATR_SHORT[p.a]}</span><span class="sk-total">${total>=0?'+':''}${total}</span><div class="sk-btn-group"><input class="bonus-input" placeholder="0" value="${saved.bonus || ''}" onchange="setSkillBonus('${p.n}', this.value)"><div class="sk-btn ${saved.t ? 'active-t' : ''}" onclick="togglePericia('${p.n}', 't')">T</div><div class="sk-btn ${saved.m ? 'active-m' : ''}" onclick="togglePericia('${p.n}', 'm')">M</div></div></div>`;
  });
}

function renderDerivados() {
  const desMod = Math.floor((ficha.atributos.destreza - 10) / 2);
  const sabMod = Math.floor((ficha.atributos.sabedoria - 10) / 2);
  const metadeNivel = Math.floor((ficha.nivel || 1) / 2);
  const bonusTreino = 2 + Math.floor(((ficha.nivel||1)-1)/4);
  
  const defBonus = Number(ficha.derivados.defesa || 0);
  const defesa = 10 + desMod + metadeNivel + defBonus;
  document.getElementById('valDefesa').innerText = defesa;
  document.getElementById('bonusDef').value = ficha.derivados.defesa || "";

  // Corre√ß√£o Aten√ß√£o: 10 + Percep√ß√£o Total (com b√¥nus de pericia e treino) + B√¥nus Extra
  const pSaved = (ficha.pericias && ficha.pericias["Percep√ß√£o"]) || {t:false, m:false, bonus:0};
  let percMod = sabMod + metadeNivel + Number(pSaved.bonus || 0);
  if(pSaved.t) percMod += bonusTreino;
  if(pSaved.m) percMod += 1;
  // Se estiver sob √Åpice Humano (SAB n√£o √© f√≠sico, mas vale checar se quiser bonus global. Por regra s√≥ fisico)
  
  const atencaoBonus = Number(ficha.derivados.atencao || 0);
  const atencao = 10 + percMod + atencaoBonus;
  document.getElementById('valAtencao').innerText = atencao;
  document.getElementById('bonusAtencao').value = ficha.derivados.atencao || "";

  const iniBonus = Number(ficha.derivados.iniciativa || 0);
  const iniciativa = desMod + iniBonus;
  document.getElementById('valIniciativa').innerText = (iniciativa>=0?'+':'') + iniciativa;
  document.getElementById('bonusIniciativa').value = ficha.derivados.iniciativa || "";

  const desBonus = Number(ficha.derivados.deslocamento || 0);
  const desloc = 9 + desBonus;
  document.getElementById('valDesloc').innerText = desloc + "m";
  document.getElementById('bonusDesloc').value = ficha.derivados.deslocamento || "";
}

window.setDerivadoBonus = async (key, val) => {
  const derivados = ficha.derivados || {};
  derivados[key] = Number(val);
  await updateDoc(doc(db, "fichas", id), { derivados: derivados });
};

window.toggleTransformacao = async (tipo) => { if (!ficha.transfUnlocked[tipo]) return; let novoEstado = null; if (ficha.transfActive === tipo) { novoEstado = null; if (tipo === 'apice') await aplicarSequela('exaustao'); if (tipo === 'corpo') await aplicarSequela('corrupcao'); } else { novoEstado = tipo; } await updateDoc(doc(db, "fichas", id), { transfActive: novoEstado }); };
async function aplicarSequela(tipo) { const seq = ficha.sequelas || {}; seq[tipo] = true; if (tipo === 'corrupcao') { const dano = (ficha.nivel || 1) * 2; const novoMax = Math.max(1, (ficha.vida.max - dano)); const novoAtual = Math.min(ficha.vida.atual, novoMax); await updateDoc(doc(db, "fichas", id), { sequelas: seq, "vida.max": novoMax, "vida.atual": novoAtual }); alert(`Transforma√ß√£o cessou. -${dano} Vida M√°xima.`); } else { await updateDoc(doc(db, "fichas", id), { sequelas: seq }); alert("Transforma√ß√£o cessou. Exaust√£o aplicada."); } }
window.gmUnlock = async (tipo) => { const unlocked = ficha.transfUnlocked || {}; unlocked[tipo] = true; await updateDoc(doc(db, "fichas", id), { transfUnlocked: unlocked }); };
window.gmClearDebuff = async () => { await updateDoc(doc(db, "fichas", id), { sequelas: { exaustao: false, corrupcao: false } }); alert("Sequelas removidas."); };
window.setSkillBonus = async (skillName, val) => { const pericias = ficha.pericias || {}; if (!pericias[skillName]) pericias[skillName] = { t: false, m: false, bonus: 0 }; pericias[skillName].bonus = Number(val); await updateDoc(doc(db, "fichas", id), { pericias: pericias }); };
window.setAptidao = async (nomeApt, novoNivel) => { if (!isMestre) return; const progresso = ficha.progressoAptidoes || {}; progresso[nomeApt] = novoNivel; await updateDoc(doc(db, "fichas", id), { progressoAptidoes: progresso }); };
window.addNovaAptidao = async () => { if (!isMestre) return; const nome = prompt("Nome da Nova Aptid√£o:"); if (!nome) return; const nova = { nome: nome, maxNivel: 5, descricao: "Descri√ß√£o...", niveis: ["NV 1...", "NV 2...", "NV 3...", "NV 4...", "NV 5..."] }; const custom = ficha.aptidoesCustom || []; custom.push(nova); await updateDoc(doc(db, "fichas", id), { aptidoesCustom: custom }); alert("Criada!"); };
window.abrirEditorAptidao = (index) => { editingAptIndex = index; const modal = document.getElementById('aptidaoEditorModal'); if(index > -1) { const apt = ficha.aptidoesCustom[index]; document.getElementById('editAptNome').value = apt.nome; document.getElementById('editAptDesc').value = apt.descricao; document.getElementById('editAptMax').value = apt.maxNivel; renderLevelInputs(apt.niveis); document.getElementById('btnExcluirApt').style.display = 'block'; } else { document.getElementById('editAptNome').value = ""; document.getElementById('editAptDesc').value = ""; document.getElementById('editAptMax').value = 5; renderLevelInputs(); document.getElementById('btnExcluirApt').style.display = 'none'; } modal.style.display = 'flex'; };
window.renderLevelInputs = (existingLevels = []) => { const max = Number(document.getElementById('editAptMax').value); const container = document.getElementById('editAptLevelsContainer'); container.innerHTML = ""; for(let i=0; i<max; i++) { const val = existingLevels[i] || ""; container.innerHTML += `<input class="inline-input" style="width:100%; text-align:left;" placeholder="Descri√ß√£o N√≠vel ${i+1}" value="${val}">`; } };
window.salvarAptidaoCustom = async () => { const max = Number(document.getElementById('editAptMax').value); const niveis = []; document.querySelectorAll('#editAptLevelsContainer input').forEach(input => niveis.push(input.value)); const novaApt = { nome: document.getElementById('editAptNome').value, descricao: document.getElementById('editAptDesc').value, maxNivel: max, niveis: niveis }; if(!ficha.aptidoesCustom) ficha.aptidoesCustom = []; if(editingAptIndex === -1) ficha.aptidoesCustom.push(novaApt); else ficha.aptidoesCustom[editingAptIndex] = novaApt; await updateDoc(doc(db, "fichas", id), { aptidoesCustom: ficha.aptidoesCustom }); document.getElementById('aptidaoEditorModal').style.display = 'none'; };
window.excluirAptidaoCustom = async () => { if(editingAptIndex === -1 || !confirm("Excluir?")) return; ficha.aptidoesCustom.splice(editingAptIndex, 1); await updateDoc(doc(db, "fichas", id), { aptidoesCustom: ficha.aptidoesCustom }); document.getElementById('aptidaoEditorModal').style.display = 'none'; };
window.abrirItemModal = (index = -1) => { editingItemIndex = index; document.getElementById('itemModal').style.display = 'block'; document.getElementById('propList').innerHTML = ""; document.getElementById('encantList').innerHTML = ""; document.getElementById('btnExcluirItem').style.display = index === -1 ? 'none' : 'block'; document.getElementById('itemModalTitle').innerText = index === -1 ? 'Novo Item' : 'Editar Item'; if (index > -1) { const item = ficha.inventario[index]; document.getElementById('itNome').value = item.nome; document.getElementById('itTipo').value = item.tipo; document.getElementById('itGrau').value = item.grau; document.getElementById('itEspacos').value = item.espacos; document.getElementById('itBonus').value = item.bonus; document.getElementById('itImg').value = item.imagem; document.getElementById('itDesc').value = item.descricao; (item.propriedades || []).forEach(p => addPropField(p.nome, p.desc)); (item.encantamentos || []).forEach(e => addEncantField(e.nome, e.desc)); } else { document.getElementById('itNome').value = ""; document.getElementById('itEspacos').value = 1; document.getElementById('itBonus').value = ""; document.getElementById('itImg').value = ""; document.getElementById('itDesc').value = ""; } };
window.addPropField = (nome = "", desc = "") => { const div = document.createElement('div'); div.className = 'dynamic-list-item'; div.innerHTML = `<div style="flex-grow:1; display:flex; flex-direction:column; gap:5px;"><input placeholder="Nome" value="${nome}" class="prop-name"><textarea placeholder="Descri√ß√£o" class="prop-desc" style="height:50px;">${desc}</textarea></div><button class="btn-del-item" onclick="this.parentElement.remove()">‚úñ</button>`; document.getElementById('propList').appendChild(div); };
window.addEncantField = (nome = "", desc = "") => { const div = document.createElement('div'); div.className = 'dynamic-list-item'; div.innerHTML = `<div style="flex-grow:1; display:flex; flex-direction:column; gap:5px;"><input placeholder="Nome" value="${nome}" class="encant-name" style="border-color:var(--energy);"><textarea placeholder="Descri√ß√£o" class="encant-desc" style="height:50px;">${desc}</textarea></div><button class="btn-del-item" onclick="this.parentElement.remove()">‚úñ</button>`; document.getElementById('encantList').appendChild(div); };
window.salvarItem = async () => { const novoItem = { nome: document.getElementById('itNome').value || "Item", tipo: document.getElementById('itTipo').value, grau: document.getElementById('itGrau').value, espacos: Number(document.getElementById('itEspacos').value), bonus: document.getElementById('itBonus').value, imagem: document.getElementById('itImg').value, descricao: document.getElementById('itDesc').value, propriedades: [], encantamentos: [] }; document.querySelectorAll('#propList .dynamic-list-item').forEach(el => { novoItem.propriedades.push({ nome: el.querySelector('.prop-name').value, desc: el.querySelector('.prop-desc').value }); }); document.querySelectorAll('#encantList .dynamic-list-item').forEach(el => { novoItem.encantamentos.push({ nome: el.querySelector('.encant-name').value, desc: el.querySelector('.encant-desc').value }); }); if (!ficha.inventario) ficha.inventario = []; if (editingItemIndex === -1) ficha.inventario.push(novoItem); else ficha.inventario[editingItemIndex] = novoItem; await updateDoc(doc(db, "fichas", id), { inventario: ficha.inventario }); document.getElementById('itemModal').style.display = 'none'; };
window.excluirItem = async () => { if (editingItemIndex === -1) return; if (!confirm("Excluir?")) return; ficha.inventario.splice(editingItemIndex, 1); await updateDoc(doc(db, "fichas", id), { inventario: ficha.inventario }); document.getElementById('itemModal').style.display = 'none'; };
window.toggleCombatTrain = async (key) => { const combate = ficha.combate || {}; if (!combate[key]) combate[key] = { treino: false, outros: 0 }; combate[key].treino = !combate[key].treino; await updateDoc(doc(db, "fichas", id), { combate: combate }); };
window.setCombatOther = async (key, val) => { const combate = ficha.combate || {}; if (!combate[key]) combate[key] = { treino: false, outros: 0 }; combate[key].outros = Number(val); await updateDoc(doc(db, "fichas", id), { combate: combate }); };
window.toggleMeleeAttr = async () => { const combate = ficha.combate || {}; if (!combate.corpo) combate.corpo = { treino: false, outros: 0, usaDes: false }; combate.corpo.usaDes = !combate.corpo.usaDes; await updateDoc(doc(db, "fichas", id), { combate: combate }); };
window.setMagicAttr = async (attr) => { const combate = ficha.combate || {}; if (!combate.magico) combate.magico = { outros: 0, atributo: 'inteligencia' }; combate.magico.atributo = attr; await updateDoc(doc(db, "fichas", id), { combate: combate }); };
window.mathStat = (el, key) => { if(el.querySelector('input')) return; const originalHtml = el.innerHTML; el.innerHTML = ''; const input = document.createElement('input'); input.placeholder = "+/-"; input.className = 'math-input'; input.type = 'text'; el.appendChild(input); input.focus(); const executar = async () => { const val = input.value.trim(); if(!val) { el.innerHTML = originalHtml; return; } const num = Number(val); if(isNaN(num)) { el.innerHTML = originalHtml; return; } const st = ficha[key]; let novo = Number(st.atual) + num; novo = Math.max(0, Math.min(st.max, novo)); await updateDoc(doc(db, "fichas", id), { [`${key}.atual`]: novo }); el.innerHTML = originalHtml; }; input.addEventListener('blur', executar); input.addEventListener('keydown', (e) => { if(e.key === 'Enter') input.blur(); }); };
window.editarCampo = (el, field, type) => { if (el.querySelector('input')) return; editandoId = field; const valorAtual = el.innerText; el.innerHTML = `<input id="inputEdit" class="inline-input" type="${type}" value="${valorAtual}">`; const input = document.getElementById('inputEdit'); input.focus(); const salvar = async () => { let novoValor = input.value; if (type === 'number') novoValor = Number(novoValor); el.innerHTML = novoValor; editandoId = null; try { await updateDoc(doc(db, "fichas", id), { [field]: novoValor }); } catch (e) { console.error(e); el.innerText = valorAtual; } }; input.addEventListener('blur', salvar); input.addEventListener('keydown', (e) => { if (e.key === 'Enter') input.blur(); }); };
window.togglePericia = async (skillName, tipo) => { const pericias = ficha.pericias || {}; if (!pericias[skillName]) pericias[skillName] = { t: false, m: false }; pericias[skillName][tipo] = !pericias[skillName][tipo]; await updateDoc(doc(db, "fichas", id), { pericias: pericias }); };
window.upStat = async (key, val) => { const st = ficha[key]; const novo = Math.max(0, Math.min(st.max, Number(st.atual)+val)); await updateDoc(doc(db, "fichas", id), { [`${key}.atual`]: novo }); };
window.irParaShikigamis = () => { window.location = `shikigamis.html?charId=${id}`; };
window.irParaFeiticos = () => { window.location = `feiticos.html?id=${id}`; };
window.abrirConfig = () => { document.getElementById('configModal').style.display = 'block'; document.getElementById('editImgUrl').value = ficha.imagem || ""; };
window.salvarImg = async () => { await updateDoc(doc(db, "fichas", id), { imagem: document.getElementById('editImgUrl').value }); alert("Imagem atualizada!"); };
window.excluirPersonagem = async () => { if(prompt("Digite DELETAR para confirmar:")==="DELETAR") { await deleteDoc(doc(db, "fichas", id)); window.location="index.html"; } };
</script>
</body>
</html>
