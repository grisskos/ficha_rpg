<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>T√©cnicas e Artes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Funnel+Sans:wght@300..800&display=swap" rel="stylesheet">
<style>
  :root { 
    --bg: #0f0f0f; --card: #141414; --text: #f1f1f1; --border: #333;
    --magic: #58E8DA; --phys: #e63946; --special: #D073FA;
  }
  
  * { box-sizing: border-box; }
  body { background: var(--bg); color: var(--text); font-family: 'Funnel Sans', sans-serif; padding: 20px; margin: 0; }

  .header-nav { display: flex; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
  .btn-back { background: transparent; border: 1px solid #555; color: #888; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-right: 15px; }
  h1 { margin: 0; font-size: 1.5rem; text-transform: uppercase; letter-spacing: 1px; }

  /* BARRA DE STATUS */
  .status-bar { 
    background: #1a1a1a; padding: 10px 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--border);
    display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;
  }
  .slots-display { font-weight: bold; color: var(--magic); }
  .passive-toggles { display: flex; gap: 15px; }
  .toggle-label { font-size: 0.9rem; color: #aaa; cursor: pointer; display: flex; align-items: center; gap: 5px; }
  .toggle-label input { accent-color: var(--magic); width: 16px; height: 16px; }

  .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; max-width: 1400px; margin: 0 auto; }
  @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }

  .section-box { display: flex; flex-direction: column; gap: 15px; }
  
  .core-box { background: var(--card); padding: 20px; border-radius: 10px; border: 1px solid var(--border); position: relative; }
  .core-magic { border-top: 4px solid var(--magic); }
  .core-phys { border-top: 4px solid var(--phys); }
  
  .core-title { background: transparent; border: none; color: white; font-size: 1.4rem; font-weight: bold; width: 100%; outline: none; margin-bottom: 10px; }
  .core-desc { background: #111; border: 1px solid var(--border); color: #ccc; width: 100%; min-height: 80px; padding: 10px; border-radius: 5px; resize: vertical; font-family: inherit; }
  .btn-save-core { background: #222; color: #aaa; border: 1px solid var(--border); padding: 5px 10px; font-size: 0.8rem; border-radius: 4px; cursor: pointer; float: right; margin-top: 5px; }
  .btn-save-core:hover { background: #333; color: white; }

  /* CARDS */
  .cards-container { display: flex; flex-direction: column; gap: 15px; }
  .skill-card { 
    background: var(--card); border-radius: 8px; overflow: hidden; border: 1px solid var(--border); 
    position: relative; transition: transform 0.2s; 
  }
  .skill-card:hover { transform: translateY(-2px); border-color: #555; }
  
  .skill-card.locked { opacity: 0.5; filter: grayscale(0.8); border: 1px dashed #555; }
  .skill-card.locked::after {
    content: "N√çVEL INSUFICIENTE"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-10deg);
    font-size: 1.5rem; font-weight: bold; color: rgba(255, 0, 0, 0.5); border: 2px solid rgba(255, 0, 0, 0.5); padding: 10px; pointer-events: none;
  }

  .card-magic { border-left: 5px solid var(--magic); }
  .card-phys { border-left: 5px solid var(--phys); }

  .card-header { padding: 10px 15px; background: #1a1a1a; display: flex; justify-content: space-between; align-items: center; }
  .card-title { font-weight: bold; font-size: 1.1rem; }
  
  .card-lvl-badge { font-size: 0.75rem; background: #333; padding: 2px 8px; border-radius: 10px; color: #fff; margin-left: 10px; }
  .card-type-badge { font-size: 0.7rem; color: var(--special); border: 1px solid var(--special); padding: 1px 6px; border-radius: 4px; margin-left: 5px; text-transform: uppercase; }
  .card-cost { font-size: 0.75rem; color: var(--magic); font-weight: bold; margin-left: auto; margin-right: 10px; }
  .card-cost.reduced { color: #00ff00; } 

  .card-stats { display: flex; gap: 15px; padding: 8px 15px; background: #111; font-size: 0.85rem; color: #aaa; border-bottom: 1px solid #222; }
  .stat-item { display: flex; align-items: center; gap: 5px; }

  .card-body { padding: 15px; font-size: 0.95rem; color: #ddd; white-space: pre-wrap; }
  
  .card-actions { display: flex; gap: 5px; }
  .btn-icon { background: #000; border: 1px solid #444; color: #fff; width: 25px; height: 25px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; }
  .btn-icon:hover { border-color: white; }
  .btn-del:hover { border-color: #d00000; color: #d00000; }

  .btn-add { width: 100%; padding: 12px; border-radius: 8px; border: 2px dashed #444; background: transparent; color: #666; font-weight: bold; cursor: pointer; transition: 0.2s; }
  .btn-add:hover { border-color: #777; color: #fff; background: #1a1a1a; }
  .btn-add-magic:hover { border-color: var(--magic); color: var(--magic); }
  .btn-add-phys:hover { border-color: var(--phys); color: var(--phys); }

  /* MODAL */
  .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; align-items: center; justify-content: center; overflow-y: auto; padding: 20px 0; }
  .modal.open { display: flex; }
  .modal-box { background: var(--card); width: 90%; max-width: 500px; padding: 20px; border-radius: 10px; border: 1px solid var(--border); margin: auto; }
  
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
  label { display: block; color: #888; font-size: 0.8rem; margin-bottom: 4px; }
  input, textarea, select { width: 100%; background: #000; border: 1px solid #333; color: white; padding: 8px; border-radius: 4px; outline: none; font-family: inherit; }
  textarea { height: 100px; resize: vertical; }
  input:focus, textarea:focus { border-color: #777; }

  .special-note { 
    font-size: 0.8rem; color: var(--special); margin-top: 10px; 
    border: 1px solid var(--special); padding: 10px; border-radius: 5px; 
    background: rgba(208, 115, 250, 0.1); display: none;
  }

  .btn-confirm { width: 100%; padding: 10px; margin-top: 15px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; color: #000; }
  
  .level-info { text-align: center; color: #666; font-size: 0.8rem; margin-bottom: 5px; }
  .level-info b { color: var(--magic); }
</style>
</head>
<body>

<div class="header-nav">
  <button class="btn-back" onclick="voltar()">‚¨Ö Voltar</button>
  <h1>Grim√≥rio de T√©cnicas</h1>
</div>

<div class="status-bar">
  <span id="slotsDisplay" class="slots-display">Feiti√ßos: ...</span>
  
  <div class="passive-toggles">
    <label class="toggle-label" title="N√≠vel 10 - Reduz custo em 2">
      <input type="checkbox" id="chkEconomia" onchange="salvarPassivas()"> Foco: Economia
    </label>
    <label class="toggle-label" title="N√≠vel 20 - Reduz custo pela metade (Nv 1-3)">
      <input type="checkbox" id="chkHonrado" onchange="salvarPassivas()"> O Honrado
    </label>
  </div>
</div>

<div id="levelDisplay" class="level-info">...</div>

<div class="main-grid">
  
  <div class="section-box">
    <h2 style="color:var(--magic)">T√©cnica Inata</h2>
    
    <div class="core-box core-magic">
      <input id="coreInataNome" class="core-title" placeholder="Nome da T√©cnica (Ex: Dez Sombras)">
      <textarea id="coreInataDesc" class="core-desc" placeholder="Descreva o funcionamento b√°sico da sua t√©cnica..."></textarea>
      <button class="btn-save-core" onclick="salvarCores()">Salvar Descri√ß√£o</button>
    </div>

    <div id="listaFeiticos" class="cards-container"></div>
    
    <button class="btn-add btn-add-magic" onclick="abrirModal('feitico')">+ Novo Feiti√ßo</button>
  </div>

  <div class="section-box">
    <h2 style="color:var(--phys)">Artes Marciais</h2>
    
    <div class="core-box core-phys">
      <input id="coreMarcialNome" class="core-title" placeholder="Nome do Estilo (Ex: Punho Gentil)">
      <textarea id="coreMarcialDesc" class="core-desc" placeholder="Descreva o funcionamento do seu estilo de luta..."></textarea>
      <button class="btn-save-core" onclick="salvarCores()">Salvar Descri√ß√£o</button>
    </div>

    <div id="listaMarcial" class="cards-container"></div>
    
    <button class="btn-add btn-add-phys" onclick="abrirModal('marcial')">+ Nova T√©cnica Marcial</button>
  </div>

</div>

<div id="modalCard" class="modal">
  <div class="modal-box">
    <h2 id="modalTitle" style="margin-top:0; color:white;">Nova Habilidade</h2>
    
    <label>Nome</label>
    <input id="inNome" placeholder="Ex: Vazio Roxo / Chute Alto">
    
    <div id="spellConfig" style="margin-top:10px;">
      <div class="form-row">
        <div>
          <label>N√≠vel do Feiti√ßo</label>
          <select id="inFeiticoNivel" onchange="atualizarInfoFeitico()">
            <option value="0">N√≠vel 0</option>
            <option value="1">N√≠vel 1</option>
            <option value="2">N√≠vel 2</option>
            <option value="3">N√≠vel 3</option>
            <option value="4">N√≠vel 4</option>
            <option value="5">N√≠vel 5</option>
          </select>
        </div>
        <div>
          <label>Custo Base</label>
          <input id="inCustoDisplay" readonly style="color:var(--magic); font-weight:bold;">
        </div>
      </div>

      <label>Tipo de Feiti√ßo</label>
      <select id="inFeiticoTipo" onchange="atualizarRegrasEspeciais()" style="margin-bottom:10px;">
        <option value="Normal">Feiti√ßo Padr√£o (Dano/Cura/Utilidade)</option>
        <option value="Shikigami">Cria√ß√£o de Shikigami</option>
        <option value="Item">Cria√ß√£o de Item</option>
      </select>
      
      <div id="shikigamiNote" class="special-note">
        <b>Regra de Shikigami:</b> O custo de invoca√ß√£o √© igual ao do Feiti√ßo. Este custo vira "PE Permanente" reduzido do seu m√°ximo enquanto o Shikigami existir.<br>
        ‚Ä¢ Nv 0-1: Grau 4<br>
        ‚Ä¢ Nv 2: Grau 3<br>
        ‚Ä¢ Nv 3: Grau 2<br>
        ‚Ä¢ Nv 4: Grau 1<br>
        ‚Ä¢ Nv 5: Grau Especial
      </div>
      
      <div id="itemNote" class="special-note">
        <b>Regra de Item:</b> Cria um item de Custo igual ao N√≠vel do feiti√ßo. 
        Feiti√ßos de n√≠vel maior podem criar +1 item do custo anterior.<br>
        ‚Ä¢ Itens n√£o contam no limite de carga.
      </div>
    </div>

    <div id="genericConfig" class="form-row" style="display:none;">
      <div><label>N√≠vel / Custo</label><input id="inGenericNivel" placeholder="Ex: Nvl 1 / 2 PE"></div>
    </div>

    <div class="form-row">
      <div><label>Dano / Cura</label><input id="inDano" placeholder="Ex: 2d8+2"></div>
      <div><label>Alcance / √Årea</label><input id="inArea" placeholder="Ex: Cone 9m / Toque"></div>
    </div>
    
    <label>Efeitos & Descri√ß√£o</label>
    <textarea id="inEfeito" placeholder="Descreva o que acontece..."></textarea>

    <button id="btnConfirmar" class="btn-confirm">Salvar</button>
    <button onclick="fecharModal()" style="width:100%; background:transparent; border:none; color:#666; margin-top:10px; cursor:pointer;">Cancelar</button>
  </div>
</div>

<script type="module">
import { db, doc, getDoc, updateDoc } from "./firebase.js";

const params = new URLSearchParams(location.search);
const id = params.get("id");
let ficha = {};
let editType = null;
let editIndex = -1;

const CUSTO_BASE = { 0: 0, 1: 2, 2: 5, 3: 8, 4: 12, 5: 20 };

window.onload = async () => {
  if(!id) return alert("ID n√£o encontrado");
  await carregar();
};

async function carregar() {
  const snap = await getDoc(doc(db, "fichas", id));
  if(snap.exists()){
    ficha = snap.data();
    if(!ficha.passivas) ficha.passivas = { economia: false, honrado: false };
    
    document.getElementById('chkEconomia').checked = ficha.passivas.economia;
    document.getElementById('chkHonrado').checked = ficha.passivas.honrado;
    
    renderTudo();
  }
}

// === C√ÅLCULO DE SLOTS ===
function getSlotsInfo() {
  const nivel = Number(ficha.nivel || 1);
  const isEspecialista = (ficha.classe === "Especialista em T√©cnica");
  
  let slots = 0;

  if (isEspecialista) {
    // Especialista: 1 por n√≠vel (+1 extra no 10 e 20)
    // Nivel 1 = 2 Feiti√ßos (Base)
    // Nivel 2 = 3 Feiti√ßos (+1)
    // Formula: 1 + Nivel
    slots = 1 + nivel;
  } else {
    // Padr√£o: 2 Base + 1 a cada par
    slots = 2 + Math.floor(nivel / 2);
  }

  // B√¥nus de N√≠vel 10 e 20 (Para todos)
  if (nivel >= 10) slots += 1;
  if (nivel >= 20) slots += 1;
  
  const usados = (ficha.feiticos || []).length;
  return `${usados} / ${slots}`;
}

// === C√ÅLCULO DE ACESSO (N√çVEL M√ÅXIMO) ===
function getNivelMaximoFeitico() {
  const nivel = ficha.nivel || 1;
  const isEspecialista = (ficha.classe === "Especialista em T√©cnica");

  if (isEspecialista) {
    if (nivel >= 15) return 5;
    if (nivel >= 11) return 4;
    if (nivel >= 7) return 3;
    if (nivel >= 4) return 2;
    return 1; 
  } else {
    if (nivel >= 17) return 5;
    if (nivel >= 13) return 4;
    if (nivel >= 9) return 3;
    if (nivel >= 5) return 2;
    return 1;
  }
}

// === C√ÅLCULO DE CUSTO REAL ===
function calcularCustoReal(nivelBase) {
  let custo = CUSTO_BASE[nivelBase];
  if (nivelBase === 0) return 0;

  if (ficha.passivas?.economia) {
    custo -= 2;
    if (nivelBase === 1 && custo < 0) custo = 0;
  }

  if (ficha.passivas?.honrado && nivelBase <= 3) {
    custo = Math.floor(custo / 2);
  }

  return Math.max(0, custo);
}

function renderTudo() {
  const nivelMax = getNivelMaximoFeitico();
  const slotsTexto = getSlotsInfo();
  
  document.getElementById('slotsDisplay').innerText = `Feiti√ßos Conhecidos: ${slotsTexto}`;
  document.getElementById('levelDisplay').innerHTML = `
    Personagem N√≠vel <b>${ficha.nivel || 1}</b> ‚Ä¢ 
    Acesso at√© N√≠vel <b>${nivelMax}</b>
    ${ficha.classe === "Especialista em T√©cnica" ? "(Evolu√ß√£o Adiantada)" : ""}
  `;

  document.getElementById('coreInataNome').value = ficha.tecnicaInata?.nome || "";
  document.getElementById('coreInataDesc').value = ficha.tecnicaInata?.descricao || "";
  document.getElementById('coreMarcialNome').value = ficha.estiloMarcial?.nome || "";
  document.getElementById('coreMarcialDesc').value = ficha.estiloMarcial?.descricao || "";

  // FEITI√áOS
  const divFeiticos = document.getElementById('listaFeiticos');
  divFeiticos.innerHTML = "";
  (ficha.feiticos || []).forEach((f, i) => {
    const nivelNecessario = Number(f.nivelFeitico || 0);
    const bloqueado = nivelNecessario > nivelMax;
    divFeiticos.innerHTML += cardHtml(f, i, 'feitico', bloqueado, nivelNecessario);
  });

  // MARCIAIS
  const divMarcial = document.getElementById('listaMarcial');
  divMarcial.innerHTML = "";
  (ficha.artesMarciais || []).forEach((f, i) => {
    divMarcial.innerHTML += cardHtml(f, i, 'marcial', false, 0);
  });
}

function cardHtml(dados, index, tipo, bloqueado, nivelFeitico) {
  const corClass = tipo === 'feitico' ? 'card-magic' : 'card-phys';
  const lockClass = bloqueado ? 'locked' : '';
  
  const iconDano = dados.dano ? `<span class="stat-item" title="Dano">‚öîÔ∏è ${dados.dano}</span>` : '';
  const iconArea = dados.area ? `<span class="stat-item" title="√Årea">üéØ ${dados.area}</span>` : '';
  
  let badge = "";
  let custoHtml = "";
  let typeBadge = "";

  if(tipo === 'feitico') {
    badge = `<span class="card-lvl-badge">N√≠vel ${nivelFeitico}</span>`;
    
    const custoOriginal = CUSTO_BASE[nivelFeitico];
    const custoReal = calcularCustoReal(nivelFeitico);
    const reducedClass = custoReal < custoOriginal ? "reduced" : "";
    custoHtml = `<span class="card-cost ${reducedClass}">${custoReal} PE</span>`;

    if(dados.tipoEspecial && dados.tipoEspecial !== "Normal") {
      typeBadge = `<span class="card-type-badge">${dados.tipoEspecial}</span>`;
    }
  } else {
    badge = dados.nivel ? `<span class="card-lvl-badge">${dados.nivel}</span>` : '';
  }
  
  return `
    <div class="skill-card ${corClass} ${lockClass}">
      <div class="card-header">
        <div style="display:flex; align-items:center;">
          <span class="card-title">${dados.nome}</span>
          ${badge}
          ${typeBadge}
        </div>
        
        <div style="display:flex; align-items:center;">
          ${custoHtml}
          <div class="card-actions">
            <div class="btn-icon" onclick="editar('${tipo}', ${index})">‚úé</div>
            <div class="btn-icon btn-del" onclick="excluir('${tipo}', ${index})">‚úñ</div>
          </div>
        </div>
      </div>
      
      <div class="card-stats">
        ${iconDano} ${iconArea}
      </div>
      <div class="card-body">${dados.efeito}</div>
    </div>
  `;
}

// === A√á√ïES ===

window.salvarPassivas = async () => {
  const passivas = {
    economia: document.getElementById('chkEconomia').checked,
    honrado: document.getElementById('chkHonrado').checked
  };
  await updateDoc(doc(db, "fichas", id), { passivas: passivas });
  ficha.passivas = passivas;
  renderTudo();
};

window.salvarCores = async () => {
  await updateDoc(doc(db, "fichas", id), {
    tecnicaInata: {
      nome: document.getElementById('coreInataNome').value,
      descricao: document.getElementById('coreInataDesc').value
    },
    estiloMarcial: {
      nome: document.getElementById('coreMarcialNome').value,
      descricao: document.getElementById('coreMarcialDesc').value
    }
  });
  alert("Salvo!");
};

window.atualizarInfoFeitico = () => {
  const nivel = document.getElementById('inFeiticoNivel').value;
  document.getElementById('inCustoDisplay').value = CUSTO_BASE[nivel] + " PE";
};

window.atualizarRegrasEspeciais = () => {
  const tipo = document.getElementById('inFeiticoTipo').value;
  document.getElementById('shikigamiNote').style.display = (tipo === 'Shikigami') ? 'block' : 'none';
  document.getElementById('itemNote').style.display = (tipo === 'Item') ? 'block' : 'none';
}

window.abrirModal = (tipo) => {
  editType = tipo;
  editIndex = -1; 
  
  document.getElementById('modalTitle').innerText = tipo === 'feitico' ? "Novo Feiti√ßo" : "Nova T√©cnica Marcial";
  document.getElementById('btnConfirmar').style.background = tipo === 'feitico' ? "var(--magic)" : "var(--phys)";
  
  if (tipo === 'feitico') {
    document.getElementById('spellConfig').style.display = 'block';
    document.getElementById('genericConfig').style.display = 'none';
    document.getElementById('inFeiticoNivel').value = "0";
    document.getElementById('inFeiticoTipo').value = "Normal";
    atualizarInfoFeitico();
    atualizarRegrasEspeciais();
  } else {
    document.getElementById('spellConfig').style.display = 'none';
    document.getElementById('genericConfig').style.display = 'block';
  }
  
  document.getElementById('inNome').value = "";
  document.getElementById('inGenericNivel').value = "";
  document.getElementById('inDano').value = "";
  document.getElementById('inArea').value = "";
  document.getElementById('inEfeito').value = "";
  
  document.getElementById('modalCard').classList.add('open');
};

window.editar = (tipo, index) => {
  editType = tipo;
  editIndex = index;
  
  const lista = tipo === 'feitico' ? (ficha.feiticos||[]) : (ficha.artesMarciais||[]);
  const item = lista[index];

  document.getElementById('modalTitle').innerText = "Editar Habilidade";
  document.getElementById('btnConfirmar').style.background = tipo === 'feitico' ? "var(--magic)" : "var(--phys)";

  if (tipo === 'feitico') {
    document.getElementById('spellConfig').style.display = 'block';
    document.getElementById('genericConfig').style.display = 'none';
    document.getElementById('inFeiticoNivel').value = item.nivelFeitico || 0;
    document.getElementById('inFeiticoTipo').value = item.tipoEspecial || "Normal";
    atualizarInfoFeitico();
    atualizarRegrasEspeciais();
  } else {
    document.getElementById('spellConfig').style.display = 'none';
    document.getElementById('genericConfig').style.display = 'block';
    document.getElementById('inGenericNivel').value = item.nivel;
  }

  document.getElementById('inNome').value = item.nome;
  document.getElementById('inDano').value = item.dano;
  document.getElementById('inArea').value = item.area;
  document.getElementById('inEfeito').value = item.efeito;

  document.getElementById('modalCard').classList.add('open');
};

document.getElementById('btnConfirmar').onclick = async () => {
  const novoItem = {
    nome: document.getElementById('inNome').value || "Sem Nome",
    dano: document.getElementById('inDano').value,
    area: document.getElementById('inArea').value,
    efeito: document.getElementById('inEfeito').value
  };

  if (editType === 'feitico') {
    novoItem.nivelFeitico = document.getElementById('inFeiticoNivel').value;
    novoItem.tipoEspecial = document.getElementById('inFeiticoTipo').value;
    
    if(!ficha.feiticos) ficha.feiticos = [];
    if(editIndex === -1) ficha.feiticos.push(novoItem);
    else ficha.feiticos[editIndex] = novoItem;
    await updateDoc(doc(db, "fichas", id), { feiticos: ficha.feiticos });
  } else {
    novoItem.nivel = document.getElementById('inGenericNivel').value;
    if(!ficha.artesMarciais) ficha.artesMarciais = [];
    if(editIndex === -1) ficha.artesMarciais.push(novoItem);
    else ficha.artesMarciais[editIndex] = novoItem;
    await updateDoc(doc(db, "fichas", id), { artesMarciais: ficha.artesMarciais });
  }

  fecharModal();
  renderTudo();
};

window.excluir = async (tipo, index) => {
  if(!confirm("Excluir esta habilidade?")) return;
  if(tipo === 'feitico') {
    ficha.feiticos.splice(index, 1);
    await updateDoc(doc(db, "fichas", id), { feiticos: ficha.feiticos });
  } else {
    ficha.artesMarciais.splice(index, 1);
    await updateDoc(doc(db, "fichas", id), { artesMarciais: ficha.artesMarciais });
  }
  renderTudo();
};

window.fecharModal = () => { document.getElementById('modalCard').classList.remove('open'); };
window.voltar = () => { window.location = `ficha.html?id=${id}`; };
</script>
</body>
</html>
