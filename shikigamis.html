<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Grimório de Invocações</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Funnel+Sans:wght@300..800&display=swap" rel="stylesheet">
<style>
  :root { 
    --bg: #0f0f0f; --card: #141414; --primary: #e63946; --energy: #58E8DA; --text: #f1f1f1; --border: #333;
    --input-bg: #000;
  }
  
  * { box-sizing: border-box; }
  body { background: var(--bg); color: var(--text); font-family: 'Funnel Sans', sans-serif; padding: 20px; margin: 0; display:flex; height: 100vh; overflow: hidden; }

  /* LAYOUT */
  .layout { display: grid; grid-template-columns: 280px 1fr; gap: 20px; width: 100%; max-width: 1400px; margin: 0 auto; height: 100%; }
  
  /* SIDEBAR */
  .sidebar { display: flex; flex-direction: column; gap: 10px; border-right: 1px solid var(--border); padding-right: 20px; overflow-y: auto; }
  .shikigami-item { 
    background: var(--card); border: 1px solid var(--border); padding: 10px; border-radius: 8px; 
    cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 10px;
  }
  .shikigami-item:hover, .shikigami-item.active { border-color: var(--energy); background: #1a1a1a; }
  .sidebar-thumb { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid var(--energy); flex-shrink: 0; background: #222; }
  .shiki-info h3 { margin: 0; font-size: 1rem; }
  .shiki-info small { color: #888; }
  .btn-new { background: var(--energy); color: #000; border: none; padding: 10px; width: 100%; border-radius: 5px; cursor: pointer; font-weight: bold; margin-bottom: 10px; }
  .btn-back { background: transparent; border: 1px solid #555; color: #888; padding: 8px; width: 100%; border-radius: 5px; cursor: pointer; margin-top: auto; }

  /* MAIN AREA */
  .main-area { overflow-y: auto; padding-right: 10px; display: none; }
  .main-area.visible { display: block; }

  /* HEADER CENTRALIZADO */
  .shiki-header { 
    display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; 
    background: var(--card); padding: 20px; border-radius: 10px; border: 1px solid var(--border);
  }
  .big-preview { 
    width: 150px; height: 150px; border-radius: 50%; object-fit: cover; 
    border: 4px solid var(--energy); background: #000; margin-bottom: 15px; box-shadow: 0 0 15px rgba(88, 232, 218, 0.2);
  }
  .name-input { background: transparent; border: none; border-bottom: 2px solid var(--energy); color: white; font-size: 2rem; font-weight: bold; text-align: center; width: 100%; outline: none; }
  .url-input { background: transparent; border: none; color: #666; font-size: 0.8rem; text-align: center; width: 100%; margin-top: 5px; outline: none; }

  .header-stats-bar { display: flex; justify-content: center; gap: 20px; margin-top: 15px; width: 100%; flex-wrap: wrap; }
  .h-stat { background: #111; padding: 5px 15px; border-radius: 5px; border: 1px solid #333; text-align: center; }
  .h-stat b { color: var(--energy); display: block; font-size: 1.2rem; }
  .h-stat span { color: #888; font-size: 0.8rem; text-transform: uppercase; }

  /* GRID DE CONTEÚDO */
  .content-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
  @media (max-width: 900px) { .content-grid { grid-template-columns: 1fr; } .layout { grid-template-columns: 1fr; } .sidebar { display: none; } }

  .panel { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 15px; height: fit-content; }
  .panel h3 { margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 10px; color: var(--primary); }

  table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
  td { padding: 5px; border-bottom: 1px solid #222; }
  input[type="number"], select { background: #000; border: 1px solid #333; color: white; padding: 5px; width: 100%; text-align: center; border-radius: 4px; }

  /* AÇÕES */
  .actions-list { display: flex; flex-direction: column; gap: 10px; }
  .action-card { background: #111; padding: 10px; border-radius: 5px; border-left: 3px solid #555; position: relative; }
  .action-card.base { border-color: var(--energy); }
  .action-card.extra { border-color: var(--primary); }
  
  .act-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
  .act-type { font-size: 0.7rem; background: #222; padding: 2px 6px; border-radius: 4px; color: #ccc; border: 1px solid #333; }
  .btn-del-act { position: absolute; top: 5px; right: 5px; background: transparent; color: #d00000; border: none; cursor: pointer; font-weight: bold; }
  
  .act-input { width: 100%; background: transparent; border: none; color: white; outline: none; font-family: inherit; }
  .act-title { font-weight: bold; font-size: 1rem; margin-bottom: 5px; border-bottom: 1px dashed #333; }
  .act-desc { font-size: 0.9rem; color: #aaa; resize: vertical; width: 100%; background: transparent; border: none; }

  .slot-info { text-align: center; margin-bottom: 10px; font-size: 0.9rem; color: #aaa; }
  .slot-info b { color: white; }
  .cost-warning { color: var(--primary); font-weight: bold; }

  .btn-save { background: var(--energy); color: #000; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; float: right; }
  .btn-delete { background: transparent; color: #d00000; border: 1px solid #d00000; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
</style>
</head>
<body>

<div class="layout">
  <div id="sidebar" class="sidebar">
    <h2 style="margin-top:0; color:var(--energy);">Invocações</h2>
    <button class="btn-new" onclick="novoShikigami()">+ Nova Invocação</button>
    <div id="listaShikigamis" style="display:flex; flex-direction:column; gap:10px;">Carregando...</div>
    <button class="btn-back" onclick="voltarFicha()">Voltar para Personagem</button>
  </div>

  <div id="editorArea" class="main-area">
    <div class="shiki-header">
      <img id="shikiPreview" class="big-preview" src="" onerror="this.src='https://via.placeholder.com/150/000/58E8DA?text=Shikigami'">
      <input type="text" id="shikigamiNome" class="name-input" placeholder="Nome da Invocação">
      <input type="text" id="shikigamiImgUrl" class="url-input" placeholder="URL da Imagem" oninput="document.getElementById('shikiPreview').src=this.value">
      
      <div class="header-stats-bar">
        <div class="h-stat"><b id="displayNivel">1</b><span>Nvl Invocador</span></div>
        <div class="h-stat"><b id="pvValue">0</b><span>Vida</span></div>
        <div class="h-stat"><b id="caValue">0</b><span>Defesa</span></div>
        <div class="h-stat"><b id="dValue">0m</b><span>Desloc.</span></div>
        <div class="h-stat"><b id="cdValue">0</b><span>CD</span></div>
      </div>

      <div style="margin-top:15px; width:100%; display:flex; justify-content:space-between; align-items:center;">
        <button class="btn-delete" onclick="excluirShikigami()">Excluir</button>
        <button class="btn-save" onclick="salvarShikigami()">Salvar Alterações</button>
      </div>
    </div>

    <div class="content-grid">
      <div class="panel">
        <h3>Configuração & Atributos</h3>
        <div style="margin-bottom:15px;">
          <label style="color:#aaa; font-size:0.8rem; font-weight:bold;">GRAU DA INVOCAÇÃO</label>
          <select id="seletorGrau" style="margin-top:5px;" onchange="calcAtributos()">
            <option value="4">Grau 4</option>
            <option value="3">Grau 3</option>
            <option value="2">Grau 2</option>
            <option value="1">Grau 1</option>
            <option value="0">Grau Especial</option>
          </select>
        </div>
        <table>
          <thead><tr><th>Atributo</th><th>Valor</th><th>Mod</th></tr></thead>
          <tbody>
            <tr><td>Força</td><td><input type="number" value="8" id="a1" class="calc-trigger"></td><td id="m1">-1</td></tr>
            <tr><td>Destreza</td><td><input type="number" value="8" id="a2" class="calc-trigger"></td><td id="m2">-1</td></tr>
            <tr><td>Constituição</td><td><input type="number" value="8" id="a3" class="calc-trigger"></td><td id="m3">-1</td></tr>
            <tr><td>Inteligência</td><td><input type="number" value="8" id="a4" class="calc-trigger"></td><td id="m4">-1</td></tr>
            <tr><td>Sabedoria</td><td><input type="number" value="8" id="a5" class="calc-trigger"></td><td id="m5">-1</td></tr>
            <tr><td>Carisma</td><td><input type="number" value="8" id="a6" class="calc-trigger"></td><td id="m6">-1</td></tr>
            <tr><td colspan="2">Pontos Restantes</td><td><span id="pointView" style="color:var(--energy)">10</span></td></tr>
          </tbody>
        </table>

        <div style="margin-top:20px;">
          <label style="color:#aaa; font-size:0.8rem; font-weight:bold;">ATRIBUTO DE COMBATE</label>
          <select id="seletorAtributoPericia" class="calc-trigger" style="margin-top:5px;">
            <option value="1">Força</option><option value="2">Destreza</option>
            <option value="3">Constituição</option><option value="4">Intelecto</option>
            <option value="5">Sabedoria</option><option value="6">Carisma</option>
          </select>
          <div style="display:flex; justify-content:space-between; margin-top:5px; font-size:0.9rem;">
            <span>Perícia (Treino): <b id="pmValue" style="color:white;">0</b></span>
            <span>Perícia (Sem): <b id="pdValue" style="color:white;">0</b></span>
          </div>
        </div>
        
        <h3 style="margin-top:20px;">Habilidades de Controlador</h3>
        <div style="display:flex; flex-direction:column; gap:5px;">
          <label><input type="checkbox" name="moveis" class="habInvocador calc-trigger"> Invocações Móveis</label>
          <label><input type="checkbox" name="resistentes" class="habInvocador calc-trigger"> Invocações Resistentes</label>
          <label><input type="checkbox" name="mobilidade" class="habInvocador calc-trigger"> Controlador: Mobilidade</label>
          <label><input type="checkbox" name="resistencia" class="habInvocador calc-trigger"> Controlador: Resistência</label>
          <label><input type="checkbox" name="precisao" class="habInvocador calc-trigger"> Controlador: Precisão</label>
          <label><input type="checkbox" name="supremo" class="habInvocador calc-trigger"> Fantoche Supremo</label>
          <label><input type="checkbox" name="concentrar" class="habInvocador calc-trigger"> Concentrar Poder</label>
        </div>
      </div>

      <div class="panel">
        <h3>Características & Ações</h3>
        <div class="slot-info">Slots Base Usados: <b id="slotCount">0 / 2</b><br><span id="extraCostDisplay" class="cost-warning"></span></div>
        <div id="actionsContainer" class="actions-list"></div>
        <div style="display:flex; gap:5px; margin-top:10px;">
          <button onclick="addAcao('base')" style="width:100%; background:#222; border:1px solid var(--energy); color:white; padding:8px; cursor:pointer;">+ Base</button>
          <button onclick="addAcao('simples')" style="width:100%; background:#222; border:1px solid #666; color:#aaa; padding:8px; cursor:pointer;">+ Simples (1 PE)</button>
          <button onclick="addAcao('complexa')" style="width:100%; background:#222; border:1px solid #666; color:#aaa; padding:8px; cursor:pointer;">+ Complexa (2 PE)</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { db, doc, getDoc, addDoc, updateDoc, deleteDoc, collection, onSnapshot } from "./firebase.js";

const params = new URLSearchParams(location.search);
const charId = params.get("charId");
let currentShikiId = null;
let currentShikiData = {};
let nivelInvocador = 1;

window.onload = async () => {
  if (!charId) return alert("Erro: ID do personagem não fornecido.");

  // Pega Nível do Personagem Principal (Apenas leitura)
  const charSnap = await getDoc(doc(db, "fichas", charId));
  if(charSnap.exists()) {
    nivelInvocador = Number(charSnap.data().nivel || 1);
    document.getElementById('displayNivel').innerText = nivelInvocador;
  }

  // OUVINTE DA SUB-COLEÇÃO (BD SEPARADO)
  const q = collection(db, "fichas", charId, "shikigamis");
  onSnapshot(q, (snapshot) => {
    const lista = document.getElementById('listaShikigamis');
    lista.innerHTML = "";
    
    snapshot.forEach(docSnap => {
      const s = docSnap.data();
      const imgHtml = s.imagem ? `<img src="${s.imagem}" class="sidebar-thumb">` : `<div class="sidebar-thumb"></div>`;
      const activeClass = (docSnap.id === currentShikiId) ? 'active' : '';
      
      const item = document.createElement('div');
      item.className = `shikigami-item ${activeClass}`;
      item.innerHTML = `${imgHtml}<div class="shiki-info"><h3>${s.nome || 'Sem Nome'}</h3><small>Grau ${['Especial','1','2','3','4'][s.grau] || '?'}</small></div>`;
      item.onclick = () => abrirShikigami(docSnap.id, s);
      lista.appendChild(item);
    });
  });

  // Event Listeners
  document.querySelectorAll('.calc-trigger').forEach(el => el.addEventListener('input', calcAtributos));
  document.getElementById('seletorGrau').addEventListener('change', () => { calcAtributos(); atualizarSlots(); });
  document.getElementById('seletorAtributoPericia').addEventListener('change', calcAtributos);
};

window.novoShikigami = () => {
  currentShikiId = null; // Novo
  currentShikiData = {};
  limparFormulario();
  document.getElementById('editorArea').classList.add('visible');
};

window.abrirShikigami = (id, data) => {
  currentShikiId = id;
  currentShikiData = data;
  document.getElementById('editorArea').classList.add('visible');
  
  // Preenche Form
  document.getElementById('shikigamiNome').value = data.nome || "";
  document.getElementById('shikigamiImgUrl').value = data.imagem || "";
  document.getElementById('shikiPreview').src = data.imagem || "";
  document.getElementById('seletorGrau').value = data.grau || 4;
  document.getElementById('seletorAtributoPericia').value = data.atrPericia || 1;
  
  for(let i=1; i<=6; i++) document.getElementById(`a${i}`).value = (data.atributos && data.atributos[`a${i}`]) || 8;
  
  document.querySelectorAll('.habInvocador').forEach(chk => {
    chk.checked = data.habilidades && data.habilidades[chk.name];
  });

  // Ações (Copia array para não editar ref direta antes de salvar)
  currentShikiData.acoes = data.acoes || [];
  renderAcoes();
  calcAtributos();
};

function limparFormulario() {
  document.getElementById('shikigamiNome').value = "";
  document.getElementById('shikigamiImgUrl').value = "";
  document.getElementById('shikiPreview').src = "";
  document.getElementById('seletorGrau').value = 4;
  for(let i=1; i<=6; i++) document.getElementById(`a${i}`).value = 8;
  document.querySelectorAll('.habInvocador').forEach(c => c.checked = false);
  currentShikiData.acoes = [];
  renderAcoes();
  calcAtributos();
}

// === AÇÕES DO SHIKIGAMI ===
window.addAcao = (tipo) => {
  if(!currentShikiData.acoes) currentShikiData.acoes = [];
  currentShikiData.acoes.push({ nome: "", desc: "", tipo: tipo });
  renderAcoes();
};

window.removeAcao = (index) => {
  currentShikiData.acoes.splice(index, 1);
  renderAcoes();
};

function renderAcoes() {
  const container = document.getElementById('actionsContainer');
  container.innerHTML = "";
  
  (currentShikiData.acoes || []).forEach((acao, idx) => {
    let tipoLabel = acao.tipo === 'base' ? 'Slot Base (0 PE)' : (acao.tipo === 'simples' ? 'Extra Simples (+1 PE)' : 'Extra Complexa (+2 PE)');
    let borderClass = acao.tipo === 'base' ? 'base' : 'extra';
    
    container.innerHTML += `
      <div class="action-card ${borderClass}">
        <div class="act-header">
          <span class="act-type">${tipoLabel}</span>
          <button class="btn-del-act" onclick="removeAcao(${idx})">X</button>
        </div>
        <input class="act-input act-title" placeholder="Nome da Ação" value="${acao.nome}" oninput="updateAcao(${idx}, 'nome', this.value)">
        <textarea class="act-input act-desc" placeholder="Descrição..." oninput="updateAcao(${idx}, 'desc', this.value)">${acao.desc}</textarea>
      </div>`;
  });
  atualizarSlots();
}

window.updateAcao = (idx, field, val) => {
  currentShikiData.acoes[idx][field] = val;
};

function atualizarSlots() {
  const grau = document.getElementById('seletorGrau').value;
  let baseLimit = 2;
  if(grau == 2 || grau == 1) baseLimit = 3;
  if(grau == 0) baseLimit = 4;

  let usedBase = (currentShikiData.acoes || []).filter(a => a.tipo === 'base').length;
  let extraSimples = (currentShikiData.acoes || []).filter(a => a.tipo === 'simples').length;
  let extraComplexa = (currentShikiData.acoes || []).filter(a => a.tipo === 'complexa').length;
  let totalExtraCost = extraSimples + (extraComplexa * 2);

  const slotText = document.getElementById('slotCount');
  slotText.innerHTML = `${usedBase} / ${baseLimit}`;
  slotText.style.color = usedBase > baseLimit ? '#ff4444' : '#fff';
  document.getElementById('extraCostDisplay').innerText = totalExtraCost > 0 ? `Custo Adicional: +${totalExtraCost} PE` : "";
}

// === BD SALVAR / EXCLUIR ===
window.salvarShikigami = async () => {
  const nome = document.getElementById('shikigamiNome').value || "Invocação";
  
  const atributos = {};
  for(let i=1; i<=6; i++) atributos[`a${i}`] = Number(document.getElementById(`a${i}`).value);
  
  const habilidades = {};
  document.querySelectorAll('.habInvocador').forEach(chk => habilidades[chk.name] = chk.checked);

  const dadosSalvar = {
    nome, 
    imagem: document.getElementById('shikigamiImgUrl').value,
    grau: document.getElementById('seletorGrau').value,
    atrPericia: document.getElementById('seletorAtributoPericia').value,
    atributos,
    habilidades,
    acoes: currentShikiData.acoes || []
  };

  const subCol = collection(db, "fichas", charId, "shikigamis");

  if (currentShikiId) {
    // Atualiza Existente
    await updateDoc(doc(subCol, currentShikiId), dadosSalvar);
  } else {
    // Cria Novo
    await addDoc(subCol, dadosSalvar);
  }
  
  alert("Salvo com sucesso!");
  // Não precisa recarregar lista manual, o onSnapshot faz isso
};

window.excluirShikigami = async () => {
  if(!currentShikiId) return;
  if(!confirm("Tem certeza que deseja excluir?")) return;
  
  await deleteDoc(doc(db, "fichas", charId, "shikigamis", currentShikiId));
  document.getElementById('editorArea').classList.remove('visible');
  currentShikiId = null;
};

window.voltarFicha = () => { window.location = `ficha.html?id=${charId}`; };

// === CALCULADORA (LÓGICA) ===
window.calcAtributos = () => {
    const grauInvocacao = document.getElementById('seletorGrau').value;
    const multiplicadorInvocacao = [6, 4, 2, 1, 0][grauInvocacao];
    const maxPoints = 10 + 5 * multiplicadorInvocacao;
    let usedPoints = 0;
    let maxAtribute = [30, 26, 24, 20, 16][grauInvocacao];

    for (let i = 1; i <= 6; i++) {
        let el = document.getElementById(`a${i}`);
        let val = Number(el.value);
        if (val > maxAtribute) { val = maxAtribute; el.value = maxAtribute; }
        let mod = getAtributeModifier(val);
        document.getElementById(`m${i}`).innerText = `${mod < 0 ? "" : "+"}${mod}`;
        usedPoints += val - 8;
    }

    const constAtribute = document.getElementById('a3').value;
    const destAtribute = document.getElementById('a2').value;
    const destModifier = getAtributeModifier(destAtribute);
    const periciaModifier = getAtributeModifier(document.getElementById(`a${document.getElementById('seletorAtributoPericia').value}`).value);
    const maestriaInvocador = Math.ceil(1 + nivelInvocador / 4);
    
    let stats = { pv: 0, ca: 0, des: 0, cd: 0 };

    document.querySelectorAll('.habInvocador:checked').forEach(hab => {
        switch (hab.name) {
            case "moveis": stats.des += 1.5 + 1.5 * Math.floor(nivelInvocador / 5); break;
            case "resistentes": stats.pv += maestriaInvocador * 5; break;
            case "mobilidade": stats.des += 3 + 1.5 * Math.min(4, Math.floor(nivelInvocador / 4)); break;
            case "resistencia": stats.ca += 2 + Math.min(Math.floor(nivelInvocador / 8), 1) + Math.min(Math.floor(nivelInvocador / 18), 2); break;
            case "supremo": stats.pv += maestriaInvocador * 5; stats.ca += maestriaInvocador * 2; stats.des += 4.5; break;
            case "concentrar": stats.pv += [10, 15, 30, 50].slice(0, Math.floor(nivelInvocador / 6) + 1).reduce((a,b)=>a+b,0); stats.ca += [2, 2, 4, 6].slice(0, Math.floor(nivelInvocador / 6) + 1).reduce((a,b)=>a+b,0); break;
            case "precisao": stats.cd += 2+(nivelInvocador>=8?+1:+0)+(nivelInvocador>=18?+2:+0); break;
        }
    });

    const pts = maxPoints - usedPoints;
    const elPts = document.getElementById('pointView');
    elPts.innerText = pts;
    elPts.style.color = pts < 0 ? '#ff4444' : 'var(--energy)';

    document.getElementById('pvValue').innerText = Math.round((5 + 5 * multiplicadorInvocacao + constAtribute * (grauInvocacao - 6) * -1) / 5) * 5 + stats.pv;
    document.getElementById('dValue').innerText = `${6 + (destModifier * 1.5) + stats.des}m`;
    document.getElementById('caValue').innerText = 10 + Math.floor(destAtribute / 2) + (grauInvocacao - 5) * -1 + stats.ca;
    
    document.getElementById('pmValue').innerText = periciaModifier + maestriaInvocador + Math.floor(nivelInvocador / 2);
    document.getElementById('pdValue').innerText = periciaModifier + Math.floor(nivelInvocador / 2);
    document.getElementById('cdValue').innerText = 10 + Math.floor(nivelInvocador / 2) + periciaModifier + (grauInvocacao - 5) * -1 + stats.cd;
};

function getAtributeModifier(val) {
    return val >= 10 ? Math.floor((val - 10) / 2) : Math.ceil((val - 10) / 2);
}
</script>
</body>
</html>
