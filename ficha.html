<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Ficha RPG</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root { --bg: #0f0f0f; --card: #141414; --primary: #e63946; --energy: #58E8DA; --vigor: #69E858; --integridade: #D073FA; --apice: #f4d35e; --corpo: #9d4edd; --text: #f1f1f1; --dim: #888; --inv-bg: #1e1e1e; --inv-hover: #2a2a2a; --table-head: #2a1a35; }
  body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; padding: 20px; margin: 0; }
  
  /* LAYOUT */
  .main-layout { display: grid; grid-template-columns: 280px 1fr 300px; gap: 20px; max-width: 1600px; margin: 0 auto; padding-bottom: 80px; }
  @media (max-width: 1200px) { .main-layout { grid-template-columns: 280px 1fr; } }
  @media (max-width: 900px) { .main-layout { grid-template-columns: 1fr; } }
  .col-side, .col-center, .col-right { display: flex; flex-direction: column; gap: 20px; }
  .card { background: var(--card); padding: 20px; border-radius: 10px; border: 1px solid #2a2a2a; position: relative; }

  /* HEADER */
  .char-header { text-align: center; }
  .char-img { width: 140px; height: 140px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); margin-bottom: 10px; }
  .char-name { font-size: 1.5rem; margin: 0; color: white; text-transform: uppercase; letter-spacing: 1px; }
  .badges { display: flex; justify-content: center; gap: 5px; flex-wrap: wrap; margin-top: 8px; }
  .badge { font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; background: #222; border: 1px solid #444; color: #ccc; }
  .b-lvl { color: white; border-color: white; font-weight: bold; }
  .b-cls { color: var(--primary); border-color: var(--primary); cursor: pointer; }
  .transf-container { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; }
  .transf-btn { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #444; background: #222; color: #555; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
  .transf-btn.locked { opacity: 0.5; cursor: not-allowed; }
  .transf-btn.unlocked { border-color: #fff; color: #fff; box-shadow: 0 0 5px rgba(255,255,255,0.2); }
  .transf-btn.apice.active { background: var(--apice); color: #000; box-shadow: 0 0 15px var(--apice); }
  .transf-btn.corpo.active { background: var(--corpo); color: #fff; box-shadow: 0 0 15px var(--corpo); }
  .soul-badge { cursor: help; transition: 0.3s; font-weight: bold; border: 1px solid; }
  .soul-stable { border-color: var(--integridade); color: var(--integridade); }
  .soul-damaged { border-color: #f4d35e; color: #f4d35e; }
  .soul-unstable { border-color: #fb8500; color: #fb8500; border-width: 2px; }
  .soul-critical { border-color: #d00000; color: #d00000; border-width: 2px; background: rgba(255,0,0,0.1); }
  .soul-dead { border-color: #555; color: #555; text-decoration: line-through; } 
  .sequela-tag { display: block; background: #300; color: #f55; border: 1px solid #f00; padding: 5px; font-size: 0.8rem; border-radius: 4px; margin-top: 5px; text-align: center; }

  /* ATRIBUTOS */
  .attr-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .attr-box { background: #222; padding: 8px; border-radius: 6px; text-align: center; border: 1px solid #333; }
  .attr-lbl { font-size: 0.7rem; color: var(--dim); display: block; font-weight: bold; }
  .attr-val { font-size: 1.4rem; font-weight: bold; display: block; margin: 2px 0; color: var(--text); }
  .attr-raw { font-size: 0.8rem; color: #777; background: #111; padding: 2px 6px; border-radius: 3px; }

  /* BARRAS */
  .stat-row { margin-bottom: 12px; }
  .stat-head { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 4px; color: #ddd; font-weight: bold; }
  .bar-bg { background: #333; height: 10px; border-radius: 5px; overflow: hidden; }
  .bar-fill { height: 100%; transition: width 0.3s; }
  .stat-ctrl { display: flex; justify-content: flex-end; gap: 5px; margin-top: 4px; }
  .btn-mini { background: #222; border: 1px solid #444; color: #ccc; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
  .btn-calc { background: #222; border: 1px solid #555; color: #ccc; width: 50px; height: 30px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-right: auto; }

  /* COMBATE & DERIVADOS */
  .section-header { background: #111; color: var(--primary); padding: 8px; text-align: center; border: 1px solid #333; border-radius: 5px; margin: 0 0 10px 0; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; }
  .combat-grid { display: grid; gap: 10px; margin-bottom: 20px; } .cols-3 { grid-template-columns: repeat(3, 1fr); } .cols-5 { grid-template-columns: repeat(5, 1fr); }
  .combat-card { background: #1a1a1a; border: 1px solid var(--primary); border-radius: 6px; display: flex; flex-direction: column; overflow: hidden; text-align: center; }
  .cc-header { background: var(--primary); color: white; padding: 5px; font-size: 0.75rem; font-weight: bold; }
  .cc-body { padding: 10px 0; font-size: 1.8rem; font-weight: bold; color: white; flex-grow: 1; background: #1a1a1a; }
  .cc-footer { background: #000; padding: 5px; display: flex; justify-content: center; align-items: center; gap: 5px; border-top: 1px solid #333; }
  .btn-toggle-attr { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.5); color: white; font-size: 0.6rem; padding: 1px 4px; border-radius: 3px; cursor: pointer; margin-top: 2px; }
  .bonus-input { background: #222; border: 1px solid #444; color: #aaa; width: 30px; text-align: center; padding: 2px; border-radius: 4px; font-size: 0.8rem; }
  .btn-train { width: 20px; height: 20px; border: 1px solid #444; background: #222; color: #666; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; border-radius: 3px; cursor: pointer; font-weight: bold; }
  .btn-train.active { background: var(--energy); border-color: var(--energy); color: #000; }
  
  .derived-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .derived-box { background: #1a1a1a; border: 1px solid #333; border-radius: 6px; padding: 10px; text-align: center; }
  .derived-label { font-size: 0.7rem; color: var(--energy); font-weight: bold; text-transform: uppercase; margin-bottom: 5px; }
  .derived-value { font-size: 1.6rem; font-weight: bold; color: #fff; }
  .derived-calc input { background: #111; border: 1px solid #444; color: #aaa; width: 40px; text-align: center; border-radius: 3px; font-size: 0.8rem; margin-top: 5px; }

  /* INVENT√ÅRIO */
  .inv-header-controls { display: flex; gap: 10px; margin-bottom: 10px; }
  .inv-search { flex-grow: 1; background: #000; border: 1px solid #333; color: white; padding: 8px; border-radius: 4px; outline: none; }
  .btn-add-inv { background: var(--primary); color: white; border: none; width: 35px; height: 35px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }
  .inv-list { display: flex; flex-direction: column; gap: 5px; }
  .inv-row { background: var(--inv-bg); border-radius: 4px; overflow: hidden; border: 1px solid #333; transition: 0.2s; }
  .inv-row:hover { border-color: #555; }
  .inv-summary { padding: 10px; display: flex; align-items: center; cursor: pointer; justify-content: space-between; }
  .inv-name { font-weight: bold; color: white; font-size: 0.95rem; }
  .inv-mini-stats { font-size: 0.75rem; color: #999; display: flex; gap: 10px; }
  .inv-mini-stats span b { color: var(--primary); }
  .inv-details { display: none; padding: 15px; background: #151515; border-top: 1px solid #333; grid-template-columns: 1fr 80px; gap: 15px; }
  .inv-row.expanded .inv-details { display: grid; }
  .inv-stat-block { display: flex; flex-direction: column; gap: 4px; font-size: 0.85rem; color: #ccc; }
  .inv-stat-line { display: flex; justify-content: space-between; border-bottom: 1px solid #222; padding-bottom: 2px; }
  .inv-img-preview { width: 80px; height: 80px; object-fit: cover; border: 1px solid #444; background: #000; border-radius: 4px; }
  .inv-actions { grid-column: span 2; display: flex; justify-content: space-between; margin-top: 10px; border-top: 1px solid #333; padding-top: 10px; }
  .inv-categories { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 10px; scrollbar-width: none; }
  .inv-cat-btn { background: #111; border: 1px solid #333; color: #888; padding: 4px 10px; border-radius: 15px; cursor: pointer; font-size: 0.8rem; white-space: nowrap; }
  .inv-cat-btn.active { border-color: var(--primary); color: var(--primary); background: rgba(230, 57, 70, 0.1); }

  /* UTILS GERAIS */
  .editable { cursor: pointer; border-bottom: 1px dashed #555; display: inline-block; min-width: 20px; text-align: center; }
  .btn-txt-del { color: #d00000; background: transparent; border: none; cursor: pointer; font-size: 0.8rem; }
  .btn-txt-edit { color: #ccc; background: transparent; border: none; cursor: pointer; font-size: 0.8rem; }
  
  /* HABILIDADES / APTID√ïES */
  .toggle-body { display: none; } .toggle-body.open { display: block; }
  .aptidao-box, .class-ability-box { margin-bottom: 10px; border: 1px solid #333; border-radius: 6px; overflow: hidden; }
  .aptidao-header { background: #222; padding: 10px; font-weight: bold; color: var(--energy); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
  .aptidao-body { display: none; padding: 10px; background: #151515; }
  .aptidao-body.open { display: block; }
  .aptidao-desc, .class-ability-desc { font-size: 0.85rem; color: #aaa; margin-top: 5px; white-space: pre-wrap; line-height: 1.4; }
  .class-ability-box { border-left: 4px solid var(--vigor); padding: 10px; background: #151515; }
  .ability-select-btn { background: #1a1a1a; color: #aaa; border: 2px dashed #444; width: 100%; padding: 12px; font-weight: bold; cursor: pointer; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .ability-card-display { background: #151515; border-left: 4px solid var(--primary); border-radius: 4px; padding: 15px; margin-bottom: 10px; position: relative; }
  .btn-remove-ability { position: absolute; top: 5px; right: 5px; background: transparent; border: none; color: #666; cursor: pointer; }
  .btn-remove-ability:hover { color: #d00000; }

  /* MODALS */
  .fab-config { position: fixed; bottom: 20px; right: 20px; background: #222; color: white; border: 2px solid #555; width: 50px; height: 50px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.6); z-index: 100; }
  .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; padding: 20px; overflow-y: auto; }
  .modal-content { background: var(--card); padding: 20px; border-radius: 10px; max-width: 600px; margin: 20px auto; border: 1px solid #444; }
  .form-group { margin-bottom: 15px; }
  input, textarea, select { width: 100%; background: #000; border: 1px solid #333; color: white; padding: 8px; border-radius: 4px; outline: none; }
  .sel-option { background: #111; padding: 10px; border-bottom: 1px solid #333; cursor: pointer; }
  .sel-option:hover { background: #1a1a1a; border-left: 3px solid var(--primary); }
  
  /* PERICIAS */
  .skills-card { padding: 0; overflow: hidden; height: 100%; }
  .skill-row { display: flex; align-items: center; padding: 4px 10px; border-bottom: 1px solid #222; font-size: 0.8rem; }
  .sk-name { flex-grow: 1; color: #999; font-weight: 500; }
  .sk-total { font-weight: bold; color: white; width: 30px; text-align: right; margin-right: 10px; font-size: 0.9rem; }
</style>
</head>
<body>

<div class="main-layout">
  <div class="col-side">
    <div class="card char-header">
      <div class="transf-container">
        <div id="btnApice" class="transf-btn apice locked" title="√Åpice Humano" onclick="toggleTransformacao('apice')">‚ö°</div>
        <div id="btnCorpo" class="transf-btn corpo locked" title="Corpo Amaldi√ßoado" onclick="toggleTransformacao('corpo')">üëπ</div>
      </div>
      <div id="statusSequela"></div>
      <img id="charImg" class="char-img" src="">
      <h2 class="char-name"><span class="editable" id="nomeDisplay" onclick="editarCampo(this, 'nome', 'text')">...</span></h2>
      <div id="badges" class="badges"></div>
      <div id="shikiTokens" class="shiki-container"></div>
    </div>
    <div class="card"><div id="atributosArea" class="attr-grid"></div><p style="text-align:center;font-size:0.7rem;color:#666;margin:0;">Clique para editar</p></div>
    <div class="card"><div id="statsArea"></div></div>
    <button class="btn-nav" onclick="window.location='index.html'" style="width:100%; padding:10px; cursor:pointer; background:transparent; border:1px solid #444; color:#aaa; border-radius:5px;">Voltar para Lista</button>
  </div>

  <div class="col-center">
    <div class="card" style="padding:10px;">
      <h3 class="section-header">Jogadas de Ataque</h3>
      <div id="combatAttacksArea" class="combat-grid cols-3"></div>
      <h3 class="section-header" style="margin-top:20px;">Testes de Resist√™ncia</h3>
      <div id="combatResistArea" class="combat-grid cols-5"></div>
    </div>

    <div class="card">
      <h3 class="section-header" style="margin-bottom:10px;" onclick="document.getElementById('classOriginBody').classList.toggle('open')">
        Habilidades de Classe & Origem ‚ñº
      </h3>
      <div id="classOriginBody" class="toggle-body">
        <div id="classAbilitiesList"></div>
        <hr style="border-color:#222; margin:15px 0;">
        <h4 style="margin:0 0 10px 0; color:var(--vigor); font-size:0.9rem;">Origem e Especializa√ß√µes</h4>
        <div id="originAbilitiesList"></div>
        <button class="btn-add-origin" onclick="abrirModalOrigem()" style="width:100%; padding:5px; background:transparent; border:1px dashed #555; color:#888; cursor:pointer;">+ Adicionar</button>
      </div>
    </div>
    
    <div style="text-align:right; margin-bottom:5px;">
       <button class="btn-mini" onclick="abrirClassManager()" style="font-size:0.8rem; width:auto; padding:0 8px;">Gerenciar Classes</button>
    </div>

    <div class="card">
      <div class="section-header" style="display:flex; justify-content:space-between;">
        <span style="flex-grow:1; text-align:center;">Invent√°rio</span>
        <button class="btn-add-inv" onclick="abrirItemModal()">+</button>
      </div>
      <div class="inv-header-controls">
        <input type="text" id="invSearch" class="inv-search" placeholder="Filtrar..." onkeyup="renderInventario()">
      </div>
      <div class="inv-load-display">CARGA <span id="loadVal" class="load-num">0</span> / <span id="loadMax" class="load-num">20</span></div>
      <div class="load-bar-container"><div id="loadFill" class="load-fill"></div></div>
      <div id="overburdenMsg" class="overburden-warning">‚ö† SOBRECARREGADO</div>
      
      <div class="inv-categories">
        <button class="inv-cat-btn active" onclick="filtrarInv('todos', this)">Todos</button>
        <button class="inv-cat-btn" onclick="filtrarInv('Arma', this)">Arma</button>
        <button class="inv-cat-btn" onclick="filtrarInv('Prote√ß√£o', this)">Prote√ß√£o</button>
        <button class="inv-cat-btn" onclick="filtrarInv('Muni√ß√£o', this)">Muni√ß√£o</button>
        <button class="inv-cat-btn" onclick="filtrarInv('Geral', this)">Geral</button>
        <button class="inv-cat-btn" onclick="filtrarInv('Item Amald.', this)">Item Amald.</button>
      </div>
      <div id="inventoryList" class="inv-list"></div>
    </div>
    
    <div class="card" id="aptidoesCard">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h3 class="section-header" style="width:100%; margin:0;">Aptid√µes & Evolu√ß√£o</h3>
        <div id="gmControlsMain" style="display:none; gap:5px;">
          <button class="btn-mini" style="width:auto; padding:0 8px; font-size:0.7rem; border-color:var(--apice); color:var(--apice);" onclick="gmUnlock('apice')">APICE</button>
          <button class="btn-mini" style="width:auto; padding:0 8px; font-size:0.7rem; border-color:var(--corpo); color:var(--corpo);" onclick="gmUnlock('corpo')">CORPO</button>
          <button class="btn-mini" style="width:auto; padding:0 8px; font-size:0.7rem; border-color:#0f0; color:#0f0;" onclick="gmClearDebuff()">CURAR</button>
          <button class="btn-mini" style="width:auto; padding:0 8px;" onclick="addNovaAptidao()">+</button>
        </div>
      </div>
      <div id="listaAptidoes"></div>
    </div>
  </div>

  <div class="col-right">
    <div class="card">
      <h3 class="section-header" style="margin-bottom:10px;">Valores Adicionais</h3>
      <div class="derived-grid">
        <div class="derived-box"><div class="derived-label">DEFESA</div><div class="derived-value" id="valDefesa">10</div><div class="derived-calc"><input id="bonusDef" class="derived-calc input" placeholder="B√¥nus" onchange="setDerivadoBonus('defesa', this.value)"></div></div>
        <div class="derived-box"><div class="derived-label">ATEN√á√ÉO</div><div class="derived-value" id="valAtencao">10</div><div class="derived-calc"><input id="bonusAtencao" class="derived-calc input" placeholder="B√¥nus" onchange="setDerivadoBonus('atencao', this.value)"></div></div>
        <div class="derived-box"><div class="derived-label">INICIATIVA</div><div class="derived-value" id="valIniciativa">+0</div><div class="derived-calc"><input id="bonusIniciativa" class="derived-calc input" placeholder="B√¥nus" onchange="setDerivadoBonus('iniciativa', this.value)"></div></div>
        <div class="derived-box"><div class="derived-label">DESLOC.</div><div class="derived-value" id="valDesloc">9m</div><div class="derived-calc"><input id="bonusDesloc" class="derived-calc input" placeholder="B√¥nus" onchange="setDerivadoBonus('deslocamento', this.value)"></div></div>
      </div>
    </div>

    <div class="card skills-card">
      <div class="skills-header" style="padding-top:0;">
        <h3 style="margin-bottom:5px;">Per√≠cias</h3>
      </div>
      <div id="skillsList"></div>
    </div>
  </div>
</div>

<button class="fab-config" onclick="abrirConfig()">‚öôÔ∏è</button>

<div id="configModal" class="modal"><div class="modal-content"><h2 style="color:var(--primary);">Configura√ß√µes</h2><label>Imagem (URL)</label><input id="editImgUrl" style="margin-bottom:15px;"><button onclick="salvarImg()" style="background:#333; color:white; border:none; padding:5px; width:100%;">Atualizar Imagem</button><br><br><button onclick="document.getElementById('configModal').style.display='none'" style="background:#333; width:100%; padding:10px; color:white; border:none; cursor:pointer;">Fechar</button><button onclick="excluirPersonagem()" style="background:transparent; color:#d00000; border:none; width:100%; margin-top:15px; cursor:pointer;">Excluir Personagem</button></div></div>

<div id="selectionModal" class="modal"><div class="modal-content"><h2 id="selectTitle" style="color:var(--primary);">Escolha</h2><div id="selectorFilters" style="margin-bottom:10px; display:flex; gap:5px; flex-wrap:wrap;"></div><div id="selectOptionsList" style="display:flex; flex-direction:column; gap:5px; max-height:60vh; overflow-y:auto;"></div><button onclick="document.getElementById('selectionModal').style.display='none'" style="background:#333; width:100%; padding:10px; color:white; border:none; cursor:pointer; margin-top:15px;">Cancelar</button></div></div>

<div id="itemModal" class="modal">
  <div class="modal-content">
    <h2 id="itemModalTitle" style="color:var(--primary);">Novo Item</h2>
    <button onclick="abrirSeletor('item')" style="width:100%; background:#222; border:1px dashed var(--energy); color:var(--energy); padding:10px; margin-bottom:15px; cursor:pointer; font-weight:bold;">üìö Selecionar Item Pronto</button>

    <div style="display:grid; grid-template-columns: 2fr 1fr; gap:10px;">
      <div class="form-group"><label>Nome</label><input id="itNome"></div>
      <div class="form-group"><label>Tipo</label>
        <select id="itTipo">
          <option value="Arma">Arma</option>
          <option value="Prote√ß√£o">Prote√ß√£o</option>
          <option value="Muni√ß√£o">Muni√ß√£o</option>
          <option value="Geral">Geral</option>
          <option value="Item Amald.">Item Amald.</option>
        </select>
      </div>
    </div>
    
    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
      <div class="form-group"><label>Grau</label><select id="itGrau"><option value="4">Grau 4</option><option value="3">Grau 3</option><option value="2">Grau 2</option><option value="1">Grau 1</option><option value="0">Especial</option></select></div>
      <div class="form-group"><label>Espa√ßos</label><input type="number" id="itEspacos" value="1"></div>
      <div class="form-group"><label>B√¥nus</label><input id="itBonus" placeholder="+2 CA"></div>
    </div>

    <div class="form-group" style="border:1px solid #333; padding:10px; border-radius:4px; background:#111;">
      <label style="color:var(--primary);">Status de Combate (Opcional)</label>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:5px;">
         <input id="itDano" placeholder="Dano (ex: 1d12)">
         <input id="itCritico" placeholder="Cr√≠tico (ex: x3)">
      </div>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:5px;">
         <input id="itAlcance" placeholder="Alcance">
         <input id="itTipoDano" placeholder="Tipo de Dano">
      </div>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
         <select id="itTipoAtaque">
             <option value="">-- Tipo de Ataque --</option>
             <option value="Corpo a Corpo">Corpo a Corpo</option>
             <option value="Dist√¢ncia">Dist√¢ncia</option>
             <option value="Amaldi√ßoado">Amaldi√ßoado</option>
         </select>
         <input id="itAtributo" placeholder="Atributo (For√ßa)">
      </div>
      <div class="form-group" style="margin-top:5px;">
        <label>Ataque B√¥nus</label><input type="number" id="itAtkBonus" placeholder="0">
      </div>
    </div>

    <div class="form-group"><label>Imagem (URL)</label><input id="itImg" placeholder="http://..."></div>
    <div class="form-group"><label>Descri√ß√£o Geral</label><textarea id="itDesc" style="height:60px;"></textarea></div>
    
    <div class="list-adder">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <label>Propriedades</label>
        <button class="btn-mini" onclick="abrirSeletor('propriedade')" style="width:auto; padding:2px 8px;">üìö Escolher</button>
      </div>
      <div id="propList"></div>
      <button class="btn-add-item" onclick="addPropField()">+ Manual</button>
    </div>

    <div class="list-adder">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <label>Encantamentos</label>
        <button class="btn-mini" onclick="abrirSeletor('encantamento')" style="width:auto; padding:2px 8px;">üìö Escolher</button>
      </div>
      <div id="encantList"></div>
      <button class="btn-add-item" onclick="addEncantField()">+ Manual</button>
    </div>

    <div style="display:flex; gap:10px; margin-top:20px;">
      <button onclick="salvarItem()" style="background:var(--primary); flex-grow:1; padding:10px; border:none; color:white; cursor:pointer;">Salvar Item</button>
      <button onclick="excluirItem()" id="btnExcluirItem" style="background:transparent; border:1px solid #d00000; color:#d00000; padding:10px; cursor:pointer; display:none;">Excluir</button>
    </div>
    <button onclick="document.getElementById('itemModal').style.display='none'" style="background:#333; width:100%; padding:10px; margin-top:5px; border:none; color:white; cursor:pointer;">Cancelar</button>
  </div>
</div>

<div id="aptidaoEditorModal" class="modal"><div class="modal-content"><h2 style="color:var(--energy);">Editor de Aptid√£o</h2><div class="form-group"><label>Nome da Aptid√£o</label><input id="editAptNome"></div><div class="form-group"><label>Descri√ß√£o Geral</label><textarea id="editAptDesc" style="height:80px;"></textarea></div><div class="form-group"><label>N√≠vel M√°ximo (0 = Passiva)</label><input type="number" id="editAptMax" min="0" max="20" onchange="renderLevelInputs()"></div><div id="editAptLevelsContainer" style="margin-top:10px; display:flex; flex-direction:column; gap:5px;"></div><div style="display:flex; gap:10px; margin-top:20px;"><button onclick="salvarAptidaoCustom()" style="background:var(--energy); flex-grow:1; padding:10px; border:none; color:#000; cursor:pointer; font-weight:bold;">Salvar</button><button onclick="excluirAptidaoCustom()" id="btnExcluirApt" style="background:transparent; border:1px solid #d00000; color:#d00000; padding:10px; cursor:pointer;">Excluir</button></div><button onclick="document.getElementById('aptidaoEditorModal').style.display='none'" style="background:#333; width:100%; padding:10px; margin-top:5px; border:none; color:white; cursor:pointer;">Cancelar</button></div></div>
<div id="origemModal" class="modal"><div class="modal-content"><h2 id="origemModalTitle" style="color:var(--vigor);">Nova Habilidade de Origem</h2><div class="form-group"><label>Nome</label><input id="origemNome"></div><div class="form-group"><label>Descri√ß√£o</label><textarea id="origemDesc" style="height:150px;"></textarea></div><div style="display:flex; gap:10px; margin-top:20px;"><button onclick="salvarOrigem()" style="background:var(--vigor); flex-grow:1; padding:10px; border:none; color:#000; cursor:pointer; font-weight:bold;">Salvar</button></div><button onclick="document.getElementById('origemModal').style.display='none'" style="background:#333; width:100%; padding:10px; margin-top:5px; border:none; color:white; cursor:pointer;">Cancelar</button></div></div>
<div id="classManagerModal" class="modal"><div class="modal-content"><h2 style="color:var(--primary);">Gerenciar Classes</h2><div id="currentClassesList" style="margin-bottom:20px;"></div><div style="border-top:1px solid #333; padding-top:10px;"><label>Adicionar Nova Classe</label><div style="display:flex; gap:10px;"><select id="newClassSelect" style="flex-grow:1;"></select><button onclick="adicionarClasse()" style="background:var(--primary); border:none; color:white; padding:5px 10px; cursor:pointer;">Adicionar</button></div></div><button onclick="document.getElementById('classManagerModal').style.display='none'" style="background:#333; width:100%; padding:10px; margin-top:15px; border:none; color:white; cursor:pointer;">Fechar</button></div></div>

<script type="module">
import { db, auth, doc, updateDoc, deleteDoc, onSnapshot, collection } from "./firebase.js";

// --- BANCOS DE DADOS ---
// (Coloquei aqui para evitar erros de importa√ß√£o. Pode mover para arquivos .js se preferir)
const APTIDOES_BASE = [
  { nome: "Libera√ß√£o de Energia", descricao: "Voc√™ aprende o b√°sico do uso de Energia...", maxNivel: 10, niveis: ["NV 1 - Limite +1..."] },
  { nome: "Prote√ß√£o", descricao: "Aura defensiva.", maxNivel: 8, niveis: ["NV 1 - +1 RD..."] },
  { nome: "√Åpice Humano", descricao: "Corpo no limite f√≠sico.", maxNivel: 1, niveis: ["Desbloqueado"] },
  { nome: "Corpo Amaldi√ßoado", descricao: "Corpo de energia pura.", maxNivel: 1, niveis: ["Desbloqueado"] }
  // ... Adicione as outras do chat anterior se precisar
];

const HABILIDADES_CLASSE = {
  "Lutador": [
    { nivel: 1, nome: "Empolga√ß√£o", desc: "Ganha n√≠veis de empolga√ß√£o..." },
    { nivel: 1, nome: "Manobras", tipo: "selecao_multipla", qtd: 2, opcoes: ["Ajuste", "Comando", "Desarme"] }
  ],
  "Especialista em Combate": [
     { nivel: 1, nome: "Estilo", tipo: "selecao_unica", opcoes: ["Defensivo", "Duelista"] }
  ]
  // ... Adicione as outras classes do chat anterior
};

const ITENS_ESPECIAIS = [
  { custo: 1, nome: "Ant√≠doto Simples", tipo: "Item", grau: "4", desc: "[F√°rmaco] Cura veneno leve." },
  { custo: 2, nome: "Amuleto do Vislumbre", tipo: "Item", grau: "3", desc: "[Acess√≥rio] Vis√£o no escuro." }
];

const PROPRIEDADES_GERAIS = [{ nome: "Ampla", desc: "Afeta adjacente." }];
const ENCANTAMENTOS_ARMAS = [{ nome: "Afiada", desc: "Fatal." }];
const ENCANTAMENTOS_ESCUDOS = [];
const ENCANTAMENTOS_UNIFORMES = [];
const PROPRIEDADES_ESPECIAIS = [];

const params = new URLSearchParams(location.search);
const id = params.get("id");
window.id = id;
let ficha = {}; 
let editandoId = null;
let editingItemIndex = -1;
let editingAptIndex = -1;
let editingOriginIndex = -1;
const MESTRE_EMAIL = "grisskos@fake.com";
let isMestre = false;
let currentInvFilter = "todos";

const PERICIAS_DEF = [
  { n: "Atletismo", a: "forca" }, { n: "Acrobacia", a: "destreza" }, { n: "Furtividade", a: "destreza" },
  { n: "Prestidigita√ß√£o", a: "destreza" }, { n: "Feiti√ßaria", a: "inteligencia" }, { n: "Hist√≥ria", a: "inteligencia" },
  { n: "Investiga√ß√£o", a: "inteligencia" }, { n: "Of√≠cio 1", a: "inteligencia" }, { n: "Tecnologia", a: "inteligencia" },
  { n: "Teologia", a: "inteligencia" }, { n: "Dire√ß√£o", a: "sabedoria" }, { n: "Intui√ß√£o", a: "sabedoria" },
  { n: "Medicina", a: "sabedoria" }, { n: "Ocultismo", a: "sabedoria" }, { n: "Percep√ß√£o", a: "sabedoria" },
  { n: "Sobreviv√™ncia", a: "sabedoria" }, { n: "Engana√ß√£o", a: "presenca" }, { n: "Intimida√ß√£o", a: "presenca" },
  { n: "Performance", a: "presenca" }, { n: "Persuas√£o", a: "presenca" }
];
const ATR_SHORT = { forca:"FOR", destreza:"DES", constituicao:"CON", inteligencia:"INT", sabedoria:"SAB", presenca:"PRE" };

auth.onAuthStateChanged(user => {
  if(user && user.email === MESTRE_EMAIL) {
    isMestre = true;
    const el = document.getElementById('gmControlsMain');
    if(el) el.style.display = 'flex';
  }
});

onSnapshot(doc(db, "fichas", id), (docSnap) => {
  if (docSnap.exists()) { 
    ficha = docSnap.data();
    // Init Defaults
    if (!ficha.classes) ficha.classes = [{ nome: ficha.classe || "Lutador", nivel: Number(ficha.nivel || 1) }];
    if (!ficha.atributos) ficha.atributos = { forca:10, destreza:10, constituicao:10, inteligencia:10, sabedoria:10, presenca:10 };
    if (!ficha.pericias) ficha.pericias = {};
    if (!ficha.vida) ficha.vida = { atual: 10, max: 10 };
    if (!ficha.energia) ficha.energia = { atual: 10, max: 10 };
    if (!ficha.vigor) ficha.vigor = { atual: 5, max: 5 };
    if (!ficha.integridade) ficha.integridade = { atual: 100, max: 100 };
    if (!ficha.combate) ficha.combate = {}; 
    if (!ficha.inventario) ficha.inventario = []; 
    if (!ficha.progressoAptidoes) ficha.progressoAptidoes = {};
    if (!ficha.transfUnlocked) ficha.transfUnlocked = { apice: false, corpo: false };
    if (!ficha.transfActive) ficha.transfActive = null; 
    if (!ficha.sequelas) ficha.sequelas = { exaustao: false, corrupcao: false };
    if (!ficha.aptidoesCustom) ficha.aptidoesCustom = [];
    if (!ficha.derivados) ficha.derivados = { defesa:0, atencao:0, iniciativa:0, deslocamento:0 };
    if (!ficha.escolhasClasse) ficha.escolhasClasse = {};
    if (!ficha.habilidadesOrigem) ficha.habilidadesOrigem = [];
    
    if(!editandoId) renderFicha(); 
  }
});

onSnapshot(collection(db, "fichas", id, "shikigamis"), (snap) => {
  const shikiArea = document.getElementById('shikiTokens');
  if(shikiArea) {
    shikiArea.innerHTML = "";
    let count = 0;
    snap.forEach(docShiki => {
      const s = docShiki.data();
      const imgUrl = s.imagem || `https://via.placeholder.com/40/222/58E8DA?text=${(s.nome||'?').charAt(0)}`;
      shikiArea.innerHTML += `<img src="${imgUrl}" class="shiki-token" title="${s.nome}" onclick="irParaShikigamis()">`;
      count++;
    });
    if(count < 20) shikiArea.innerHTML += `<div class="shiki-add" onclick="irParaShikigamis()" title="Nova Invoca√ß√£o">+</div>`;
  }
});

function renderFicha() {
  const f = ficha;
  const totalLevel = f.classes.reduce((acc, c) => acc + Number(c.nivel), 0);
  
  const nomeEl = document.getElementById('nomeDisplay');
  if(nomeEl && !nomeEl.querySelector('input')) nomeEl.innerText = f.nome || "Sem Nome";
  document.getElementById('charImg').src = f.imagem || "";
  const classBadgeText = f.classes.map(c => `${c.nome} ${c.nivel}`).join(" / ");
  document.getElementById('badges').innerHTML = `<span class="badge b-lvl">NVL ${totalLevel}</span><span class="badge b-cls" onclick="abrirClassManager()">${classBadgeText || 'Sem Classe'}</span><span class="badge soul-badge" id="soulBadge">Est√°vel</span>`;

  // Soul
  const intPct = f.integridade.max > 0 ? (f.integridade.atual / f.integridade.max) * 100 : 100;
  const soulBadge = document.getElementById('soulBadge');
  let soulClass = "badge soul-stable"; let soulText = "Est√°vel"; let soulTip = "Alma Est√°vel.";
  if(f.integridade.atual <= 0) { soulText = "Morto"; soulClass = "badge soul-dead"; } 
  else if(intPct < 25) { soulText = "Cr√≠tico"; soulClass = "badge soul-critical"; } 
  else if(intPct < 50) { soulText = "Inst√°vel"; soulClass = "badge soul-unstable"; } 
  else if(intPct < 75) { soulText = "Danificado"; soulClass = "badge soul-damaged"; }
  soulBadge.innerText = soulText; soulBadge.className = soulClass; soulBadge.setAttribute("data-tooltip", soulTip);

  // Transf Buttons
  const btnApice = document.getElementById('btnApice');
  const btnCorpo = document.getElementById('btnCorpo');
  const divSequela = document.getElementById('statusSequela');
  btnApice.className = "transf-btn apice locked"; btnCorpo.className = "transf-btn corpo locked"; divSequela.innerHTML = "";
  if(f.transfUnlocked.apice) { btnApice.classList.remove('locked'); btnApice.classList.add('unlocked'); if(f.transfActive === 'apice') btnApice.classList.add('active'); }
  if(f.transfUnlocked.corpo) { btnCorpo.classList.remove('locked'); btnCorpo.classList.add('unlocked'); if(f.transfActive === 'corpo') btnCorpo.classList.add('active'); }
  if(f.sequelas.exaustao) divSequela.innerHTML += `<span class="sequela-tag">‚ö† EXAUST√ÉO</span>`;
  if(f.sequelas.corrupcao) divSequela.innerHTML += `<span class="sequela-tag">‚ò† CORRUP√á√ÉO</span>`;

  const areaAttr = document.getElementById('atributosArea');
  areaAttr.innerHTML = "";
  Object.keys(ATR_SHORT).forEach(key => {
    const val = f.atributos[key] || 10;
    const mod = Math.floor((val - 10) / 2);
    areaAttr.innerHTML += `<div class="attr-box"><span class="attr-lbl">${ATR_SHORT[key]}</span><span class="attr-val">${mod>=0?'+':''}${mod}</span><span class="attr-raw editable" onclick="editarCampo(this, 'atributos.${key}', 'number')">${val}</span></div>`;
  });

  const areaStats = document.getElementById('statsArea');
  areaStats.innerHTML = "";
  const statsMap = [{k:'vida', l:'Vida', color:'var(--primary)'}, {k:'energia', l:'Energia', color:'var(--energy)'}, {k:'vigor', l:'Vigor', color:'var(--vigor)'}, {k:'integridade', l:'Integ.', color:'var(--integridade)'}];
  statsMap.forEach(s => {
    const st = f[s.k] || {atual:0, max:0};
    const pct = st.max > 0 ? Math.min(100, (st.atual/st.max)*100) : 0;
    areaStats.innerHTML += `<div class="stat-row"><div class="stat-head"><span>${s.l}</span><div><span class="editable" onclick="editarCampo(this, '${s.k}.atual', 'number')">${st.atual}</span> / <span class="editable" onclick="editarCampo(this, '${s.k}.max', 'number')">${st.max}</span></div></div><div class="bar-bg"><div class="bar-fill" style="width:${pct}%; background:${s.color}; box-shadow: 0 0 8px ${s.color};"></div></div><div class="stat-ctrl"><div class="btn-calc" onclick="mathStat(this, '${s.k}')">üî¢</div><div class="btn-mini" onclick="upStat('${s.k}', -1)">-</div><div class="btn-mini" onclick="upStat('${s.k}', 1)">+</div></div></div>`;
  });

  renderDerivados(totalLevel);
  renderHabilidadesClasse();
  renderInventario();
  renderAptidoes();
  renderPericias();

  // Combate
  const attacksArea = document.getElementById('combatAttacksArea');
  if(attacksArea) {
      attacksArea.innerHTML = "";
      // ... (Adicione cards de ataque aqui se quiser visual, ou use o padr√£o)
      attacksArea.innerHTML = `<div style="color:#666; font-size:0.8rem; text-align:center;">Configure ataques no banco de dados.</div>`;
  }
}

function renderPericias() {
  const listaSkills = document.getElementById('skillsList');
  listaSkills.innerHTML = "";
  const totalLevel = ficha.classes.reduce((acc, c) => acc + Number(c.nivel), 0);
  const metadeNivel = Math.floor(totalLevel / 2);
  const bonusTreino = 2 + Math.floor(((totalLevel||1)-1)/4);

  PERICIAS_DEF.forEach(p => {
    const attrVal = (ficha.atributos && ficha.atributos[p.a]) ? ficha.atributos[p.a] : 10;
    const modAttr = Math.floor((attrVal - 10) / 2);
    const saved = (ficha.pericias||{})[p.n] || { t: false, m: false, bonus: 0 };
    let total = modAttr + metadeNivel;
    if (saved.t) total += bonusTreino;
    if (saved.m) total += 1;
    total += Number(saved.bonus || 0);
    
    listaSkills.innerHTML += `
      <div class="skill-row">
        <span class="sk-name">${p.n}</span>
        <span class="sk-attr">${ATR_SHORT[p.a]}</span>
        <span class="sk-total">${total>=0?'+':''}${total}</span>
        <div class="sk-btn-group">
           <div class="sk-btn ${saved.t ? 'active-t' : ''}" onclick="togglePericia('${p.n}', 't')">T</div>
           <div class="sk-btn ${saved.m ? 'active-m' : ''}" onclick="togglePericia('${p.n}', 'm')">M</div>
        </div>
      </div>`;
  });
}

// === RENDER INVENT√ÅRIO (ACORDE√ÉO) ===
window.renderInventario = () => {
  const strMod = Math.floor(((ficha.atributos?.forca || 10) - 10) / 2);
  const limit = 8 + (strMod * 2); 
  const currentLoad = (ficha.inventario || []).reduce((acc, item) => acc + (Number(item.espacos)||0), 0);
  document.getElementById('loadVal').innerText = currentLoad;
  document.getElementById('loadMax').innerText = limit;
  document.getElementById('overburdenMsg').style.display = currentLoad > limit ? 'block' : 'none';
  
  const invList = document.getElementById('inventoryList');
  invList.innerHTML = "";
  const termo = document.getElementById('invSearch').value.toLowerCase();
  
  (ficha.inventario || []).forEach((item, idx) => {
    if(currentInvFilter !== 'todos' && item.tipo !== currentInvFilter) return;
    if(termo && !item.nome.toLowerCase().includes(termo)) return;
    const imgUrl = item.imagem || 'https://via.placeholder.com/100?text=Item';
    const isEquipped = item.equipado ? 'equipped' : '';

    invList.innerHTML += `
      <div class="inv-row" id="inv-row-${idx}">
        <div class="inv-summary" onclick="toggleInvRow(${idx})">
          <div class="inv-check ${isEquipped}" onclick="event.stopPropagation(); toggleEquipItem(${idx})">‚úî</div>
          <div class="inv-main-info">
             <div class="inv-name">${item.nome}</div>
             <div class="inv-mini-stats"><span>Dano: <b>${item.dano || '-'}</b></span></div>
          </div>
          <div class="inv-expand-icon">‚ñº</div>
        </div>
        <div class="inv-details">
           <div>
             <div class="inv-stat-block">
               <div class="inv-stat-line"><span class="inv-stat-label">Tipo:</span> <span>${item.tipo || '-'}</span></div>
               <div class="inv-stat-line"><span class="inv-stat-label">Atributo:</span> <span>${item.atributo || '-'}</span></div>
             </div>
             <p style="font-size:0.85rem; color:#aaa; margin-top:10px;">${item.descricao || ''}</p>
           </div>
           <div class="inv-actions">
              <button class="btn-txt-del" onclick="excluirItem(${idx})">Remover</button>
              <button class="btn-txt-edit" onclick="abrirItemModal(${idx})">Editar</button>
           </div>
        </div>
      </div>`;
  });
};

window.filtrarInv = (cat, btn) => { currentInvFilter = cat; document.querySelectorAll('.inv-cat-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); renderInventario(); };
window.toggleInvRow = (idx) => { document.getElementById(`inv-row-${idx}`).classList.toggle('expanded'); };
window.toggleEquipItem = async (idx) => { ficha.inventario[idx].equipado = !ficha.inventario[idx].equipado; await updateDoc(doc(db, "fichas", id), { inventario: ficha.inventario }); renderInventario(); };

window.renderAptidoes = () => {
  const container = document.getElementById('listaAptidoes');
  container.innerHTML = "";
  const todas = [...APTIDOES_BASE, ...(ficha.aptidoesCustom || [])];
  todas.forEach((apt, index) => {
      let nivelAtual = (ficha.progressoAptidoes || {})[apt.nome] || 0;
      if(!isMestre && nivelAtual === 0) return;
      container.innerHTML += `<div class="aptidao-box"><div class="aptidao-header"><span>${apt.nome} (${nivelAtual}/${apt.maxNivel})</span></div><div class="aptidao-body open"><div class="aptidao-desc">${apt.descricao}</div></div></div>`;
  });
};

function renderDerivados(totalLevel) {
  const desMod = Math.floor((ficha.atributos.destreza - 10) / 2);
  const metadeNivel = Math.floor(totalLevel / 2);
  const defBonus = Number(ficha.derivados.defesa || 0);
  document.getElementById('valDefesa').innerText = 10 + desMod + metadeNivel + defBonus;
  document.getElementById('bonusDef').value = ficha.derivados.defesa || "";
  
  const atencaoBonus = Number(ficha.derivados.atencao || 0);
  document.getElementById('valAtencao').innerText = 10 + atencaoBonus;
  document.getElementById('bonusAtencao').value = ficha.derivados.atencao || "";
  
  const iniBonus = Number(ficha.derivados.iniciativa || 0);
  document.getElementById('valIniciativa').innerText = (desMod + iniBonus >= 0 ? '+' : '') + (desMod + iniBonus);
  document.getElementById('bonusIniciativa').value = ficha.derivados.iniciativa || "";
  
  const desBonus = Number(ficha.derivados.deslocamento || 0);
  document.getElementById('valDesloc').innerText = (9 + desBonus) + "m";
  document.getElementById('bonusDesloc').value = ficha.derivados.deslocamento || "";
}

function renderHabilidadesClasse() {
  const container = document.getElementById('classAbilitiesList');
  container.innerHTML = "";
  ficha.classes.forEach((clsObj) => {
    const classeNome = clsObj.nome;
    container.innerHTML += `<h4 style="margin:10px 0 5px 0; color:var(--primary);">${classeNome}</h4>`;
    if(HABILIDADES_CLASSE[classeNome]) {
        HABILIDADES_CLASSE[classeNome].forEach(hab => {
            if(hab.nivel <= clsObj.nivel) {
                container.innerHTML += `<div class="class-ability-box"><div class="class-ability-name">${hab.nome}</div><div class="class-ability-desc">${hab.desc || ''}</div></div>`;
            }
        });
    }
  });
}

// MODALS
window.abrirItemModal = (index = -1) => { editingItemIndex = index; document.getElementById('itemModal').style.display = 'block'; };
window.salvarItem = async () => { const novoItem = { nome: document.getElementById('itNome').value, tipo: document.getElementById('itTipo').value, grau: document.getElementById('itGrau').value, espacos: 1, bonus: document.getElementById('itBonus').value, imagem: document.getElementById('itImg').value, descricao: document.getElementById('itDesc').value }; if(!ficha.inventario) ficha.inventario = []; if(editingItemIndex === -1) ficha.inventario.push(novoItem); else ficha.inventario[editingItemIndex] = novoItem; await updateDoc(doc(db, "fichas", id), { inventario: ficha.inventario }); document.getElementById('itemModal').style.display = 'none'; };
window.excluirItem = async () => { if(editingItemIndex > -1) { ficha.inventario.splice(editingItemIndex, 1); await updateDoc(doc(db, "fichas", id), { inventario: ficha.inventario }); document.getElementById('itemModal').style.display = 'none'; } };
window.abrirSeletor = () => alert("Funcionalidade Simplificada nesta vers√£o."); // Placeholder
window.addPropField = () => {}; window.addEncantField = () => {}; // Placeholders
window.setDerivadoBonus = async (key, val) => { const derivados = ficha.derivados || {}; derivados[key] = Number(val); await updateDoc(doc(db, "fichas", id), { derivados: derivados }); };
window.toggleTransformacao = async (tipo) => { if (!ficha.transfUnlocked[tipo]) return; let novoEstado = (ficha.transfActive === tipo) ? null : tipo; await updateDoc(doc(db, "fichas", id), { transfActive: novoEstado }); };
window.gmUnlock = async (tipo) => { const unlocked = ficha.transfUnlocked || {}; unlocked[tipo] = true; await updateDoc(doc(db, "fichas", id), { transfUnlocked: unlocked }); };
window.gmClearDebuff = async () => { await updateDoc(doc(db, "fichas", id), { sequelas: { exaustao: false, corrupcao: false } }); };
window.setSkillBonus = async (skillName, val) => { const pericias = ficha.pericias || {}; if (!pericias[skillName]) pericias[skillName] = { t: false, m: false, bonus: 0 }; pericias[skillName].bonus = Number(val); await updateDoc(doc(db, "fichas", id), { pericias: pericias }); };
window.setAptidao = async (nomeApt, novoNivel) => { if (!isMestre) return; const progresso = ficha.progressoAptidoes || {}; progresso[nomeApt] = novoNivel; await updateDoc(doc(db, "fichas", id), { progressoAptidoes: progresso }); };
window.addNovaAptidao = async () => { if (!isMestre) return; const nome = prompt("Nome:"); if(nome) { const custom = ficha.aptidoesCustom || []; custom.push({nome, maxNivel:5, descricao:""}); await updateDoc(doc(db, "fichas", id), { aptidoesCustom: custom }); } };
window.abrirClassManager = () => { document.getElementById('classManagerModal').style.display = 'block'; };
window.adicionarClasse = async () => { const nome = document.getElementById('newClassSelect').value; if(nome) { ficha.classes.push({nome, nivel:1}); await updateDoc(doc(db, "fichas", id), {classes:ficha.classes}); renderFicha(); } };
window.togglePericia = async (skillName, tipo) => { const pericias = ficha.pericias || {}; if (!pericias[skillName]) pericias[skillName] = { t: false, m: false }; pericias[skillName][tipo] = !pericias[skillName][tipo]; await updateDoc(doc(db, "fichas", id), { pericias: pericias }); };
window.upStat = async (key, val) => { const st = ficha[key]; const novo = Math.max(0, Math.min(st.max, Number(st.atual)+val)); await updateDoc(doc(db, "fichas", id), { [`${key}.atual`]: novo }); };
window.irParaShikigamis = () => { window.location = `shikigamis.html?charId=${id}`; };
window.irParaFeiticos = () => { window.location = `feiticos.html?id=${id}`; };
window.abrirConfig = () => { document.getElementById('configModal').style.display = 'block'; document.getElementById('editImgUrl').value = ficha.imagem || ""; };
window.salvarImg = async () => { await updateDoc(doc(db, "fichas", id), { imagem: document.getElementById('editImgUrl').value }); };
window.excluirPersonagem = async () => { if(prompt("DELETAR?")==="DELETAR") { await deleteDoc(doc(db, "fichas", id)); window.location="index.html"; } };
window.editarCampo = (el, field, type) => { const val = prompt("Novo valor:", el.innerText); if(val) updateDoc(doc(db, "fichas", id), {[field]: (type==='number'?Number(val):val)}); };
window.mathStat = (el, key) => { const val = prompt("Valor +/-:"); if(val) updateDoc(doc(db, "fichas", id), {[`${key}.atual`]: Math.max(0, Math.min(ficha[key].max, Number(ficha[key].atual)+Number(val)))}); };
</script>
</body>
</html>
