<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Ficha RPG</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root { --bg: #0f0f0f; --card: #141414; --primary: #e63946; --energy: #58E8DA; --vigor: #69E858; --integridade: #D073FA; --text: #f1f1f1; --dim: #888; --apice: #f4d35e; --corpo: #9d4edd; }
  body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; padding: 20px; margin: 0; }
  .main-layout { display: grid; grid-template-columns: 280px 1fr 300px; gap: 20px; max-width: 1600px; margin: 0 auto; padding-bottom: 80px; }
  @media (max-width: 1200px) { .main-layout { grid-template-columns: 280px 1fr; } }
  @media (max-width: 900px) { .main-layout { grid-template-columns: 1fr; } }
  .col-side, .col-center, .col-right { display: flex; flex-direction: column; gap: 20px; }
  .card { background: var(--card); padding: 20px; border-radius: 10px; border: 1px solid #2a2a2a; position: relative; }
  /* ... (Mantenha todo o CSS anterior, incluindo estilos de modal, cards, etc) ... */
  
  /* ESTILO PARA HABILIDADES DE CLASSE */
  .class-ability-box { margin-bottom: 10px; border-left: 3px solid var(--primary); padding-left: 10px; }
  .class-ability-name { font-weight: bold; color: #fff; font-size: 0.95rem; }
  .class-ability-desc { font-size: 0.85rem; color: #aaa; margin-top: 2px; white-space: pre-wrap; }
  .class-select { background: #111; border: 1px solid #444; color: #ccc; padding: 5px; border-radius: 4px; width: 100%; margin-top: 5px; }
  
  /* BOT√ÉO DE ORIGEM */
  .btn-add-origin { width: 100%; border: 1px dashed #555; background: transparent; color: #666; padding: 5px; cursor: pointer; margin-top: 10px; }
  .btn-add-origin:hover { border-color: var(--primary); color: var(--primary); }
</style>
</head>
<body>

<div class="main-layout">
  <div class="col-side">
    <div class="card char-header">
      <div class="transf-container">
        <div id="btnApice" class="transf-btn apice locked" title="√Åpice Humano" onclick="toggleTransformacao('apice')">‚ö°</div>
        <div id="btnCorpo" class="transf-btn corpo locked" title="Corpo Amaldi√ßoado" onclick="toggleTransformacao('corpo')">üëπ</div>
      </div>
      <div id="statusSequela"></div>
      <img id="charImg" class="char-img" src="">
      <h2 class="char-name"><span class="editable" id="nomeDisplay" onclick="editarCampo(this, 'nome', 'text')">...</span></h2>
      <div id="badges" class="badges"></div>
      <div id="shikiTokens" class="shiki-container"></div>
    </div>
    <div class="card"><div id="atributosArea" class="attr-grid"></div><p style="text-align:center;font-size:0.7rem;color:#666;margin:0;">Clique para editar</p></div>
    <div class="card"><div id="statsArea"></div></div>
    <button class="btn-nav btn-summon" onclick="irParaShikigamis()">üê∫ Invoca√ß√µes</button>
    <button class="btn-nav btn-tech" onclick="irParaFeiticos()">‚ö° T√©cnicas & Artes</button>
    <button class="btn-mini" style="width:100%; padding:10px; font-size:1rem; margin-top:10px;" onclick="window.location='index.html'">Voltar para Lista</button>
  </div>

  <div class="col-center">
    <div class="card" style="padding:10px;">
      <h3 class="section-header">Jogadas de Ataque</h3>
      <div id="combatAttacksArea" class="combat-grid cols-3"></div>
      <h3 class="section-header" style="margin-top:20px;">Testes de Resist√™ncia</h3>
      <div id="combatResistArea" class="combat-grid cols-5"></div>
    </div>

    <div class="card">
      <h3 class="section-header">Habilidades de Classe & Origem</h3>
      
      <div id="classAbilitiesList"></div>
      
      <hr style="border-color:#222; margin:15px 0;">
      
      <h4 style="margin:0 0 10px 0; color:var(--vigor); font-size:0.9rem;">Origem</h4>
      <div id="originAbilitiesList"></div>
      <button class="btn-add-origin" onclick="addOrigem()">+ Habilidade de Origem</button>
    </div>

    <div class="card">
      <div class="section-header" style="display:flex; justify-content:space-between; align-items:center; background:#111;">
        <span style="flex-grow:1; text-align:center;">Invent√°rio</span>
        <button class="btn-icon-sm" onclick="abrirItemModal()" title="Adicionar Item">+</button>
      </div>
      <div class="load-bar-container"><div id="loadFill" class="load-fill"></div><div id="loadText" class="load-text">0 / 8 Espa√ßos</div></div>
      <div id="overburdenMsg" class="overburden-warning">‚ö† SOBRECARREGADO</div>
      <div id="inventoryGrid" class="inv-grid"></div>
    </div>
    
    <div class="card" id="aptidoesCard">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h3 class="section-header" style="width:100%; margin:0;">Aptid√µes & Evolu√ß√£o</h3>
        <div id="gmControlsMain" style="display:none; gap:5px;">
          <button class="btn-mini" style="width:auto; padding:0 8px; font-size:0.7rem; border-color:var(--apice); color:var(--apice);" onclick="gmUnlock('apice')">Unlock √Åpice</button>
          <button class="btn-mini" style="width:auto; padding:0 8px; font-size:0.7rem; border-color:var(--corpo); color:var(--corpo);" onclick="gmUnlock('corpo')">Unlock Corpo</button>
          <button class="btn-mini" style="width:auto; padding:0 8px; font-size:0.7rem; border-color:#0f0; color:#0f0;" onclick="gmClearDebuff()">Curar Sequelas</button>
          <button class="btn-mini" style="width:auto; padding:0 8px;" onclick="addNovaAptidao()">+</button>
        </div>
      </div>
      <div id="listaAptidoes"></div>
    </div>
  </div>

  <div class="col-right">
    <div class="card">
      <h3 class="section-header" style="margin-bottom:10px;">Valores Adicionais</h3>
      <div class="derived-grid">
        <div class="derived-box"><div class="derived-label">DEFESA</div><div class="derived-value" id="valDefesa">10</div><div class="derived-calc"><input id="bonusDef" class="bonus-input" placeholder="B√¥nus" onchange="setDerivadoBonus('defesa', this.value)"></div></div>
        <div class="derived-box"><div class="derived-label">ATEN√á√ÉO</div><div class="derived-value" id="valAtencao">10</div><div class="derived-calc"><input id="bonusAtencao" class="bonus-input" placeholder="B√¥nus" onchange="setDerivadoBonus('atencao', this.value)"></div></div>
        <div class="derived-box"><div class="derived-label">INICIATIVA</div><div class="derived-value" id="valIniciativa">+0</div><div class="derived-calc"><input id="bonusIniciativa" class="bonus-input" placeholder="B√¥nus" onchange="setDerivadoBonus('iniciativa', this.value)"></div></div>
        <div class="derived-box"><div class="derived-label">DESLOC.</div><div class="derived-value" id="valDesloc">9m</div><div class="derived-calc"><input id="bonusDesloc" class="bonus-input" placeholder="B√¥nus" onchange="setDerivadoBonus('deslocamento', this.value)"></div></div>
      </div>
    </div>

    <div class="card skills-card">
      <div class="skills-header" style="padding-top:0;">
        <h3 style="margin-bottom:5px;">Per√≠cias</h3>
        <span id="treinoDisplay" style="font-size:0.8rem; color:#aaa; display:block;"></span>
      </div>
      <div id="skillsList"></div>
    </div>
  </div>
</div>

<script type="module">
import { db, auth, doc, updateDoc, deleteDoc, onSnapshot } from "./firebase.js";
import { APTIDOES_BASE } from "./aptidoes_db.js";
import { HABILIDADES_CLASSE } from "./classes_db.js"; // IMPORTA O NOVO ARQUIVO

const params = new URLSearchParams(location.search);
const id = params.get("id");
window.id = id;
let ficha = {}; 
let editandoId = null;
let editingItemIndex = -1;
let editingAptIndex = -1;
const MESTRE_EMAIL = "grisskos@fake.com";
let isMestre = false;

// ... (Defini√ß√µes de Per√≠cias e Atributos mantidas) ...

auth.onAuthStateChanged(user => {
  if(user && user.email === MESTRE_EMAIL) {
    isMestre = true;
    document.getElementById('gmControlsMain').style.display = 'flex';
  }
});

onSnapshot(doc(db, "fichas", id), (docSnap) => {
  if (docSnap.exists()) { 
    ficha = docSnap.data();
    // Safety Checks
    if (!ficha.escolhasClasse) ficha.escolhasClasse = {}; // Salva o que o player escolheu nos dropdowns
    if (!ficha.habilidadesOrigem) ficha.habilidadesOrigem = [];
    
    if(!editandoId) renderFicha(); 
  }
});

function renderFicha() {
  // ... (Renderiza√ß√£o de Header, Atributos, Stats, Combate, Invent√°rio, Aptid√µes, Per√≠cias mantidas) ...
  
  renderHabilidadesClasse();
}

// === NOVA FUN√á√ÉO: RENDERIZAR HABILIDADES DE CLASSE ===
function renderHabilidadesClasse() {
  const container = document.getElementById('classAbilitiesList');
  container.innerHTML = "";
  
  const classe = ficha.classe;
  const nivel = Number(ficha.nivel || 1);
  
  if (!HABILIDADES_CLASSE[classe]) return; // Se classe n√£o tiver no DB, n√£o faz nada

  HABILIDADES_CLASSE[classe].forEach((hab, idx) => {
    if (hab.nivel > nivel) return; // S√≥ mostra se tiver n√≠vel

    let content = "";
    
    if (hab.tipo === "escolha") {
      // √â um dropdown
      const savedChoice = (ficha.escolhasClasse || {})[idx] || "";
      const options = hab.opcoes.map(op => `<option value="${op}" ${op===savedChoice?'selected':''}>${op}</option>`).join('');
      
      content = `
        <div class="class-ability-box">
          <div class="class-ability-name">${hab.nome}</div>
          <select class="class-select" onchange="salvarEscolhaClasse(${idx}, this.value)">
            <option value="">-- Escolha uma op√ß√£o --</option>
            ${options}
          </select>
        </div>`;
    } else {
      // √â texto fixo
      content = `
        <div class="class-ability-box">
          <div class="class-ability-name">${hab.nome}</div>
          <div class="class-ability-desc">${hab.desc}</div>
        </div>`;
    }
    
    container.innerHTML += content;
  });

  // Renderizar Origem (Manual)
  const originContainer = document.getElementById('originAbilitiesList');
  originContainer.innerHTML = "";
  (ficha.habilidadesOrigem || []).forEach((h, i) => {
    originContainer.innerHTML += `
      <div class="class-ability-box" style="border-color:var(--vigor);">
        <div style="display:flex; justify-content:space-between;">
          <div class="class-ability-name" style="cursor:pointer;" onclick="editarOrigem(${i})">${h.nome}</div>
          <button class="btn-del-item" onclick="excluirOrigem(${i})">√ó</button>
        </div>
        <div class="class-ability-desc">${h.desc}</div>
      </div>`;
  });
}

window.salvarEscolhaClasse = async (index, valor) => {
  const escolhas = ficha.escolhasClasse || {};
  escolhas[index] = valor;
  await updateDoc(doc(db, "fichas", id), { escolhasClasse: escolhas });
};

window.addOrigem = async () => {
  const nome = prompt("Nome da Habilidade de Origem:");
  if(!nome) return;
  const desc = prompt("Descri√ß√£o:");
  
  const nova = { nome, desc };
  const lista = ficha.habilidadesOrigem || [];
  lista.push(nova);
  
  await updateDoc(doc(db, "fichas", id), { habilidadesOrigem: lista });
};

window.excluirOrigem = async (index) => {
  if(!confirm("Excluir?")) return;
  ficha.habilidadesOrigem.splice(index, 1);
  await updateDoc(doc(db, "fichas", id), { habilidadesOrigem: ficha.habilidadesOrigem });
};

window.editarOrigem = async (index) => {
  const h = ficha.habilidadesOrigem[index];
  const novoNome = prompt("Nome:", h.nome);
  const novaDesc = prompt("Descri√ß√£o:", h.desc);
  if(novoNome && novaDesc) {
    ficha.habilidadesOrigem[index] = { nome: novoNome, desc: novaDesc };
    await updateDoc(doc(db, "fichas", id), { habilidadesOrigem: ficha.habilidadesOrigem });
  }
};

// ... (Resto das fun√ß√µes mantidas) ...

</script>
</body>
</html>
